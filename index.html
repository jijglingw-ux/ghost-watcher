<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLUVO | ä»·å€¼è”ç›Ÿ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ================= è§†è§‰ç³»ç»Ÿ (çº¯å‡€å•†ä¸šç‰ˆ) ================= */
        :root {
            --bg-deep: #050505;
            --card-bg: #111;
            --text-main: #fff;
            --text-sub: #888;
            --accent: #00f2ff; /* PLUVO èµ›åšé’ */
            --danger: #ff453a;
            --success: #32d74b;
            --gold: #FFD700;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; background-color: var(--bg-deep); color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            height: 100vh; display: flex; justify-content: center; overflow: hidden;
        }

        .app-container {
            width: 100%; max-width: 430px; height: 100%;
            position: relative; background: var(--bg-deep);
            display: flex; flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* --- ç™»å½•é¡µæ ·å¼ --- */
        .auth-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-deep); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; padding: 40px;
            transition: opacity 0.3s;
        }
        .auth-view.hidden { opacity: 0; pointer-events: none; z-index: -1; }

        .logo-area { margin-bottom: 60px; text-align: left; }
        .logo-title { font-size: 3rem; font-weight: 800; letter-spacing: -1px; margin: 0; }
        .logo-sub { color: var(--accent); font-size: 14px; letter-spacing: 2px; text-transform: uppercase; margin-top: 10px; }

        .clean-input {
            width: 100%; background: transparent; border: none;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding: 15px 0; color: #fff; font-size: 1.1rem; margin-bottom: 20px; outline: none;
        }
        .clean-input:focus { border-bottom-color: var(--accent); }

        .btn-primary {
            width: 100%; padding: 16px; background: #fff; border: none; border-radius: 4px;
            color: #000; font-weight: bold; font-size: 1rem; margin-top: 20px; cursor: pointer;
        }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
        
        .auth-links { margin-top: 20px; display: flex; justify-content: space-between; font-size: 0.9rem; color: #666; }

        /* --- ä¸»ç•Œé¢æ ·å¼ --- */
        .main-view {
            flex: 1; display: none; flex-direction: column; position: relative;
        }
        .main-view.active { display: flex; }

        /* é¡¶éƒ¨æ  */
        .top-bar { padding: 50px 20px 20px; font-size: 1.5rem; font-weight: bold; background: linear-gradient(180deg, #000 0%, transparent 100%); }

        /* æ ‡ç­¾é¡µå®¹å™¨ */
        .tab-content { flex: 1; position: relative; overflow: hidden; }
        .tab-pane { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; flex-direction: column; overflow-y: auto; padding: 20px; 
            padding-bottom: 100px; /* é¿å¼€åº•éƒ¨å¯¼èˆª */
        }
        .tab-pane.active { display: flex; }

        /* TAB 1: æ‰«ç æŒ–çŸ¿ */
        .scanner-box {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .scan-trigger {
            width: 200px; height: 200px; border-radius: 20px;
            border: 2px dashed var(--accent);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 242, 255, 0.05); color: var(--accent);
            cursor: pointer; transition: all 0.3s;
        }
        .scan-trigger:active { background: rgba(0, 242, 255, 0.2); transform: scale(0.95); }
        .scan-anim { width: 100%; height: 2px; background: var(--accent); position: absolute; top: 0; animation: scan 2s infinite; }
        @keyframes scan { 0% {top:10%; opacity:0;} 50% {opacity:1;} 100% {top:90%; opacity:0;} }

        /* TAB 2: èµ„äº§æŒæœ‰ */
        .asset-card {
            background: var(--card-bg); border: 1px solid #222; border-radius: 16px; padding: 30px;
            text-align: center; margin-bottom: 20px;
        }
        .balance-label { color: #888; font-size: 0.9rem; margin-bottom: 10px; }
        .balance-num { font-size: 3rem; font-weight: 800; color: var(--gold); font-family: "DIN Alternate", sans-serif; }
        .balance-unit { font-size: 1rem; color: #666; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .action-btn {
            background: #1a1a1a; border: 1px solid #333; padding: 20px; border-radius: 12px;
            color: #fff; text-align: center; cursor: pointer;
        }
        .action-btn:active { background: #333; }

        /* TAB 3: äº¤æ˜“è®°å½• */
        .record-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid #222;
        }
        .rec-meta { display: flex; flex-direction: column; }
        .rec-name { font-size: 1rem; margin-bottom: 4px; }
        .rec-date { font-size: 0.8rem; color: #666; }
        .rec-amount { font-weight: bold; font-family: "DIN Alternate"; }
        .rec-mint { color: var(--success); }
        .rec-burn { color: var(--danger); }

        /* åº•éƒ¨å¯¼èˆª */
        .bottom-nav {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 80px;
            background: rgba(10,10,10,0.95); border-top: 1px solid #222;
            display: flex; justify-content: space-around; align-items: center;
            backdrop-filter: blur(10px); z-index: 50;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #555; font-size: 10px; gap: 4px; }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 24px; }

        /* æ ¸é”€å¼¹çª— */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        #qrcode { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="app-container">
    
    <div id="auth-view" class="auth-view">
        <div class="logo-area">
            <h1 class="logo-title">PLUVO</h1>
            <div class="logo-sub">æ•°å­—æƒç›Š Â· ä»·å€¼ç½‘ç»œ</div>
        </div>
        
        <input type="email" id="email" class="clean-input" placeholder="è´¦å· (Email)">
        <input type="password" id="password" class="clean-input" placeholder="å¯†ç ">
        
        <button class="btn-primary" onclick="handleLogin()">ç™» å½•</button>
        
        <div class="auth-links">
            <span onclick="handleRegister()">æ³¨å†Œæ–°è´¦å·</span>
            <span>å¿˜è®°å¯†ç ?</span>
        </div>
    </div>

    <div id="main-view" class="main-view">
        
        <div id="tab-scan" class="tab-pane active">
            <div class="top-bar">æ‰«ææ¢æµ‹</div>
            <div class="scanner-box">
                <div class="scan-trigger" onclick="simulateScan()">
                    <div style="font-size:3rem; margin-bottom:10px;">ğŸ“·</div>
                    <div style="font-size:0.9rem;">ç‚¹å‡»æ‰«æå•†å®¶ç </div>
                    <div class="scan-anim"></div>
                </div>
                <div style="margin-top:30px; text-align:center; color:#666; font-size:0.8rem; line-height:1.6;">
                    å¯¹å‡† PLUVO è”ç›Ÿå•†æˆ·æ”¶æ¬¾ç <br>æ¶ˆè´¹å³æŒ–çŸ¿ Â· è‡ªåŠ¨è®¡ç®—è´¡çŒ®å€¼
                </div>
            </div>
        </div>

        <div id="tab-assets" class="tab-pane">
            <div class="top-bar">æˆ‘çš„èµ„äº§</div>
            
            <div class="asset-card">
                <div class="balance-label">å½“å‰æŒæœ‰å‡­è¯ (CP)</div>
                <div class="balance-num" id="balance-display">0.00</div>
                <div class="balance-unit">PLUVO Genesis Token</div>
            </div>

            <div class="action-grid">
                <div class="action-btn" onclick="openBurnModal()">
                    <div style="font-size:1.5rem; margin-bottom:5px;">âš¡</div>
                    <div>å‡ºç¤ºæ ¸é”€ç </div>
                </div>
                <div class="action-btn" onclick="loadRecords()">
                    <div style="font-size:1.5rem; margin-bottom:5px;">ğŸ”„</div>
                    <div>åˆ·æ–°ä½™é¢</div>
                </div>
            </div>

            <div style="margin-top:30px; padding:20px; background:#111; border-radius:12px;">
                <div style="font-size:0.9rem; font-weight:bold; margin-bottom:10px;">å½“å‰æƒç›Šæ±‡ç‡</div>
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#888; margin-bottom:8px;">
                    <span>10.0 CP</span>
                    <span>= å…å•ä¸€ä»½ç‰›è‚‰é¢</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#888;">
                    <span>0.5 CP</span>
                    <span>= å…‘æ¢å¤è›‹ä¸€æš</span>
                </div>
            </div>
            
            <button onclick="logout()" style="margin-top:30px; background:none; border:none; color:#444; width:100%;">å®‰å…¨é€€å‡º</button>
        </div>

        <div id="tab-records" class="tab-pane">
            <div class="top-bar">è´¦æœ¬è®°å½•</div>
            <div id="record-list">
                <div style="text-align:center; color:#666; margin-top:50px;">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('scan', this)">
                <div class="nav-icon">ğŸ‘ï¸</div>
                <div>æ‰«ç </div>
            </div>
            <div class="nav-item" onclick="switchTab('assets', this)">
                <div class="nav-icon">ğŸ’¼</div>
                <div>æŒæœ‰</div>
            </div>
            <div class="nav-item" onclick="switchTab('records', this)">
                <div class="nav-icon">ğŸ“</div>
                <div>è®°å½•</div>
            </div>
        </div>
    </div>

    <div id="burn-modal" class="modal" onclick="this.style.display='none'">
        <div id="qrcode"></div>
        <div style="margin-top:20px; color:#fff; font-size:1.2rem; font-weight:bold;">å‘å•†å®¶å‡ºç¤ºæ­¤ç </div>
        <div style="color:#888; font-size:0.9rem; margin-top:10px;">ç‚¹å‡»ä»»æ„å¤„å…³é—­</div>
    </div>

</div>

<script>
    // ================= é…ç½®åŒº =================
    // âš ï¸ è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ Supabase URL å’Œ Key
    const DB_URL = 'https://uudlauufdnrdcztlesvr.supabase.co';
    const DB_KEY = 'sb_publishable_KtfqCfLqUd_AtLj0Nb2WKQ_aPbsHjus';
    
    const client = window.supabase.createClient(DB_URL, DB_KEY);
    let currentUser = null;

    // ================= è®¤è¯é€»è¾‘ =================
    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if(!email || !password) return Swal.fire({text:'è¯·è¾“å…¥è´¦å·å¯†ç ', icon:'warning', background:'#000', color:'#fff'});

        Swal.showLoading();
        const { data, error } = await client.auth.signInWithPassword({ email, password });
        if(error) return Swal.fire({text: error.message, icon:'error', background:'#000', color:'#fff'});

        currentUser = data.user;
        enterApp();
    }

    async function handleRegister() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if(!email || password.length < 6) return Swal.fire({text:'å¯†ç éœ€å¤§äº6ä½', icon:'warning', background:'#000', color:'#fff'});

        Swal.showLoading();
        const { data, error } = await client.auth.signUp({ email, password });
        if(error) return Swal.fire({text: error.message, icon:'error', background:'#000', color:'#fff'});
        
        Swal.fire({title:'æ³¨å†ŒæˆåŠŸ', text:'è¯·ç™»å½•', icon:'success', background:'#000', color:'#fff'});
    }

    async function logout() {
        await client.auth.signOut();
        location.reload();
    }

    function enterApp() {
        document.getElementById('auth-view').classList.add('hidden');
        document.getElementById('main-view').classList.add('active');
        loadBalance();
        loadRecords();
    }

    // ================= ä¸šåŠ¡é€»è¾‘ï¼šæ‰«ç æŒ–çŸ¿ (Mint) =================
    // å¯¹åº”æ–‡æ¡£ï¼šç¬¬ä¸€é˜¶æ®µâ€œå‚»ç“œæ¨¡å¼â€ 
    // é€»è¾‘ï¼šè¾“å…¥æ¶ˆè´¹é‡‘é¢ -> æŒ‰ç³»æ•° 0.4 è®¡ç®—è´¡çŒ® -> 1:1 é“¸é€ å‡­è¯ (ç®€åŒ–ç‰ˆå…¬å¼)
    async function simulateScan() {
        const { value: amount } = await Swal.fire({
            title: 'æ¨¡æ‹Ÿæ‰«ç æˆåŠŸ',
            text: 'è¯·è¾“å…¥æœ¬æ¬¡æ¶ˆè´¹é‡‘é¢ (CNY)',
            input: 'number',
            background: '#000', color: '#fff',
            confirmButtonColor: '#00f2ff',
            showCancelButton: true
        });

        if (amount) {
            // æ ¸å¿ƒç®—æ³•ï¼šå‚»ç“œæ¨¡å¼ç³»æ•° 0.4
            const contribution = (amount * 0.4).toFixed(2); 
            // ç®€åŒ–æ¨¡å‹ï¼šè´¡çŒ®å€¼ 1:1 è½¬åŒ–ä¸ºå‡­è¯ (å¤æ‚æ¨¡å‹éœ€è°ƒç”¨åç«¯)
            const tokenAmount = contribution; 

            // å†™å…¥æ•°æ®åº“ (Mint)
            const { error } = await client.from('transactions').insert({
                user_id: currentUser.id,
                type: 'mint',
                amount: tokenAmount,
                cash_value: amount,
                merchant_name: 'æ¨¡æ‹Ÿå•†å®¶-' + Math.floor(Math.random()*100)
            });

            if(error) {
                Swal.fire({text: 'ä¸Šé“¾å¤±è´¥: '+error.message, icon:'error', background:'#000', color:'#fff'});
            } else {
                Swal.fire({
                    title: 'æŒ–çŸ¿æˆåŠŸ!',
                    html: `æ¶ˆè´¹: Â¥${amount}<br>è´¡çŒ®: Â¥${contribution}<br><b style="color:#00f2ff; font-size:1.5rem;">+${tokenAmount} CP</b>`,
                    icon: 'success',
                    background: '#000', color: '#fff'
                });
                loadBalance();
                loadRecords();
            }
        }
    }

    // ================= ä¸šåŠ¡é€»è¾‘ï¼šèµ„äº§æ ¸é”€ (Burn) =================
    function openBurnModal() {
        document.getElementById('burn-modal').style.display = 'flex';
        document.getElementById('qrcode').innerHTML = "";
        
        // ç”ŸæˆäºŒç»´ç  (åŒ…å«ç”¨æˆ·IDå’Œæ—¶é—´æˆ³)
        new QRCode(document.getElementById("qrcode"), {
            text: JSON.stringify({uid: currentUser.id, ts: Date.now()}),
            width: 200, height: 200
        });

        // æ¨¡æ‹Ÿå•†å®¶æ‰«ç æ‰£æ¬¾ (ä»…æ¼”ç¤ºç”¨ï¼Œ3ç§’åè‡ªåŠ¨æ‰£é™¤)
        setTimeout(() => {
            simulateMerchantScan();
        }, 3000);
    }

    async function simulateMerchantScan() {
        // æ¨¡æ‹Ÿå•†å®¶åœ¨ POS æœºä¸Šæ‰£é™¤äº† 5 ä¸ªå¸æ¢èŒ¶å¶è›‹
        const burnAmount = 5.00; 

        document.getElementById('burn-modal').style.display = 'none';
        
        const { error } = await client.from('transactions').insert({
            user_id: currentUser.id,
            type: 'burn',
            amount: -burnAmount, // è´Ÿæ•°ä»£è¡¨æ‰£é™¤
            merchant_name: 'PLUVO æ ¸é”€ä¸­å¿ƒ',
            cash_value: 0
        });

        if(!error) {
            Swal.fire({
                title: 'æ ¸é”€æˆåŠŸ',
                text: `å·²æ‰£é™¤ ${burnAmount} CP`,
                icon: 'success', background: '#000', color: '#fff', timer: 1500, showConfirmButton: false
            });
            loadBalance();
            loadRecords();
        }
    }

    // ================= æ•°æ®åŠ è½½ =================
    async function loadBalance() {
        const { data } = await client.from('transactions').select('amount').eq('user_id', currentUser.id);
        if(data) {
            // è®¡ç®—æ€»å’Œ
            const total = data.reduce((acc, curr) => acc + parseFloat(curr.amount), 0);
            document.getElementById('balance-display').innerText = total.toFixed(2);
        }
    }

    async function loadRecords() {
        const { data } = await client.from('transactions')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
            
        const container = document.getElementById('record-list');
        container.innerHTML = "";

        if(data && data.length > 0) {
            data.forEach(tx => {
                const isMint = tx.type === 'mint';
                const sign = isMint ? '+' : '';
                const colorClass = isMint ? 'rec-mint' : 'rec-burn';
                const date = new Date(tx.created_at).toLocaleString();
                
                const html = `
                    <div class="record-item">
                        <div class="rec-meta">
                            <div class="rec-name">${tx.merchant_name || 'ç³»ç»Ÿ'}</div>
                            <div class="rec-date">${date}</div>
                        </div>
                        <div class="rec-amount ${colorClass}">${sign}${tx.amount}</div>
                    </div>
                `;
                container.innerHTML += html;
            });
        } else {
            container.innerHTML = '<div style="text-align:center; color:#444; margin-top:50px;">æš‚æ— è®°å½•</div>';
        }
    }

    // ================= UI åˆ‡æ¢ =================
    function switchTab(tabId, btn) {
        // éšè—æ‰€æœ‰ Tab
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        // æ˜¾ç¤ºå½“å‰ Tab
        document.getElementById('tab-' + tabId).classList.add('active');
        btn.classList.add('active');
        
        // åˆ·æ–°æ•°æ®
        if(tabId === 'assets') loadBalance();
        if(tabId === 'records') loadRecords();
    }
</script>
</body>
</html>
