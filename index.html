<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡¤å‡°åè®® V9.6 | å¼ºåŒ–é˜²å¾¡ç‰ˆ</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.3/sweetalert2.all.min.js" integrity="sha512-/iBgV43zicCNqv8pHXbO31O9GkMPbZ+33K3DkhVZb/GAycWdDCA3C7TzwMcT1oxY/QG9TCQ323JcM2E8cO85hQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" integrity="sha512-E8QSvWZ0eCLGk4km3qxSsNmZZqvFxJNCGd+FA2ckY5B+uGv9CK+G28nLqCNzCFu4sy7D6xsF9FzFE/09pGMPUQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.1/jsencrypt.min.js" integrity="sha512-bfvYq5NesZtLgT1oJ3RSfT8F8s1q6XUUX1n+TykY39T8Qv2M2X3nPbAF2Wd2X+qT9+gK4+vjV45D/CSTtTQLHg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js" integrity="sha512-CryKbMe7sjSCDPl18jtJI5DR5jtkUWxPXWaLCst6QjH8wxDexfRJic2WRmRXmstr2Y8SxDDWuBO6CQC6IE4KTA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        :root { 
            --c-green: #00ff41; 
            --c-red: #ff3333; 
            --c-yellow: #ffcc00; 
            --c-bg: #0d1117; 
            --c-panel: rgba(22, 27, 34, 0.95);
            --c-border: #30363d;
        }
        * { box-sizing: border-box; }
        body { background: #000; color: var(--c-green); font-family: 'Courier New', monospace; margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000 100%); padding: 20px; user-select: none; }
        
        .container { width: 100%; max-width: 900px; border: 1px solid var(--c-border); background: var(--c-panel); box-shadow: 0 0 30px rgba(0,255,65,0.05); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        
        .header { background: rgba(255,255,255,0.02); padding: 15px 20px; border-bottom: 1px solid var(--c-border); display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 1.2rem; font-weight: bold; letter-spacing: 2px; }
        .status-dot { width: 8px; height: 8px; background: var(--c-green); border-radius: 50%; box-shadow: 0 0 8px var(--c-green); }

        .panel { padding: 20px; border-bottom: 1px solid var(--c-border); }
        .panel-title { color: #fff; font-size: 0.9rem; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .secret-zone { background: rgba(0, 255, 65, 0.02); }

        /* å¸ƒå±€ */
        .monitor-row { display: flex; border-bottom: 1px solid var(--c-border); flex-direction: column; }
        @media(min-width: 768px) { .monitor-row { flex-direction: row; } }
        .visual-col { flex: 1; padding: 20px 40px; border-right: 1px solid var(--c-border); border-bottom: 1px solid var(--c-border); position: relative; }
        @media(min-width: 768px) { .visual-col { border-bottom: none; } }
        .heartbeat-col { width: 100%; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.2); }
        @media(min-width: 768px) { .heartbeat-col { width: 280px; } }
        .config-grid { display: grid; grid-template-columns: 1fr; }
        @media(min-width: 768px) { .config-grid { grid-template-columns: 1fr 1fr; } }
        .config-panel { padding: 20px; }
        .config-panel:first-child { border-right: 1px solid var(--c-border); }

        .input-group { display: flex; margin-bottom: 12px; border: 1px solid var(--c-border); border-radius: 4px; overflow: hidden; transition: border-color 0.3s; background: #000; }
        .input-group:focus-within { border-color: var(--c-green); }
        .input-label { background: rgba(255,255,255,0.05); padding: 10px; color: #888; font-size: 0.8rem; min-width: 80px; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--c-border); }
        input, select, textarea { flex: 1; background: transparent; border: none; color: var(--c-green); padding: 10px; outline: none; font-family: inherit; width: 100%; }
        select { cursor: pointer; border-left: 1px solid var(--c-border); max-width: 80px; text-align: center; }
        
        button { padding: 15px; background: transparent; border: 1px solid var(--c-green); color: var(--c-green); cursor: pointer; text-transform: uppercase; font-weight: bold; transition: 0.2s; width: 100%; border-radius: 4px; }
        button:hover { background: var(--c-green); color: #000; box-shadow: 0 0 15px rgba(0,255,65,0.4); }
        button:disabled { border-color: #555; color: #555; cursor: not-allowed; background: transparent !important; box-shadow: none !important; }
        
        .live-timer { font-size: 2rem; font-weight: bold; color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.1); margin: 15px 0; letter-spacing: 2px; }
        .alive-btn { border-color: var(--c-yellow); color: var(--c-yellow); width: 100%; padding: 20px; font-size: 1.1rem; }
        .alive-btn:hover { background: var(--c-yellow); color: #000; box-shadow: 0 0 20px rgba(255, 204, 0, 0.4); }

        /* æ—¶é—´è½´ */
        .visualizer { position: relative; min-height: 180px; display: flex; flex-direction: column; justify-content: center; }
        .visualizer.empty { color: #555; align-items: center; text-align: center; }
        .timeline-container { position: relative; height: 2px; background: #333; margin: 40px 0; width: 100%; }
        .range-warn { position: absolute; height: 4px; top: -1px; left: 0; background: repeating-linear-gradient(45deg, var(--c-yellow), var(--c-yellow) 5px, #333 5px, #333 10px); z-index: 1; border-right: 2px solid var(--c-red); }
        .range-safe { position: absolute; height: 2px; top: 0; right: 0; background: var(--c-green); box-shadow: 0 0 5px var(--c-green); z-index: 0; }
        .tick { position: absolute; transform: translateX(-50%); width: 2px; z-index: 2; transition: left 0.3s; }
        .tick.bottom { top: 0; height: 15px; }
        .tick.bottom .tick-label { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); text-align: center; font-size: 10px; white-space: nowrap; }
        .tick.bottom.death { background: var(--c-red); height: 20px; z-index: 10; }
        .tick.bottom.death .tick-label { color: var(--c-red); font-weight: bold; }
        .tick.bottom.start { background: var(--c-green); z-index: 10; }
        .tick.bottom.start .tick-label { color: var(--c-green); }
        .tick.top { bottom: 0; height: 15px; }
        .tick.top .tick-label { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; font-size: 10px; white-space: nowrap; }
        .tick.top.warn { background: var(--c-yellow); z-index: 5; }
        .tick.top.warn .tick-label { color: var(--c-yellow); }
        .tick.top.minor { height: 6px; width: 1px; background: rgba(255,204,0,0.5); } 
        .tick-val { display: block; font-weight: bold; margin-bottom: 2px; font-size: 12px; }
        .legend { display: flex; gap: 20px; font-size: 10px; color: #666; justify-content: center; margin-top: auto; }
        .dot { width: 8px; height: 8px; border-radius: 2px; display: inline-block; margin-right: 5px; }
        .error-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--c-red); z-index: 20; text-align: center; display: none; }
        .has-error .error-overlay { display: flex; }

        .hidden { display: none !important; }
        #manual-section, #login-section { max-width: 400px; margin: 50px auto; padding: 0 20px; }

        /* V9.6 è§£å¯†åŒº */
        #decrypt-view { text-align: left; position: relative; }
        #decrypt-result { 
            color: var(--c-green); 
            font-size: 1.1rem; 
            padding: 30px; 
            border: 1px dashed var(--c-green); 
            background: rgba(0,0,0,0.8); 
            min-height: 150px; 
            white-space: pre-wrap; 
            word-break: break-all;
            margin-top: 15px;
            border-radius: 4px;
            user-select: text;
            transition: filter 0.2s;
        }
        
        .privacy-blur { filter: blur(15px); pointer-events: none; user-select: none; }
        .burn-timer { height: 2px; background: var(--c-red); width: 100%; margin-top: 10px; transition: width 1s linear, background-color 0.3s; }
        .security-badge { 
            display: inline-flex; align-items: center; gap: 5px; 
            padding: 5px 10px; border: 1px solid #333; border-radius: 20px; 
            font-size: 10px; color: #666; margin-bottom: 10px;
        }
        .security-badge.secure { border-color: var(--c-green); color: var(--c-green); }
    </style>
</head>
<body>

    <div class="container" id="auth-container">
        <div class="header">
            <div class="brand">å‡¤å‡°åè®® V9.6</div>
            <div class="status-dot" style="background:#555"></div>
        </div>
        
        <div id="login-section">
            <div style="text-align:center; margin:30px 0; color:#888;">èº«ä»½éªŒè¯</div>
            <div class="input-group"><div class="input-label">è´¦å·</div><input type="email" id="email" placeholder="è¾“å…¥é‚®ç®±"></div>
            <div class="input-group"><div class="input-label">å¯†ç </div><input type="password" id="password" placeholder="è¾“å…¥å¯†ç "></div>
            <button onclick="handleAuth('login', this)" style="margin-top:10px;">ç™»å½•æ§åˆ¶å°</button>
            <button onclick="handleAuth('signup', this)" style="margin-top:10px; border-color:#555; color:#888;">æ³¨å†Œæ–°èº«ä»½</button>
            <p style="text-align:center; font-size:12px; color:#666; cursor:pointer; margin-top:20px; text-decoration:underline;" onclick="toggleView('manual')">æˆ‘æ˜¯å—ç›Šäºº (æ‰‹åŠ¨æå–)</p>
        </div>

        <div id="manual-section" class="hidden">
            <div style="text-align:center; margin:30px 0; color:var(--c-green);">èµ„äº§æå–é€šé“</div>
            <div class="input-group"><div class="input-label">ID</div><input type="text" id="manual-id" placeholder="è¾“å…¥ä¿é™©ç®± ID"></div>
            <div class="input-group"><div class="input-label">KEY</div><input type="text" id="manual-key" placeholder="è¾“å…¥æå–å¯†é’¥"></div>
            
            <div style="margin: 15px 0; padding: 10px; background: rgba(255, 204, 0, 0.1); border-left: 3px solid var(--c-yellow); font-size: 12px; color: #ccc; text-align: left;">
                <strong style="color:var(--c-yellow)">ğŸ›¡ï¸ é›¶ä¿¡ä»»å®‰å…¨å»ºè®®ï¼š</strong><br>
                ç³»ç»Ÿå·²ä½¿ç”¨ SRI æ ¡éªŒã€‚ä¸ºäº†é˜²æ­¢æœ¨é©¬çªƒå–ï¼Œæ‚¨å¯ä»¥<strong>å…ˆæ‹”æ‰ç½‘çº¿</strong>ï¼Œå†ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è§£å¯†ã€‚
            </div>

            <button onclick="handleManualDecrypt(this)">éªŒè¯å¹¶è§£å¯†</button>
            <p style="text-align:center; margin-top:20px; font-size:12px; cursor:pointer;" onclick="toggleView('login')">&lt; è¿”å›ç™»å½•</p>
        </div>
        
        <div id="decrypt-view" class="hidden" style="padding:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="security-badge secure">ğŸ”’ æœ¬åœ°å†…å­˜è§£å¯† (RAM)</div>
                <div class="security-badge" id="net-status">æ£€æµ‹ç½‘ç»œçŠ¶æ€...</div>
            </div>
            
            <div style="color:#666; text-align:center; margin-bottom:5px; font-size:12px;">æ— æ“ä½œ 60ç§’ åè‡ªåŠ¨é”€æ¯</div>
            <div class="burn-timer" id="burn-bar" style="width:100%"></div>
            
            <div id="decrypt-result"></div>
            <div id="blur-warning" style="display:none; text-align:center; color:#666; margin-top:10px;">( ä¸ºäº†å®‰å…¨ï¼Œçª—å£å¤±ç„¦æ—¶è‡ªåŠ¨æ¨¡ç³Š )</div>
            
            <button onclick="location.reload()" style="margin-top:20px; border-color:#555; color:#888;">ç«‹å³é”€æ¯ / é€€å‡º</button>
        </div>
    </div>

    <div class="container hidden" id="dash-container">
        <div class="header"><div class="brand">æˆ˜ç•¥æ§åˆ¶å°</div><div class="status-dot"></div></div>
        <div class="panel secret-zone"><div class="panel-title">1. ç»å¯†ä¿¡å° <span style="font-size:0.7em; color:#666; margin-left:auto;">(æ ¸å¿ƒèµ„äº§)</span></div><div class="input-group"><div class="input-label">é—è¨€å†…å®¹</div><input type="text" id="secret" placeholder="åœ¨æ­¤è¾“å…¥éœ€è¦åŠ å¯†ç•™å­˜çš„ä¿¡æ¯..."></div><div class="input-group"><div class="input-label">å—ç›Šäºº</div><input type="email" id="ben" placeholder="æ¥æ”¶é‚®ç®± (name@example.com)"></div></div>
        <div class="monitor-row"><div class="visual-col" id="visual-wrapper"><div class="panel-title">2. ç­–ç•¥æ¨æ¼” <span style="font-size:0.7em; color:#666; margin-left:auto;">(Visualizer)</span></div><div class="error-overlay" id="visual-error"></div><div id="visual-content" class="visualizer empty">ç­‰å¾…å‚æ•°è¾“å…¥...</div></div><div class="heartbeat-col"><div style="font-size:0.7rem; color:#888; text-transform:uppercase; letter-spacing:1px;">ç³»ç»ŸçŠ¶æ€</div><div class="live-timer" id="live-countdown">--:--:--</div><button class="alive-btn" onclick="sendHeartbeat()">â¤ï¸ ç­¾åˆ° / é‡ç½®</button></div></div>
        <div class="config-grid"><div class="config-panel"><div class="panel-title">3. è§¦å‘è®¾å®š <span style="font-size:0.7em; color:#666; margin-left:auto;">(æ»¡è¡€å‘¨æœŸ)</span></div><div class="input-group"><div class="input-label">æ€»æ—¶é•¿</div><input type="number" id="timeout-val" placeholder="10" min="1" oninput="renderVisual()"><select id="timeout-unit" onchange="renderVisual()"><option value="60" selected>åˆ†</option><option value="3600">æ—¶</option><option value="86400">å¤©</option><option value="2592000">æœˆ</option><option value="31536000">å¹´</option></select></div></div><div class="config-panel"><div class="panel-title">4. å”¤é†’ç­–ç•¥ <span style="font-size:0.7em; color:#666; margin-left:auto;">(é¢„è­¦é¢‘æ¬¡)</span></div><div class="input-group"><div class="input-label">å”¤é†’æ¬¡æ•°</div><input type="number" id="warn-count" placeholder="1" min="1" oninput="renderVisual()"></div><div class="input-group"><div class="input-label">å€’æ•°é—´éš”</div><input type="number" id="warn-int-val" placeholder="6" min="1" oninput="renderVisual()"><select id="warn-int-unit" onchange="renderVisual()"><option value="60" selected>åˆ†</option><option value="3600">æ—¶</option><option value="86400">å¤©</option></select></div></div></div>
        <button onclick="deploy(this)" id="deploy-btn" style="border-radius:0; padding:20px; border:none; border-top:1px solid var(--c-green); background:rgba(0,255,65,0.05);" disabled>ğŸš€ åŒæ­¥é…ç½®åˆ°äº‘ç«¯</button>
    </div>

<script>
    // é…ç½®åŒºï¼šè¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ Supabase åœ°å€å’Œ Key
    const DB_URL = 'https://uudlauufdnrdcztlesvr.supabase.co'; 
    const DB_KEY = 'sb_publishable_KtfqCfLqUd_AtLj0Nb2WKQ_aPbsHjus'; 
    
    // Watchdog å…¬é’¥
    const WATCHDOG_PUBLIC_KEY = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAviA23JxW181JM9cbwClQ
x7+KP+rmhFJ2RF30z1OAjvWngczIYYRT4EGjx74OLqP3leYXME+4ZKZIqt6v8jf1
trELXELa5khEOwWHj2EbOnhPdbk7aJ3Du/RmkZAu/gSVKHiWAeVPdmZuEDRP8wV1
gIYQsnXW+gNTt0SPKdheSkWTiksSImiJlzV3HC9AS/ucx/GfAhxnLLQ67ZhRE+Ub
ytBiBV+RfQX9P0oWbsESOD+FtiJfvKO74jA9naWsmG7hMmhotH1O1oC3YWFYvpNi
RYytkgByTOHBmtFqUVa1jIAJGdAZ8g1jMhZOOte5NfjJ4fJQhmqzdHBlH2xU/14A
pQIDAQAB
-----END PUBLIC KEY-----`;

    let client;
    try {
        if (!window.supabase) throw new Error("Supabase åº“æœªåŠ è½½");
        client = window.supabase.createClient(DB_URL, DB_KEY);
    } catch (e) { alert("ç½‘ç»œåˆå§‹åŒ–å¤±è´¥: " + e.message); }

    let currentUserData = null;
    let timerInterval = null;
    let isConfigValid = false;
    
    // --- V9.5 æ™ºèƒ½æ´»è·ƒæ£€æµ‹ ---
    const IDLE_LIMIT = 60; // 60ç§’æ— æ“ä½œé”€æ¯
    let idleTimeLeft = IDLE_LIMIT;
    let idleInterval = null;

    function resetIdleTimer() {
        if (idleTimeLeft < IDLE_LIMIT) {
            idleTimeLeft = IDLE_LIMIT;
            const bar = document.getElementById('burn-bar');
            if(bar) {
                bar.style.width = "100%";
                bar.style.backgroundColor = "var(--c-green)";
                setTimeout(() => bar.style.backgroundColor = "var(--c-red)", 300);
            }
        }
    }

    window.addEventListener('blur', () => {
        const result = document.getElementById('decrypt-result');
        if (result && result.innerText) {
            result.classList.add('privacy-blur');
            document.getElementById('blur-warning').style.display = 'block';
        }
    });
    
    window.addEventListener('focus', () => {
        const result = document.getElementById('decrypt-result');
        if (result) {
            result.classList.remove('privacy-blur');
            document.getElementById('blur-warning').style.display = 'none';
        }
    });

    function checkNetStatus() {
        const el = document.getElementById('net-status');
        if (!navigator.onLine) {
            el.innerHTML = "ğŸ›¡ï¸ ç‰©ç†æ–­ç½‘ (æåº¦å®‰å…¨)";
            el.style.borderColor = "var(--c-green)";
            el.style.color = "var(--c-green)";
        } else {
            el.innerHTML = "ğŸŒ åœ¨çº¿çŠ¶æ€ (å»ºè®®æ–­ç½‘)";
            el.style.borderColor = "#666";
            el.style.color = "#666";
        }
    }
    window.addEventListener('online', checkNetStatus);
    window.addEventListener('offline', checkNetStatus);

    async function handleAuth(type, btnElement) {
        if (!client) return alert("æ•°æ®åº“è¿æ¥å¤±è´¥");
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        if (!email || !password) return showMsg('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ', 'error');
        if (password.length < 6) return showMsg('å¯†ç è‡³å°‘éœ€è¦6ä½', 'error');
        btnElement.innerText = "è¯·æ±‚ä¸­..."; btnElement.disabled = true;
        try {
            let result;
            if (type === 'login') result = await client.auth.signInWithPassword({email, password});
            else result = await client.auth.signUp({email, password});
            const { data, error } = result;
            if (error) {
                if (error.message.includes("User already registered")) showMsg("è¯¥é‚®ç®±å·²æ³¨å†Œï¼Œè¯·ç›´æ¥ç‚¹å‡»ç™»å½•", 'info');
                else showMsg(error.message, 'error');
            } else {
                if (type === 'signup') showMsg("æ³¨å†ŒæˆåŠŸï¼è¯·æŸ¥æ”¶é‚®ä»¶åç™»å½•", 'success');
                else if (data.user) { await loadUserData(data.user.id); toggleView('dash'); }
            }
        } catch (err) { alert("å¼‚å¸¸: " + err.message); } 
        finally { btnElement.innerText = type==='login'?'ç™»å½•':'æ³¨å†Œ'; btnElement.disabled = false; }
    }

    async function loadUserData(userId) {
        // RLS å®‰å…¨ä¸‹ï¼Œè¿™é‡Œåªèƒ½æŸ¥åˆ°è‡ªå·±çš„æ•°æ®
        const {data: vault, error} = await client.from("vaults").select("*").eq("id", userId).single();
        if(error) console.log("é¦–æ¬¡åŠ è½½å¯èƒ½æ˜¯æ–°ç”¨æˆ·:", error.message);
        if(vault) { currentUserData = vault; startLiveTimer(vault.last_checkin_at, vault.timeout_seconds); }
    }

    function renderVisual() {
        const totalVal = parseInt(document.getElementById('timeout-val').value);
        const countVal = parseInt(document.getElementById('warn-count').value);
        const intVal = parseInt(document.getElementById('warn-int-val').value);
        const content = document.getElementById('visual-content');
        const errorDiv = document.getElementById('visual-error');
        const wrapper = document.getElementById('visual-wrapper');
        const deployBtn = document.getElementById('deploy-btn');
        if (isNaN(totalVal) || isNaN(countVal) || isNaN(intVal)) {
            isConfigValid = false; content.innerHTML = "ç­‰å¾…å‚æ•°è¾“å…¥..."; deployBtn.disabled = true; wrapper.classList.remove('has-error'); return;
        }
        const totalSec = totalVal * parseInt(document.getElementById('timeout-unit').value);
        const intervalSec = intVal * parseInt(document.getElementById('warn-int-unit').value);
        const count = countVal;
        const startWarnRemaining = count * intervalSec; 
        if (startWarnRemaining >= totalSec) {
            isConfigValid = false; wrapper.classList.add('has-error');
            errorDiv.innerHTML = `âš ï¸ é€»è¾‘æº¢å‡º<br><span style="font-size:12px;color:#fff;">å”¤é†’éœ€ ${formatDuration(startWarnRemaining)} > æ€»é•¿ ${formatDuration(totalSec)}</span>`;
            deployBtn.disabled = true; return;
        }
        isConfigValid = true; wrapper.classList.remove('has-error'); deployBtn.disabled = false;
        const warnStartPercent = (startWarnRemaining / totalSec) * 100;
        let html = `
            <div class="timeline-container">
                <div class="range-warn" style="width:${warnStartPercent}%; left:0;"></div>
                <div class="range-safe" style="width:${100-warnStartPercent}%; left:${warnStartPercent}%;"></div>
                <div class="tick bottom death" style="left:0%"><div class="tick-label"><span class="tick-val">0</span>è§¦å‘</div></div>
                <div class="tick top warn" style="left:${warnStartPercent}%"><div class="tick-label"><span class="tick-val">${formatDuration(startWarnRemaining)}</span>å”¤é†’</div></div>
                <div class="tick bottom start" style="left:100%"><div class="tick-label"><span class="tick-val">${formatDuration(totalSec)}</span>ç­¾åˆ°</div></div>
                ${renderTicksSmart(totalSec, intervalSec, count)}
            </div>
            <div class="legend"><span><div class="dot" style="background:var(--c-red)"></div>æ­»æœŸ</span><span><div class="dot" style="background:var(--c-yellow)"></div>å”¤é†’åŒº</span><span><div class="dot" style="background:var(--c-green)"></div>å®‰å…¨åŒº</span></div>`;
        content.innerHTML = html;
    }
    function renderTicksSmart(totalSec, intervalSec, count) {
        if (count <= 1) return ''; let html = ''; const isDense = count > 5; 
        for (let i = 1; i < count; i++) {
            const remaining = (count - i) * intervalSec; const percent = (remaining / totalSec) * 100;
            if (count > 20 && i % 5 !== 0) continue; 
            html += `<div class="tick top ${isDense ? 'minor' : 'warn'}" style="left:${percent}%; opacity:${isDense?0.5:0.8}">${!isDense ? `<div class="tick-label" style="font-size:9px; bottom:20px; color:#666;">${formatDuration(remaining)}</div>` : ''}</div>`;
        } return html;
    }
    function formatDuration(seconds) {
        if(seconds >= 31536000) return (seconds/31536000).toFixed(1) + "å¹´";
        if(seconds >= 2592000) return (seconds/2592000).toFixed(1) + "æœˆ";
        if(seconds >= 86400) return (seconds/86400).toFixed(1) + "å¤©";
        if(seconds >= 3600) return (seconds/3600).toFixed(1) + "æ—¶";
        if(seconds >= 60) return (seconds/60).toFixed(0) + "åˆ†";
        return seconds + "s";
    }
    
    async function deploy(btn) {
        if (!isConfigValid) return showMsg("é…ç½®é€»è¾‘é”™è¯¯", "error");
        btn.innerText = "åŒæ­¥ä¸­..."; btn.disabled = true;
        
        try {
            const {data: {user}} = await client.auth.getUser();
            if(!user) throw new Error("ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
            
            const totalSec = parseInt(document.getElementById('timeout-val').value) * parseInt(document.getElementById('timeout-unit').value);
            const count = parseInt(document.getElementById('warn-count').value);
            const intervalSec = parseInt(document.getElementById('warn-int-val').value) * parseInt(document.getElementById('warn-int-unit').value);
            const warnStartRemaining = count * intervalSec;
            
            const updates = { 
                id: user.id, 
                owner_email: user.email, 
                status: 'active', 
                last_checkin_at: new Date().toISOString(), 
                timeout_seconds: totalSec, 
                warn_start_seconds: warnStartRemaining, 
                warn_interval_seconds: intervalSec, 
                warn_max_count: count, 
                warn_sent_count: 0 
            };
            
            const secret = document.getElementById("secret").value; 
            const ben = document.getElementById("ben").value;
            
            if(secret && ben) {
                // æ··åˆåŠ å¯†é€»è¾‘
                const aesKey = Array.from(crypto.getRandomValues(new Uint8Array(32)), b=>b.toString(16).padStart(2,'0')).join('');
                const encryptedData = CryptoJS.AES.encrypt(secret, aesKey).toString();
                const payload = JSON.stringify({ k: aesKey, t: ben });
                const encryptor = new JSEncrypt(); 
                encryptor.setPublicKey(WATCHDOG_PUBLIC_KEY);
                
                updates.encrypted_data = encryptedData; 
                updates.key_storage = encryptor.encrypt(payload);
            }
            
            const {error} = await client.from("vaults").upsert(updates);
            if(error) throw error;
            
            showMsg('é…ç½®å·²åŒæ­¥', 'success'); 
            startLiveTimer(updates.last_checkin_at, totalSec);
            
        } catch(e) {
            showMsg(e.message, 'error');
        } finally {
            btn.disabled = false; btn.innerText = "ğŸš€ åŒæ­¥é…ç½®åˆ°äº‘ç«¯";
        }
    }

    async function sendHeartbeat() {
        const btn = document.querySelector('.alive-btn');
        const originalText = btn.innerText;
        btn.innerText = "ç­¾åˆ°ä¸­..."; btn.disabled = true;
        
        try {
            const {data: {user}} = await client.auth.getUser();
            if(!user) throw new Error("æœªç™»å½•");
            
            const nowIso = new Date().toISOString();
            // RLS ç­–ç•¥å°†ä¿è¯ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„ ID
            const {error} = await client.from("vaults").update({ 
                last_checkin_at: nowIso, 
                warn_sent_count: 0, 
                status: 'active' 
            }).eq("id", user.id);
            
            if(error) throw error;
            
            showMsg('ç­¾åˆ°æˆåŠŸ', 'success'); 
            if(currentUserData) startLiveTimer(nowIso, currentUserData.timeout_seconds);
            
        } catch(e) {
            showMsg("ç­¾åˆ°å¤±è´¥: " + e.message, 'error');
        } finally {
            btn.innerText = originalText; btn.disabled = false;
        }
    }

    function startLiveTimer(lastCheckinStr, timeoutSec) {
        if(timerInterval) clearInterval(timerInterval);
        const lastCheckin = moment(lastCheckinStr); const deathTime = lastCheckin.add(timeoutSec, 'seconds');
        timerInterval = setInterval(() => {
            const now = moment(); const diff = deathTime.diff(now);
            if (diff <= 0) { document.getElementById('live-countdown').innerText = "00:00:00"; document.getElementById('live-countdown').style.color = "red"; return; }
            const d = Math.floor(diff / (1000 * 60 * 60 * 24)); const h = Math.floor((diff / (1000 * 60 * 60)) % 24).toString().padStart(2,'0'); const m = Math.floor((diff / 1000 / 60) % 60).toString().padStart(2,'0'); const s = Math.floor((diff / 1000) % 60).toString().padStart(2,'0');
            document.getElementById('live-countdown').innerText = `${d}å¤© ${h}:${m}:${s}`;
        }, 1000);
    }
    
    function showMsg(msg, type) { if (typeof Swal !== 'undefined') Swal.fire({ text: msg, icon: type, background: '#000', color: type=='error'?'red':'#0f0', confirmButtonColor: '#333' }); else alert(msg); }
    
    function toggleView(view) {
        document.getElementById('auth-container').classList.add('hidden'); document.getElementById('dash-container').classList.add('hidden');
        if(view==='dash') { document.getElementById('dash-container').classList.remove('hidden'); renderVisual(); }
        else if(view==='manual') { document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('login-section').classList.add('hidden'); document.getElementById('manual-section').classList.remove('hidden'); checkNetStatus(); } 
        else { document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('login-section').classList.remove('hidden'); document.getElementById('manual-section').classList.add('hidden'); }
    }

    // --- V9.5 æ™ºèƒ½è§£å¯†æµç¨‹ ---
    async function handleManualDecrypt(btn) { 
        const id = document.getElementById('manual-id').value.trim(); const key = document.getElementById('manual-key').value.trim();
        if(!id || !key) return showMsg('ä¿¡æ¯ä¸å…¨', 'error');
        btn.innerText = "è§£å¯†ä¸­...";
        try {
            const {data, error} = await client.from("vaults").select("encrypted_data").eq("id", id).single();
            if(error || !data) throw new Error("æ•°æ®ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®");
            
            const bytes = CryptoJS.AES.decrypt(data.encrypted_data, key);
            const text = bytes.toString(CryptoJS.enc.Utf8);
            if(!text) throw new Error("å¯†é’¥é”™è¯¯");
            
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: 'éªŒè¯é€šè¿‡', html: '<span style="color:red">æ•°æ®å·²è§£å¯†ã€‚è¯·ä¿æŒæ´»è·ƒï¼Œå¦åˆ™å°†è‡ªåŠ¨é”€æ¯ã€‚</span>', icon: 'warning', background: '#000', color: '#fff',
                    showCancelButton: true, confirmButtonText: 'æŸ¥çœ‹', confirmButtonColor: '#d33'
                }).then((res)=>{
                    if(res.isConfirmed) {
                        document.getElementById('login-section').classList.add('hidden');
                        document.getElementById('manual-section').classList.add('hidden');
                        document.getElementById('decrypt-view').classList.remove('hidden');
                        document.getElementById('decrypt-result').innerText = text;
                        checkNetStatus();

                        // æ¿€æ´»æ™ºèƒ½ç›‘æµ‹
                        idleTimeLeft = IDLE_LIMIT;
                        window.onmousemove = resetIdleTimer;
                        window.onkeydown = resetIdleTimer;
                        window.ontouchstart = resetIdleTimer;
                        window.onclick = resetIdleTimer;

                        idleInterval = setInterval(()=>{
                            idleTimeLeft--;
                            const percent = (idleTimeLeft / IDLE_LIMIT) * 100;
                            const bar = document.getElementById('burn-bar');
                            if(bar) bar.style.width = percent + "%";
                            
                            // å‰©ä½™10ç§’å˜çº¢é¢„è­¦
                            if(idleTimeLeft < 10) bar.style.background = "#ff0000";
                            else bar.style.background = "var(--c-red)";

                            if(idleTimeLeft <= 0) {
                                clearInterval(idleInterval);
                                location.reload(); // ç†”æ–­
                            }
                        }, 1000);
                    }
                });
            }
        } catch(e) { showMsg(e.message, 'error'); } finally { btn.innerText = "éªŒè¯å¹¶è§£å¯†"; }
    }
</script>
</body>
</html>
