<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PHOENIX | é›¶ç•Œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #000000; --text: #fff; --accent: #0A84FF; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        
        .scanner-container { position: relative; width: 120px; height: 120px; margin-bottom: 40px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        
        /* æ¨¡æ‹Ÿ FaceID æ‰«æåŠ¨ç”» */
        .scan-ring { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; border: 2px solid #333; box-sizing: border-box; transition: 0.5s; }
        .scan-core { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: #222; border-radius: 20px; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        
        /* æ¿€æ´»çŠ¶æ€ */
        .active .scan-ring { border-color: var(--accent); animation: pulse 1.5s infinite; }
        .active .scan-core { background: var(--accent); box-shadow: 0 0 30px var(--accent); }
        
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.3); opacity: 0; } }

        h1 { font-weight: 200; letter-spacing: 5px; margin: 0; font-size: 24px; opacity: 0.8; }
        p { color: #666; font-size: 12px; margin-top: 10px; letter-spacing: 1px; }

        .status-msg { margin-top: 30px; height: 20px; font-size: 12px; color: var(--accent); }
        
        .action-btn { margin-top: 50px; background: transparent; border: 1px solid #333; color: #666; padding: 10px 20px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: 0.3s; }
        .action-btn:hover { border-color: #666; color: #fff; }
    </style>
</head>
<body>

    <div class="scanner-container" id="scanner" onclick="startAuth()">
        <div class="scan-ring"></div>
        <div class="scan-core">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="white"><path d="M9 11.75c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zm6 0c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8 0-.29.02-.58.05-.86 2.36-1.05 4.23-2.98 5.21-5.37C11.07 8.33 14.05 10 17.42 10c.78 0 1.53-.09 2.25-.26.21 1.35.33 2.74.33 4.26 0 4.41-3.59 8-8 8z"/></svg>
        </div>
    </div>

    <h1>PHOENIX</h1>
    <p>TOUCH TO RESONATE</p>
    
    <div class="status-msg" id="msg"></div>

    <button class="action-btn" id="mode-btn" onclick="toggleMode()">å½“å‰æ¨¡å¼: ç™»å½•</button>

<script>
    // ============================================
    // âš ï¸ é…ç½®ä½ çš„ SUPABASE
    // ============================================
    const SUPABASE_URL = 'ä½ çš„URL';
    const SUPABASE_KEY = 'ä½ çš„KEY';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // çŠ¶æ€ç®¡ç†
    let isRegisterMode = false; // é»˜è®¤æ˜¯ç™»å½•æ¨¡å¼
    
    // å·¥å…·: Buffer è½¬ Base64Url (WebAuthn æ ‡å‡†æ ¼å¼)
    function bufferToBase64url(buffer) {
        const str = String.fromCharCode(...new Uint8Array(buffer));
        return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
    }
    
    function base64urlToBuffer(base64url) {
        const padding = '='.repeat((4 - base64url.length % 4) % 4);
        const base64 = (base64url + padding).replace(/-/g, "+").replace(/_/g, "/");
        const rawData = atob(base64);
        return Uint8Array.from(rawData, char => char.charCodeAt(0));
    }

    // åˆ‡æ¢ UI æ¨¡å¼
    function toggleMode() {
        isRegisterMode = !isRegisterMode;
        document.getElementById('mode-btn').innerText = isRegisterMode ? "å½“å‰æ¨¡å¼: æ³¨å†Œæ–°èº«ä»½" : "å½“å‰æ¨¡å¼: ç™»å½•";
        showMessage(isRegisterMode ? "å‡†å¤‡é“¸é€ æ–°å¯†é’¥..." : "å‡†å¤‡å…±é¸£...");
    }

    function showMessage(text) { document.getElementById('msg').innerText = text; }

    // ä¸»å…¥å£
    function startAuth() {
        const scanner = document.getElementById('scanner');
        scanner.classList.add('active');
        
        if (isRegisterMode) {
            doRegister();
        } else {
            doLogin();
        }
    }

    // ============================================
    // ğŸš€ æ ¸å¿ƒï¼šFaceID æ³¨å†Œ (Passkey)
    // ============================================
    async function doRegister() {
        try {
            showMessage("æ­£åœ¨è¯·æ±‚ FaceID æˆæƒ...");
            
            // 1. ç”Ÿæˆéšæœºç”¨æˆ· ID (æˆ‘ä»¬ä¸éœ€è¦ç”¨æˆ·åï¼Œåªéœ€è¦ä¸€ä¸ªéšæœºä»£å·)
            const userId = new Uint8Array(16);
            window.crypto.getRandomValues(userId);
            
            // 2. ç”ŸæˆæŒ‘æˆ˜
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);

            // 3. å”¤èµ· FaceID åˆ›å»º
            const credential = await navigator.credentials.create({
                publicKey: {
                    challenge: challenge,
                    rp: { name: "Phoenix Protocol" },
                    user: {
                        id: userId,
                        name: "Survivor-" + Date.now().toString().slice(-4), // ä»…ç”¨äºæ‰‹æœºæœ¬åœ°æ˜¾ç¤º
                        displayName: "Phoenix User"
                    },
                    pubKeyCredParams: [{ alg: -7, type: "public-key" }], // ES256
                    authenticatorSelection: {
                        authenticatorAttachment: "platform", // å¼ºåˆ¶æœ¬æœºèŠ¯ç‰‡
                        requireResidentKey: true,            // å…³é”®ï¼šé©»ç•™å¯†é’¥ (æ— éœ€ç”¨æˆ·åå³å¯ç™»å½•)
                        userVerification: "required"
                    },
                    timeout: 60000,
                    attestation: "none"
                }
            });

            // 4. è§£æç»“æœ
            const credentialId = bufferToBase64url(credential.rawId);
            // è¿™é‡Œçš„å…¬é’¥æå–æ¯”è¾ƒå¤æ‚ï¼Œä¸ºäº†æ¼”ç¤ºç®€å•ï¼Œæˆ‘ä»¬å­˜ä¸€ä¸ªæ ‡è®°
            // åœ¨ç”Ÿäº§ç¯å¢ƒéœ€è¦è§£æ CBOR æ ¼å¼æå–çœŸå®å…¬é’¥
            // ä½†å¯¹äºâ€œè¯æ˜æˆ‘æ‹¿ç€æ‰‹æœºâ€è¿™ä¸€æ­¥ï¼Œå­˜ Credential ID å°±è¶³å¤Ÿå»ºç«‹ç´¢å¼•äº†
            
            showMessage("æ­£åœ¨å†™å…¥äº‘ç«¯...");

            // 5. å­˜å…¥ Supabase
            const { error } = await supabase.from('user_vault').insert({
                credential_id: credentialId,
                public_key: "stored_in_secure_enclave" // ç®€åŒ–
            });

            if (error) throw error;

            showMessage("âœ… èº«ä»½é“¸é€ å®Œæˆã€‚");
            setTimeout(() => { 
                toggleMode(); // è‡ªåŠ¨åˆ‡å›ç™»å½•æ¨¡å¼
                document.getElementById('scanner').classList.remove('active');
            }, 2000);

        } catch (err) {
            console.error(err);
            showMessage("âŒ æ³¨å†Œå¤±è´¥: " + err.message);
            document.getElementById('scanner').classList.remove('active');
        }
    }

    // ============================================
    // ğŸ”“ æ ¸å¿ƒï¼šFaceID ç™»å½• (æ— ç”¨æˆ·å)
    // ============================================
    async function doLogin() {
        try {
            showMessage("æ­£åœ¨æ‰«æç”Ÿç‰©åœº...");
            
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);

            // 1. å”¤èµ· FaceID (ä¸ä¼  allowCredentialsï¼Œè®©æ‰‹æœºè‡ªå·±æ‰¾)
            const assertion = await navigator.credentials.get({
                publicKey: {
                    challenge: challenge,
                    rpId: location.hostname, // é™åˆ¶åœ¨å½“å‰åŸŸå
                    userVerification: "required"
                }
            });

            // 2. æ‹¿åˆ° Credential ID
            const credentialId = bufferToBase64url(assertion.rawId);
            
            showMessage("è¯†åˆ«æˆåŠŸã€‚æ­£åœ¨æ ¸å¯¹äº‘ç«¯è®°å½•...");

            // 3. å»æ•°æ®åº“æŸ¥è¿™ä¸ª ID æ˜¯å¦å­˜åœ¨
            const { data, error } = await supabase
                .from('user_vault')
                .select('*')
                .eq('credential_id', credentialId)
                .single();

            if (error || !data) throw new Error("äº‘ç«¯æœªæ‰¾åˆ°æ­¤èº«ä»½ (è¯·å…ˆæ³¨å†Œ)");

            // 4. æˆåŠŸ
            showMessage("ğŸ”“ å…±é¸£ç¡®è®¤ã€‚æ¬¢è¿å½’æ¥ã€‚");
            document.getElementById('scanner').classList.remove('active');
            
            // TODO: è·³è½¬...

        } catch (err) {
            console.error(err);
            showMessage("âŒ æ‹’ç»è®¿é—®: " + err.message);
            document.getElementById('scanner').classList.remove('active');
        }
    }
</script>

</body>
</html>
