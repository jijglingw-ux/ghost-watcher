<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡¤å‡°åè®® | é›¶ç•Œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #000000; --text: #fff; --accent: #0A84FF; --error: #FF453A; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; user-select: none; -webkit-user-select: none; }
        
        .scanner-container { position: relative; width: 140px; height: 140px; margin-bottom: 50px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        
        /* æ ¸å¿ƒåŠ¨ç”» */
        .scan-ring { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; border: 2px solid #333; box-sizing: border-box; transition: 0.5s; }
        .scan-core { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70px; height: 70px; background: #222; border-radius: 25px; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        
        /* æ¿€æ´»çŠ¶æ€ */
        .active .scan-ring { border-color: var(--accent); animation: pulse 1.5s infinite; }
        .active .scan-core { background: var(--accent); box-shadow: 0 0 40px var(--accent); transform: translate(-50%, -50%) scale(0.9); }
        
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.4); opacity: 0; } }

        h1 { font-weight: 300; letter-spacing: 8px; margin: 0; font-size: 26px; opacity: 0.9; text-indent: 8px; }
        p { color: #666; font-size: 13px; margin-top: 15px; letter-spacing: 2px; }

        .status-msg { margin-top: 40px; height: 20px; font-size: 14px; color: var(--accent); font-weight: 500; text-align: center; }
        
        .action-btn { margin-top: 60px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: #888; padding: 12px 24px; border-radius: 30px; font-size: 13px; cursor: pointer; transition: 0.3s; letter-spacing: 1px; }
        .action-btn:hover { border-color: #666; color: #fff; background: rgba(255,255,255,0.1); }

        /* é”™è¯¯æç¤ºæ¡† */
        .error-banner { display: none; position: fixed; top: 0; left: 0; width: 100%; background: rgba(255, 69, 58, 0.15); border-bottom: 1px solid var(--error); color: var(--error); padding: 15px; font-size: 12px; text-align: center; box-sizing: border-box; z-index: 100; backdrop-filter: blur(10px); }
    </style>
</head>
<body>

    <div id="error-box" class="error-banner"></div>

    <div class="scanner-container" id="scanner" onclick="startAuth()">
        <div class="scan-ring"></div>
        <div class="scan-core">
            <svg width="36" height="36" viewBox="0 0 24 24" fill="white" style="opacity: 0.9"><path d="M9 11.75c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zm6 0c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8 0-.29.02-.58.05-.86 2.36-1.05 4.23-2.98 5.21-5.37C11.07 8.33 14.05 10 17.42 10c.78 0 1.53-.09 2.25-.26.21 1.35.33 2.74.33 4.26 0 4.41-3.59 8-8 8z"/></svg>
        </div>
    </div>

    <h1>å‡¤å‡°åè®®</h1>
    <p>ç‚¹å‡» Â· å¼€å¯å…±é¸£</p>
    
    <div class="status-msg" id="msg"></div>

    <button class="action-btn" id="mode-btn" onclick="toggleMode(event)">å½“å‰æ¨¡å¼: èº«ä»½éªŒè¯</button>

<script>
    // ============================================
    // âš ï¸ å¿…å¡«ï¼šè¯·å¡«å…¥ä½ çš„ Supabase é…ç½®
    // ============================================
    const SUPABASE_URL = 'ä½ çš„URL';
    const SUPABASE_KEY = 'ä½ çš„KEY';
    
    // åˆå§‹åŒ–æ•°æ®åº“
    let supabase;
    try {
        if (!SUPABASE_URL.includes("ä½ çš„")) {
            supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }
    } catch (e) { console.error("Supabase åˆå§‹åŒ–å¤±è´¥", e); }

    // çŠ¶æ€ç®¡ç†
    let isRegisterMode = false; // false = ç™»å½•æ¨¡å¼, true = æ³¨å†Œæ¨¡å¼

    // å·¥å…·å‡½æ•°
    function bufferToBase64url(buffer) {
        const str = String.fromCharCode(...new Uint8Array(buffer));
        return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
    }
    
    function showMessage(text, isError = false) { 
        const el = document.getElementById('msg');
        el.innerText = text; 
        el.style.color = isError ? "var(--error)" : "var(--accent)";
    }

    // é”™è¯¯æ£€æŸ¥ï¼šé¡µé¢åŠ è½½æ—¶ç«‹å³æ£€æŸ¥ç¯å¢ƒ
    window.onload = function() {
        const errorBox = document.getElementById('error-box');
        let errorMsg = "";

        // 1. æ£€æŸ¥ HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            errorMsg = "âš ï¸ å®‰å…¨è­¦å‘Šï¼šFaceID å¿…é¡»åœ¨ HTTPS ç¯å¢ƒä¸‹è¿è¡Œã€‚<br>è¯·å‹¿ç›´æ¥æ‰“å¼€æ–‡ä»¶ï¼Œè¯·å°†ä»£ç éƒ¨ç½²åˆ° Vercel/GitHub Pagesã€‚";
        }
        // 2. æ£€æŸ¥ Supabase é…ç½®
        else if (SUPABASE_URL.includes("ä½ çš„")) {
            errorMsg = "âš ï¸ é…ç½®è­¦å‘Šï¼šåç«¯æœªè¿æ¥ã€‚<br>è¯·åœ¨ä»£ç ä¸­å¡«å…¥çœŸå®çš„ Supabase URL å’Œ KEYã€‚";
        }
        // 3. æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
        else if (!window.PublicKeyCredential) {
            errorMsg = "âš ï¸ è®¾å¤‡ä¸æ”¯æŒï¼šæ­¤è®¾å¤‡ä¸æ”¯æŒ WebAuthn (FaceID/æŒ‡çº¹)ã€‚<br>è¯·ä½¿ç”¨ iPhone (Safari) æˆ–æœ€æ–° Chromeã€‚";
        }

        if (errorMsg) {
            errorBox.innerHTML = errorMsg;
            errorBox.style.display = 'block';
            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢ç”¨æˆ·è¿·æƒ‘
            document.getElementById('scanner').style.opacity = 0.5;
            document.getElementById('scanner').style.pointerEvents = 'none';
        }
    }

    // åˆ‡æ¢æ¨¡å¼
    function toggleMode(e) {
        if(e) e.stopPropagation(); // é˜²æ­¢è§¦å‘ä¸Šé¢çš„ç‚¹å‡»
        isRegisterMode = !isRegisterMode;
        document.getElementById('mode-btn').innerText = isRegisterMode ? "å½“å‰æ¨¡å¼: é“¸é€ æ–°èº«ä»½ (æ³¨å†Œ)" : "å½“å‰æ¨¡å¼: èº«ä»½éªŒè¯ (ç™»å½•)";
        showMessage(isRegisterMode ? "å‡†å¤‡é“¸é€ ..." : "å‡†å¤‡å…±é¸£...");
    }

    // ä¸»äº¤äº’å…¥å£
    async function startAuth() {
        if (!supabase) return showMessage("é”™è¯¯: æ•°æ®åº“æœªè¿æ¥", true);

        const scanner = document.getElementById('scanner');
        scanner.classList.add('active');
        
        if (isRegisterMode) {
            await doRegister();
        } else {
            await doLogin();
        }
        
        // 2ç§’ååœæ­¢åŠ¨ç”»
        setTimeout(() => scanner.classList.remove('active'), 2000);
    }

    // ğŸš€ æ³¨å†Œé€»è¾‘
    async function doRegister() {
        try {
            showMessage("æ­£åœ¨è¯·æ±‚ç”Ÿç‰©æˆæƒ...");
            
            const userId = new Uint8Array(16);
            window.crypto.getRandomValues(userId);
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);

            const credential = await navigator.credentials.create({
                publicKey: {
                    challenge: challenge,
                    rp: { name: "Phoenix Protocol" },
                    user: {
                        id: userId,
                        name: "Survivor-" + Date.now().toString().slice(-4),
                        displayName: "Phoenix User"
                    },
                    pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                    authenticatorSelection: {
                        authenticatorAttachment: "platform", // å¼ºåˆ¶æœ¬æœºèŠ¯ç‰‡
                        requireResidentKey: true,            // å¿…é¡»é©»ç•™
                        userVerification: "required"
                    },
                    timeout: 60000,
                    attestation: "none"
                }
            });

            const credentialId = bufferToBase64url(credential.rawId);
            showMessage("æ­£åœ¨å†™å…¥äº‘ç«¯ä¿é™©ç®±...");

            const { error } = await supabase.from('user_vault').insert({
                credential_id: credentialId,
                public_key: "stored_in_secure_enclave"
            });

            if (error) throw error;

            showMessage("âœ… èº«ä»½é“¸é€ å®Œæˆï¼");
            setTimeout(() => { toggleMode(); }, 1500);

        } catch (err) {
            console.error(err);
            showMessage("âŒ æ³¨å†Œä¸­æ–­: " + err.message, true);
        }
    }

    // ğŸ”“ ç™»å½•é€»è¾‘
    async function doLogin() {
        try {
            showMessage("æ­£åœ¨æ‰«æç”Ÿç‰©åœº...");
            
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);

            // å”¤èµ· FaceID (ä¸æŒ‡å®š IDï¼Œè®©ç³»ç»Ÿè‡ªå·±å»åŒ¹é…)
            const assertion = await navigator.credentials.get({
                publicKey: {
                    challenge: challenge,
                    rpId: location.hostname,
                    userVerification: "required"
                }
            });

            const credentialId = bufferToBase64url(assertion.rawId);
            showMessage("è¯†åˆ«æˆåŠŸï¼Œæ­£åœ¨æ ¸å¯¹äº‘ç«¯...");

            const { data, error } = await supabase
                .from('user_vault')
                .select('*')
                .eq('credential_id', credentialId)
                .single();

            if (error || !data) throw new Error("äº‘ç«¯æœªæ‰¾åˆ°æ­¤èº«ä»½ (è¯·å…ˆæ³¨å†Œ)");

            showMessage("ğŸ”“ å…±é¸£ç¡®è®¤ã€‚æ¬¢è¿å½’æ¥ã€‚");

        } catch (err) {
            console.error(err);
            showMessage("âŒ æ‹’ç»è®¿é—®: " + err.message, true);
        }
    }
</script>

</body>
</html>
