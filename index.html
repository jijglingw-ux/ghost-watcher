<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PHOENIX | å¯»è¸ªè€…ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --bg: #000000; --text: #e0e0e0; --accent: #0A84FF; --gold: #D4AF37; --panel: #121214; --dim: #444; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; text-align: center; }
        
        .header { margin-top: 40px; margin-bottom: 30px; }
        h1 { font-weight: 200; letter-spacing: 6px; margin: 0; font-size: 24px; opacity: 0.9; }

        .page-container { width: 100%; max-width: 340px; display: none; flex-direction: column; animation: fadeIn 0.6s ease; }
        #page-home { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* å…¥å£å¡ç‰‡æ ·å¼ */
        .card-entry { width: 100%; padding: 35px 20px; background: var(--panel); border: 1px solid #222; border-radius: 24px; margin-bottom: 20px; cursor: pointer; transition: 0.2s; box-sizing: border-box; }
        .card-entry:active { transform: scale(0.97); background: #1a1a1c; }
        .card-entry .title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .card-entry .desc { font-size: 11px; color: var(--dim); letter-spacing: 1px; }

        /* å—ç›Šäººä¸­å¿ƒ - çŠ¶æ€å®¹å™¨ */
        .status-vault { background: var(--panel); padding: 40px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.03); width: 100%; box-sizing: border-box; position: relative; }
        
        /* ä¿¡å°è§†è§‰é€»è¾‘ */
        .envelope-zone { margin: 20px auto; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .envelope-svg { font-size: 80px; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .envelope-active { filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.4)); animation: float 3s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .status-label { font-size: 14px; letter-spacing: 2px; margin-top: 15px; color: #888; }

        /* é—å˜±å±•å¼€é¢æ¿ */
        #legacy-reveal { display: none; background: rgba(212, 175, 55, 0.05); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 20px; padding: 25px; margin-top: 20px; text-align: left; animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .legacy-text { font-size: 18px; line-height: 1.8; color: var(--gold); white-space: pre-wrap; word-break: break-all; }

        /* èº«ä»½ ID åŒºåŸŸ */
        .id-section { margin-top: 40px; padding: 20px; border-top: 1px solid #1a1a1c; width: 100%; }
        .id-title { font-size: 10px; color: var(--dim); letter-spacing: 2px; margin-bottom: 10px; text-transform: uppercase; }
        .id-box { background: #000; padding: 12px; border-radius: 12px; border: 1px solid #222; font-family: monospace; font-size: 10px; color: var(--dim); word-break: break-all; line-height: 1.4; cursor: pointer; transition: 0.2s; }
        .id-box:active { color: var(--gold); border-color: var(--gold); }

        .btn-back { margin-top: 40px; padding: 10px 20px; font-size: 12px; color: var(--dim); cursor: pointer; border-bottom: 1px solid #222; transition: 0.3s; }
        .btn-back:hover { color: #fff; border-color: #fff; }

        /* åŠ è½½ä¸­ */
        #loading { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 30px; height: 30px; border: 2px solid #222; border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div><p id="loading-text" style="margin-top:20px; font-size:12px; color:var(--dim);"></p></div>

    <div class="header"><h1>PHOENIX</h1></div>

    <div id="page-home" class="page-container">
        <div class="card-entry" onclick="showOwnerPage()">
            <div class="title" style="color:var(--accent)">æˆ‘è¦å°å­˜</div>
            <div class="desc">é€šè¿‡å¯¹æ–¹ ID å»ºç«‹è·¨æ—¶ç©ºè¿æ¥</div>
        </div>
        <div class="card-entry" onclick="checkHeirStatus()">
            <div class="title" style="color:var(--gold)">æˆ‘æ˜¯ç»§æ‰¿äºº</div>
            <div class="desc">åˆ·è„¸æ ¸éªŒèº«ä»½å¹¶å¼€å¯ä¿¡ç®±</div>
        </div>
    </div>

    <div id="page-heir" class="page-container">
        <div class="status-vault">
            <div class="envelope-zone" id="envelope-trigger" onclick="toggleLegacy()">
                <div id="envelope-icon" class="envelope-svg"></div>
            </div>
            <div id="status-desc" class="status-label">æ­£åœ¨åŒæ­¥å›å“...</div>

            <div id="legacy-reveal">
                <div style="font-size:10px; color:var(--gold); margin-bottom:15px; opacity:0.5; letter-spacing:2px;">â€”â€” å¯†é—­å›å“ â€”â€”</div>
                <div class="legacy-text" id="legacy-content"></div>
            </div>
        </div>

        <div class="id-section">
            <div class="id-title">æ‚¨çš„å”¯ä¸€èº«ä»½æ ‡è¯† (ID)</div>
            <div class="id-box" id="my-id-string" onclick="copyID()">ç‚¹å‡»å¤åˆ¶ ID</div>
        </div>

        <div class="btn-back" onclick="location.reload()">è¿”å›åè®®é¦–é¡µ</div>
    </div>

    <div id="page-owner" class="page-container">
        <div class="status-vault" id="owner-pairing">
            <h3 style="font-weight:300; margin-bottom:30px;">å»ºç«‹è¿æ¥</h3>
            <input type="text" id="target-id-input" placeholder="è¾“å…¥å—ç›Šäºº ID" style="width:100%; background:#000; border:1px solid #333; padding:15px; border-radius:12px; color:#fff; text-align:center; font-family:monospace; outline:none; font-size:13px;">
            <button onclick="handlePairing()" style="margin-top:20px; padding:15px; width:100%; border-radius:30px; border:none; background:var(--accent); color:#fff; font-weight:600; cursor:pointer;">å¼€å§‹é…å¯¹</button>
        </div>
        <div id="owner-editor" style="display:none; width:100%;">
            <textarea id="msg-input" placeholder="å†™ä¸‹æ‚¨çš„ä¼ æ‰¿ä¿¡æ¯..."></textarea>
            <button onclick="sealLegacy()" style="padding:15px; width:100%; border-radius:30px; border:none; background:var(--gold); color:#000; font-weight:600; cursor:pointer;">ç¡®è®¤å°å­˜å›å“</button>
        </div>
        <div class="btn-back" onclick="location.reload()">å–æ¶ˆå¹¶è¿”å›</div>
    </div>

<script>
    const SUPABASE_URL = 'https://uudlauufdnrdcztlesvr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1ZGxhdXVmZG5yZGN6dGxlc3ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMzIxMTAsImV4cCI6MjA4NDcwODExMH0.LgCJydI31uesR18qsvNpIYc4a-5YqlMX_khg3It4Ch4';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let _selfId, _cachedMsg, _targetId;
    let isOpened = false;

    // --- å—ç›Šäººé€»è¾‘ ---
    async function checkHeirStatus() {
        showLoading("å”¤é†’ç”Ÿç‰©è¯†åˆ«...");
        try {
            const auth = await navigator.credentials.get({
                publicKey: { challenge: new Uint8Array(32), rpId: location.hostname, userVerification: "required" }
            });
            _selfId = b64url(auth.rawId);
            
            showLoading("åŒæ­¥äº‘ç«¯çŠ¶æ€...");
            const { data } = await db.from('user_vault').select('*').eq('credential_id', _selfId).maybeSingle();
            
            if (!data) await initUser(_selfId);
            else renderHeirDashboard(data);
        } catch (e) {
            if (e.name !== "NotAllowedError") await initUser();
            else hideLoading();
        }
    }

    async function initUser(existingId = null) {
        showLoading("æ„å»ºåŠ å¯†ç¯å¢ƒ...");
        try {
            let id = existingId;
            if (!id) {
                const cred = await navigator.credentials.create({
                    publicKey: {
                        challenge: new Uint8Array(32), rp: { name: "Phoenix" },
                        user: { id: new Uint8Array(16), name: "User", displayName: "User" },
                        pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                        authenticatorSelection: { userVerification: "required" }
                    }
                });
                id = b64url(cred.rawId);
            }
            await db.from('user_vault').insert({ credential_id: id, status: 'empty' });
            location.reload();
        } catch (e) { hideLoading(); }
    }

    function renderHeirDashboard(data) {
        document.getElementById('page-home').style.display = 'none';
        document.getElementById('page-heir').style.display = 'flex';
        document.getElementById('my-id-string').innerText = _selfId;
        
        const icon = document.getElementById('envelope-icon');
        const desc = document.getElementById('status-desc');

        if (data.status === 'sealed') {
            icon.innerText = "âœ‰ï¸";
            icon.className = "envelope-svg envelope-active";
            desc.innerHTML = `<span style="color:var(--gold)">â— æ‚¨æœ‰ä¸€ä»½å°å­˜å›å“</span>`;
            _cachedMsg = data.encrypted_data;
        } else {
            icon.innerText = "ğŸ“­";
            icon.style.opacity = "0.1";
            desc.innerText = "ä¿¡ç®±é™é»˜ä¸­";
        }
        hideLoading();
    }

    function toggleLegacy() {
        if (!_cachedMsg) return;
        const panel = document.getElementById('legacy-reveal');
        const icon = document.getElementById('envelope-icon');
        isOpened = !isOpened;

        if (isOpened) {
            panel.style.display = 'block';
            document.getElementById('legacy-content').innerText = _cachedMsg;
            icon.innerText = "ğŸ“–";
            icon.style.transform = "scale(0.8)";
        } else {
            panel.style.display = 'none';
            icon.innerText = "âœ‰ï¸";
            icon.style.transform = "scale(1)";
        }
    }

    function copyID() {
        navigator.clipboard.writeText(_selfId).then(() => {
            const box = document.getElementById('my-id-string');
            const originalText = box.innerText;
            box.innerText = "å·²æˆåŠŸå¤åˆ¶ ID";
            box.style.color = "var(--gold)";
            setTimeout(() => {
                box.innerText = originalText;
                box.style.color = "var(--dim)";
            }, 2000);
        });
    }

    // --- ç«‹å˜±äººé€»è¾‘ ---
    function showOwnerPage() {
        document.getElementById('page-home').style.display = 'none';
        document.getElementById('page-owner').style.display = 'flex';
    }

    function handlePairing() {
        const id = document.getElementById('target-id-input').value.trim();
        if (id.length < 10) return alert("è¯·è¾“å…¥æ­£ç¡®çš„ ID");
        _targetId = id;
        document.getElementById('owner-pairing').style.display = 'none';
        document.getElementById('owner-editor').style.display = 'block';
    }

    async function sealLegacy() {
        const msg = document.getElementById('msg-input').value;
        if (!msg) return;
        showLoading("æ­£åœ¨å°å­˜é“­åˆ»...");
        const { error } = await db.from('user_vault').update({ encrypted_data: msg, status: 'sealed' }).eq('credential_id', _targetId);
        if (!error) { alert("é“­åˆ»å®Œæ¯•"); location.reload(); }
        else { alert("ID ä¸åŒ¹é…ï¼Œè¯·æ£€æŸ¥"); hideLoading(); }
    }

    // --- å·¥å…· ---
    function b64url(b) { return btoa(String.fromCharCode(...new Uint8Array(b))).replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, ""); }
    function showLoading(t) { document.getElementById('loading').style.display = 'flex'; document.getElementById('loading-text').innerText = t; }
    function hideLoading() { document.getElementById('loading').style.display = 'none'; }
</script>
</body>
</html>
