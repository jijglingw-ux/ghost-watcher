<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡¤å‡°åè®® V16.6 | å…¨çƒåŠ é€Ÿç‰ˆ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsencrypt@3.3.1/bin/jsencrypt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { 
            --c-green: #00ff41; --c-red: #ff3333; --c-yellow: #ffcc00; 
            --c-bg: #0d1117; --c-panel: rgba(22, 27, 34, 0.95); --c-border: #30363d;
        }
        * { box-sizing: border-box; }
        body { background: #000; color: var(--c-green); font-family: 'Courier New', monospace; margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; user-select: none; }
        
        .container { width: 100%; max-width: 900px; border: 1px solid var(--c-border); background: var(--c-panel); border-radius: 4px; overflow: hidden; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 30px rgba(0,255,65,0.05); }
        
        /* å¯¼èˆªæ  */
        .nav-tabs { display: flex; background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--c-border); }
        .nav-item { flex: 1; text-align: center; padding: 20px; cursor: pointer; color: #666; transition: 0.3s; font-weight: bold; border-bottom: 2px solid transparent; letter-spacing: 2px; font-size: 0.9rem; }
        .nav-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .nav-item.active { color: var(--c-green); border-bottom-color: var(--c-green); background: rgba(0,255,65,0.05); }
        .tab-content { padding: 0; display: none; } 
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .panel { padding: 25px 30px; border-bottom: 1px solid var(--c-border); }
        .panel-title { color: #fff; font-size: 0.8rem; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }
        .secret-zone { background: rgba(0, 255, 65, 0.02); }

        /* æ ¸å¿ƒå¸ƒå±€ */
        .monitor-row { display: flex; border-bottom: 1px solid var(--c-border); flex-direction: row; height: 220px; }
        .visual-col { flex: 1; padding: 30px 40px; border-right: 1px solid var(--c-border); position: relative; display: flex; flex-direction: column; justify-content: center; }
        .heartbeat-col { width: 220px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.2); gap: 20px; }

        .config-grid { display: grid; grid-template-columns: 1fr 1fr; border-bottom: 1px solid var(--c-border); }
        .config-panel { padding: 25px 30px; }
        .config-panel:first-child { border-right: 1px solid var(--c-border); }

        .input-group { display: flex; margin-bottom: 12px; border: 1px solid var(--c-border); border-radius: 3px; overflow: hidden; transition: border-color 0.3s; background: #000; height: 40px; }
        .input-group:focus-within { border-color: var(--c-green); }
        .input-label { background: rgba(255,255,255,0.05); padding: 0 15px; color: #888; font-size: 0.75rem; min-width: 80px; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--c-border); font-weight: bold; }
        input, select { flex: 1; background: transparent; border: none; color: var(--c-green); padding: 0 15px; outline: none; font-family: inherit; font-size: 0.9rem; width: 100%; height: 100%; }
        select { cursor: pointer; border-left: 1px solid var(--c-border); max-width: 70px; text-align: center; color: var(--c-green); }
        option { background: #000; }

        button { padding: 15px; background: transparent; border: 1px solid var(--c-green); color: var(--c-green); cursor: pointer; text-transform: uppercase; font-weight: bold; transition: 0.2s; width: 100%; border-radius: 0; letter-spacing: 1px; font-size: 0.9rem; }
        button:hover { background: var(--c-green); color: #000; box-shadow: 0 0 15px rgba(0,255,65,0.4); }
        button:disabled { border-color: #333; color: #444; cursor: not-allowed; background: transparent !important; box-shadow: none !important; }
        
        /* å¿ƒè·³æŒ‰é’® */
        .alive-btn { 
            width: 100px; height: 100px; border: 3px solid var(--c-yellow); border-radius: 50%; color: var(--c-yellow); background: rgba(255, 204, 0, 0.05);
            display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 0 20px rgba(255, 204, 0, 0.1);
        }
        .alive-btn:hover { background: var(--c-yellow); color: #000; box-shadow: 0 0 30px rgba(255, 204, 0, 0.6); transform: scale(1.05); }
        .alive-btn:active { transform: scale(0.95); }
        .alive-btn span.icon { font-size: 2rem; margin-bottom: 2px; }
        .alive-btn span.text { font-size: 0.8rem; font-weight: bold; letter-spacing: 2px; }
        
        #visual-timer-display { font-family: 'Courier New', monospace; font-size: 1.6rem; color: #fff; letter-spacing: 2px; font-weight: bold; text-align: center; text-shadow: 0 0 10px rgba(255,255,255,0.2); }

        /* è§†å›¾ç»„ä»¶ */
        .visualizer { position: relative; width: 100%; margin-bottom: 5px; }
        .visualizer.empty { color: #444; text-align: center; height: 60px; line-height: 60px; font-size: 0.8rem; font-style: italic; }
        
        /* è¿›åº¦æ¡ */
        .timeline-container { position: relative; height: 6px; background: #222; width: 100%; margin-top: 40px; margin-bottom: 20px; border-radius: 3px; }
        .range-warn { position: absolute; height: 100%; top: 0; left: 0; background: repeating-linear-gradient(45deg, var(--c-yellow), var(--c-yellow) 10px, #111 10px, #111 20px); z-index: 1; border-right: 2px solid var(--c-red); transition: width 0.3s; }
        .range-safe { position: absolute; height: 100%; top: 0; right: 0; background: var(--c-green); box-shadow: 0 0 15px rgba(0,255,65,0.1); z-index: 0; transition: width 0.3s; }
        
        .tick { position: absolute; transform: translateX(-50%); width: 2px; z-index: 2; transition: left 0.3s; }
        .tick.bottom { top: 0; height: 15px; }
        .tick.bottom .tick-label { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); text-align: center; font-size: 10px; white-space: nowrap; color: #666; font-weight: bold; }
        .tick.bottom.death { background: var(--c-red); height: 20px; z-index: 10; top: -7px; }
        .tick.bottom.death .tick-label { color: var(--c-red); top: 25px; }
        .tick.bottom.start { background: var(--c-green); z-index: 10; top: -7px; height: 20px; }
        .tick.bottom.start .tick-label { color: var(--c-green); top: 25px; }
        .tick.top { bottom: 0; height: 15px; }
        .tick.top .tick-label { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; font-size: 10px; white-space: nowrap; }
        .tick.top.warn { background: var(--c-yellow); z-index: 5; }
        .tick.top.warn .tick-label { color: var(--c-yellow); }
        
        .tick.now { top: -10px; height: 26px; width: 2px; background: #fff; z-index: 20; box-shadow: 0 0 10px #fff; display: none; transition: left 1s linear; }
        .tick.now .tick-label { color: #000; top: -25px; font-weight: bold; font-size: 9px; background: #fff; padding: 2px 4px; border-radius: 2px; }

        .error-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; color: var(--c-red); z-index: 30; text-align: center; font-size: 0.9rem; }
        .has-error .error-overlay { display: flex; }

        #auth-view { text-align: center; max-width: 320px; margin: auto; padding: 60px 0; }
        .hidden { display: none !important; }
        #decrypt-box { margin-top: 20px; padding: 20px; border: 1px dashed var(--c-green); color: #fff; word-break: break-all; white-space: pre-wrap; display: none; background: #000; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="container">
        <div id="auth-view">
            <h2 style="margin-bottom:40px; letter-spacing:4px; color:var(--c-green); font-size:1.5rem;">å‡¤å‡°åè®® V16.6</h2>
            <div class="input-group"><div class="input-label">è´¦å·</div><input type="email" id="auth-email" placeholder="Email"></div>
            <div class="input-group"><div class="input-label">å¯†é’¥</div><input type="password" id="auth-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
            <button onclick="handleAuth('login')">è¿›å…¥ç³»ç»Ÿ</button>
            <button class="outline" style="margin-top:10px; border-color:#333; color:#666;" onclick="handleAuth('signup')">æ³¨å†Œæ–°èº«ä»½</button>
        </div>

        <div id="dashboard-view" class="hidden">
            <div class="nav-tabs">
                <div class="nav-item active" onclick="switchTab('send')">ğŸ‘» å¯„åŒ…è£¹</div>
                <div class="nav-item" onclick="switchTab('receive')">ğŸ“¦ æ‹†åŒ…è£¹</div>
            </div>

            <div id="tab-send" class="tab-content active">
                <div class="panel secret-zone">
                    <div class="panel-title">1. ç»å¯†ä¿¡å°</div>
                    <div class="input-group"><div class="input-label">é—è¨€</div><input type="text" id="secret" placeholder="åœ¨æ­¤è¾“å…¥æ ¸å¿ƒæœºå¯†ï¼ˆå‘é€ååŠ å¯†å­˜å‚¨ï¼‰"></div>
                    <div class="input-group" style="margin-bottom:0;"><div class="input-label">å—ç›Šäºº</div><input type="email" id="ben" placeholder="æ¥æ”¶é€šçŸ¥çš„é‚®ç®±åœ°å€"></div>
                </div>

                <div class="monitor-row">
                    <div class="visual-col" id="visual-wrapper">
                        <div class="panel-title" style="margin-bottom:5px;">2. ç­–ç•¥æ¨æ¼”</div>
                        <div class="error-overlay" id="visual-error">âš ï¸ é€»è¾‘é”™è¯¯ï¼šå”¤é†’ > æ€»æ—¶é•¿</div>
                        <div id="visual-content" class="visualizer empty">ç­‰å¾…é…ç½®å‚æ•°...</div>
                    </div>
                    
                    <div class="heartbeat-col">
                        <div class="alive-btn" onclick="heartbeat()" title="ç‚¹å‡»é‡ç½®å€’è®¡æ—¶">
                            <span class="icon">â¤ï¸</span>
                            <span class="text">ç­¾åˆ°</span>
                        </div>
                        <div id="visual-timer-display">--:--:--</div>
                    </div>
                </div>

                <div class="config-grid">
                    <div class="config-panel">
                        <div class="panel-title">3. è§¦å‘è®¾å®š (å¿…å¡«)</div>
                        <div class="input-group" style="margin-bottom:0;">
                            <div class="input-label">æ€»æ—¶é•¿</div>
                            <input type="number" id="timeout-val" placeholder="ä¾‹å¦‚: 30" min="1" oninput="renderVisual()">
                            <select id="timeout-unit" onchange="renderVisual()">
                                <option value="60">åˆ†</option>
                                <option value="3600">æ—¶</option>
                                <option value="86400">å¤©</option>
                                <option value="2592000">æœˆ</option>
                            </select>
                        </div>
                    </div>
                    <div class="config-panel">
                        <div class="panel-title">4. å”¤é†’ç­–ç•¥ (é€‰å¡«ï¼Œè¿ä½“)</div>
                        <div class="input-group"><div class="input-label">å”¤é†’æ¬¡æ•°</div><input type="number" id="warn-count" placeholder="ä¾‹å¦‚: 3" min="0" oninput="renderVisual()"></div>
                        <div class="input-group" style="margin-bottom:0;">
                            <div class="input-label">é—´éš”</div>
                            <input type="number" id="warn-int-val" placeholder="ä¾‹å¦‚: 1" min="1" oninput="renderVisual()">
                            <select id="warn-int-unit" onchange="renderVisual()">
                                <option value="60">åˆ†</option>
                                <option value="3600">æ—¶</option>
                                <option value="86400">å¤©</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button onclick="deploy()" id="deploy-btn" style="border:none; border-top:1px solid var(--c-green); background:rgba(0,255,65,0.05); padding:20px;">ğŸš€ éƒ¨ç½²é…ç½® / æ›´æ–°åè®®</button>
            </div>

            <div id="tab-receive" class="tab-content">
                <div style="padding:40px 60px;">
                    <div style="text-align: center; color: #666; margin-bottom: 40px; font-size: 0.8rem;">æœ¬åœ°è§£å¯†ç»ˆç«¯ // çº¯ç¦»çº¿è¿ç®—</div>
                    <div class="input-group"><div class="input-label">ä¿¡æ‰˜ ID</div><input type="text" id="recv-id" placeholder="è¾“å…¥é‚®ä»¶ä¸­çš„ Vault ID"></div>
                    <div class="input-group"><div class="input-label">æå–å¯†é’¥</div><input type="text" id="recv-key" placeholder="è¾“å…¥é‚®ä»¶ä¸­çš„ AES Key"></div>
                    <button onclick="handleRetrieve()">éªŒè¯å¹¶è§£å¯†</button>
                    <div id="decrypt-box"></div>
                    <button class="outline" onclick="logout()" style="margin-top: 50px;">å®‰å…¨é€€å‡º</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // é…ç½® Supabase
    const DB_URL = 'https://uudlauufdnrdcztlesvr.supabase.co'; 
    const DB_KEY = 'sb_publishable_KtfqCfLqUd_AtLj0Nb2WKQ_aPbsHjus'; 
    const WATCHDOG_PUBLIC_KEY = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAviA23JxW181JM9cbwClQ
x7+KP+rmhFJ2RF30z1OAjvWngczIYYRT4EGjx74OLqP3leYXME+4ZKZIqt6v8jf1
trELXELa5khEOwWHj2EbOnhPdbk7aJ3Du/RmkZAu/gSVKHiWAeVPdmZuEDRP8wV1
gIYQsnXW+gNTt0SPKdheSkWTiksSImiJlzV3HC9AS/ucx/GfAhxnLLQ67ZhRE+Ub
ytBiBV+RfQX9P0oWbsESOD+FtiJfvKO74jA9naWsmG7hMmhotH1O1oC3YWFYvpNi
RYytkgByTOHBmtFqUVa1jIAJGdAZ8g1jMhZOOte5NfjJ4fJQhmqzdHBlH2xU/14A
pQIDAQAB
-----END PUBLIC KEY-----`;

    let client = null;
    let currentUser = null;
    let timerInterval = null;
    let currentVaultId = null; 
    let isConfigValid = false;

    // åˆå§‹åŒ–æ£€æŸ¥
    try {
        if (!window.supabase) throw new Error("Supabase åº“åŠ è½½å¤±è´¥");
        client = window.supabase.createClient(DB_URL, DB_KEY);
    } catch (e) { console.error(e); }

    function showSwal(msg, type = 'success', callback) {
        if(typeof Swal === 'undefined') { alert(msg); if(callback) callback(); return; }
        Swal.fire({ text: msg, icon: type, background: '#0d1117', color: '#fff', confirmButtonText: 'ç¡®å®š', confirmButtonColor: '#00ff41', allowOutsideClick: false }).then(() => { if(callback) callback(); });
    }

    async function handleAuth(type) {
        if(!client) return alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°");
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-pass').value;
        if(password.length < 6) return showSwal("å¯†ç è¿‡çŸ­", 'error');
        
        let result = type === 'login' ? await client.auth.signInWithPassword({ email, password }) : await client.auth.signUp({ email, password });
        if(result.error) {
            let msg = result.error.message;
            if(msg.includes("User already registered")) msg = "è¯¥è´¦å·å·²æ³¨å†Œï¼Œè¯·ç™»å½•";
            showSwal(msg, 'error');
        } else {
            if(type === 'signup') {
                showSwal("æ³¨å†ŒæˆåŠŸï¼è¯·ç‚¹å‡»ç™»å½•", 'success');
                await client.auth.signOut();
            } else if(result.data.user) {
                currentUser = result.data.user;
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                loadLatestVault(); 
            }
        }
    }

    async function logout() { await client.auth.signOut(); location.reload(); }

    function switchTab(tabName) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');
        if(tabName === 'send') renderVisual();
    }

    // --- æ ¸å¿ƒæ¸²æŸ“ ---
    function renderVisual(forceTime = null) {
        const totalInput = document.getElementById('timeout-val').value;
        const countInput = document.getElementById('warn-count').value;
        const intInput = document.getElementById('warn-int-val').value;
        const deployBtn = document.getElementById('deploy-btn');
        const wrapper = document.getElementById('visual-wrapper');
        const content = document.getElementById('visual-content');

        if (!totalInput) {
            isConfigValid = false; wrapper.classList.remove('has-error');
            content.innerHTML = "è¯·è¾“å…¥æ—¶é•¿..."; 
            deployBtn.disabled = true; deployBtn.style.opacity = 0.3; return;
        }

        const totalSec = parseInt(totalInput) * parseInt(document.getElementById('timeout-unit').value);
        let count = 0, intervalSec = 0;

        const hasCount = countInput && parseInt(countInput) > 0;
        const hasInt = intInput && parseInt(intInput) > 0;

        if (hasCount !== hasInt) {
            isConfigValid = false; wrapper.classList.add('has-error');
            document.querySelector('#visual-error').innerText = "âš ï¸ ç­–ç•¥é”™è¯¯ï¼šå”¤é†’æ¬¡æ•°å’Œé—´éš”å¿…é¡»åŒæ—¶å¡«å†™";
            content.innerHTML = "";
            deployBtn.disabled = true; deployBtn.style.opacity = 0.5; return;
        }

        if (hasCount && hasInt) {
            count = parseInt(countInput);
            intervalSec = parseInt(intInput) * parseInt(document.getElementById('warn-int-unit').value);
        }
        
        const startWarnRemaining = count * intervalSec;

        if (startWarnRemaining >= totalSec) {
            isConfigValid = false; wrapper.classList.add('has-error');
            document.querySelector('#visual-error').innerText = "âš ï¸ é€»è¾‘é”™è¯¯ï¼šå”¤é†’æ€»æ—¶é•¿ > æ€»æ—¶é•¿";
            content.innerHTML = "";
            deployBtn.disabled = true; deployBtn.style.opacity = 0.5; return;
        }

        isConfigValid = true; wrapper.classList.remove('has-error');
        deployBtn.disabled = false; deployBtn.style.opacity = 1;

        const warnStartPercent = (startWarnRemaining / totalSec) * 100;
        
        let html = `
            <div class="timeline-container">
                <div class="range-warn" style="width:${warnStartPercent}%; left:0;"></div>
                <div class="range-safe" style="width:${100-warnStartPercent}%; left:${warnStartPercent}%;"></div>
                
                <div id="tick-now" class="tick now" style="left:100%;"><div class="tick-label">NOW</div></div>

                <div class="tick bottom death" style="left:0%"><div class="tick-label">è§¦å‘</div></div>
                ${hasCount ? `<div class="tick top warn" style="left:${warnStartPercent}%"><div class="tick-label" style="color:var(--c-yellow);">é¢„è­¦</div></div>` : ''}
                <div class="tick bottom start" style="left:100%"><div class="tick-label">ç­¾åˆ°</div></div>
                ${renderTicksSmart(totalSec, intervalSec, count)}
            </div>`;
        content.innerHTML = html;

        if(forceTime !== null && totalSec > 0) {
            updateCursor(forceTime, totalSec);
        }
    }

    function updateCursor(remaining, total) {
        const tickNow = document.getElementById('tick-now');
        if(tickNow) {
            const percent = Math.max(0, Math.min(100, (remaining / total) * 100));
            tickNow.style.display = 'block';
            tickNow.style.left = percent + '%';
        }
    }

    function renderTicksSmart(totalSec, intervalSec, count) {
        if (count <= 0) return ''; 
        let html = ''; const isDense = count > 5; 
        for (let i = 1; i < count; i++) {
            const remaining = (count - i) * intervalSec; const percent = (remaining / totalSec) * 100;
            if (count > 20 && i % 5 !== 0) continue; 
            html += `<div class="tick top ${isDense ? 'minor' : 'warn'}" style="left:${percent}%; opacity:${isDense?0.5:0.8}"></div>`;
        } return html;
    }

    function formatDuration(seconds) {
        const d = Math.floor(seconds / 86400);
        const h = Math.floor((seconds % 86400) / 3600).toString().padStart(2,'0');
        const m = Math.floor((seconds % 3600) / 60).toString().padStart(2,'0');
        const s = Math.floor(seconds % 60).toString().padStart(2,'0');
        if(d > 0) return `${d}å¤© ${h}:${m}:${s}`;
        return `${h}:${m}:${s}`;
    }

    async function loadLatestVault() {
        if(!currentUser) return;
        const { data } = await client.from('vaults').select('*').eq('user_id', currentUser.id).eq('status', 'active').order('created_at', { ascending: false }).limit(1).single();
        if (data) {
            currentVaultId = data.id; 
            document.getElementById('ben').value = data.owner_email || ''; 
            if(data.timeout_seconds) {
                document.getElementById('timeout-val').value = Math.floor(data.timeout_seconds / 60);
                document.getElementById('timeout-unit').value = 60;
            }
            if(data.warn_max_count > 0) {
                document.getElementById('warn-count').value = data.warn_max_count;
                document.getElementById('warn-int-val').value = Math.floor(data.warn_interval_seconds / 60);
                document.getElementById('warn-int-unit').value = 60;
            }
            renderVisual(); 
            startTimer(data.last_checkin_at, data.timeout_seconds);
        } else { document.getElementById('visual-timer-display').innerText = "--:--:--"; }
    }

    async function deploy() {
        if(!currentUser || !isConfigValid) return showSwal("è¯·æ£€æŸ¥é…ç½®æ˜¯å¦å®Œæ•´", 'error');
        const btn = document.getElementById('deploy-btn'); btn.innerText = "å¤„ç†ä¸­...";
        const secret = document.getElementById('secret').value;
        const ben = document.getElementById('ben').value;
        if(!ben) { showSwal("å—ç›Šé‚®ç®±å¿…å¡«", 'warning'); btn.innerText = "ğŸš€ éƒ¨ç½²é…ç½® / æ›´æ–°åè®®"; return; }

        const totalSec = parseInt(document.getElementById('timeout-val').value) * parseInt(document.getElementById('timeout-unit').value);
        const countInput = document.getElementById('warn-count').value;
        const intInput = document.getElementById('warn-int-val').value;
        let count = 0, intervalSec = 300; 
        
        if (countInput && intInput) {
            count = parseInt(countInput);
            intervalSec = parseInt(intInput) * parseInt(document.getElementById('warn-int-unit').value);
        }
        const warnStartRemaining = count * intervalSec;

        const updates = {
            user_id: currentUser.id, package_name: "é»˜è®¤ä¿¡æ‰˜", owner_email: ben, timeout_seconds: totalSec,
            warn_start_seconds: warnStartRemaining, warn_interval_seconds: intervalSec, warn_max_count: count, warn_sent_count: 0,
            last_checkin_at: new Date().toISOString(), status: 'active'
        };
        if(currentVaultId) updates.id = currentVaultId;
        if(secret) {
            const aesKey = Array.from(crypto.getRandomValues(new Uint8Array(32)), b=>b.toString(16).padStart(2,'0')).join('');
            const encryptedData = CryptoJS.AES.encrypt(secret, aesKey).toString();
            const payload = JSON.stringify({ k: aesKey, t: ben });
            const encryptor = new JSEncrypt(); encryptor.setPublicKey(WATCHDOG_PUBLIC_KEY);
            updates.encrypted_data = encryptedData; updates.key_storage = encryptor.encrypt(payload);
        } else if (!currentVaultId) { showSwal("é¦–æ¬¡éœ€å¡«å†™ç»å¯†å†…å®¹", 'warning'); btn.innerText = "ğŸš€ éƒ¨ç½²é…ç½® / æ›´æ–°åè®®"; return; }

        const { data, error } = await client.from('vaults').upsert(updates).select();
        if(error) showSwal(translateError(error.message), 'error');
        else {
            if(data && data.length > 0) currentVaultId = data[0].id; 
            showSwal("é…ç½®å·²ç”Ÿæ•ˆ", 'success'); 
            // ç«‹å³å¯åŠ¨æœ¬åœ°å€’è®¡æ—¶
            renderVisual(totalSec); 
            startTimer(updates.last_checkin_at, totalSec);
        }
        btn.innerText = "ğŸš€ éƒ¨ç½²é…ç½® / æ›´æ–°åè®®";
    }

    async function heartbeat() {
        if(!currentVaultId) return showSwal("æœªéƒ¨ç½²é…ç½®", 'error');
        
        // ä¹è§‚æ›´æ–°
        const totalSec = parseInt(document.getElementById('timeout-val').value) * parseInt(document.getElementById('timeout-unit').value);
        startTimer(new Date().toISOString(), totalSec);
        
        const { error } = await client.from('vaults').update({ last_checkin_at: new Date().toISOString(), status: 'active', warn_sent_count: 0 }).eq('id', currentVaultId);
        if(!error) { 
            const btn = document.querySelector('.alive-btn');
            btn.style.transform = "scale(0.9)"; setTimeout(()=>btn.style.transform = "scale(1)", 150);
            Swal.fire({ title: 'å·²ç­¾åˆ°', icon: 'success', toast: true, position: 'top', timer: 1000, showConfirmButton: false, background:'#0d1117', color:'#fff' });
        }
    }

    function startTimer(lastCheckin, totalDuration) {
        if(timerInterval) clearInterval(timerInterval);
        const end = moment(lastCheckin).add(totalDuration, 'seconds');
        const display = document.getElementById('visual-timer-display');

        const tick = () => {
            const diff = end.diff(moment());
            const remainingSec = Math.max(0, diff / 1000);
            
            // é©±åŠ¨å…‰æ ‡
            updateCursor(remainingSec, totalDuration);

            if(diff <= 0) {
                clearInterval(timerInterval);
                display.innerText = "00:00:00"; display.style.color = "var(--c-red)";
                showSwal("æ­»æ‰‹å¼€å…³å·²è§¦å‘\né‚®ä»¶å·²å‘é€\nç³»ç»Ÿå³å°†å…³é—­", 'error', () => { logout(); });
            } else {
                display.innerText = formatDuration(remainingSec); display.style.color = "#fff";
            }
        };
        tick();
        timerInterval = setInterval(tick, 1000);
    }

    async function handleRetrieve() {
        const id = document.getElementById('recv-id').value.trim();
        const key = document.getElementById('recv-key').value.trim();
        if(!id || !key) return showSwal("ä¿¡æ¯ä¸å®Œæ•´", 'warning');
        const { data, error } = await client.from('vaults').select('encrypted_data').eq('id', id).single();
        if(error || !data) return showSwal("æ•°æ®ä¸å­˜åœ¨", 'error');
        try {
            const bytes = CryptoJS.AES.decrypt(data.encrypted_data, key);
            const originalText = bytes.toString(CryptoJS.enc.Utf8);
            if(!originalText) throw new Error();
            document.getElementById('decrypt-box').style.display = 'block';
            document.getElementById('decrypt-box').innerText = "ã€è§£å¯†æˆåŠŸã€‘\n" + originalText;
        } catch(e) { showSwal("å¯†é’¥é”™è¯¯", 'error'); }
    }
</script>
</body>
</html>
