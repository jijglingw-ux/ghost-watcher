<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡¤å‡°åè®® V7.0 | æˆ˜ç•¥ä¸­æ§</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        :root { --matrix-green: #00ff41; --danger-red: #ff3333; --warn-yellow: #ffcc00; --bg: #0d1117; }
        * { box-sizing: border-box; }
        body { background: #000; color: var(--matrix-green); font-family: 'Courier New', monospace; margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; background-image: radial-gradient(circle, #1a1a1a 0%, #000 100%); }
        .container { width: 95%; max-width: 600px; padding: 20px; border: 1px solid #333; background: rgba(13, 17, 23, 0.95); box-shadow: 0 0 20px rgba(0,255,65,0.1); max-height: 95vh; overflow-y: auto; }
        
        /* å¸ƒå±€ç»„ä»¶ */
        .section-title { border-bottom: 1px solid #333; padding-bottom: 5px; margin: 20px 0 10px; color: #fff; font-size: 0.9rem; font-weight: bold; }
        .row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .col { flex: 1; }
        label { font-size: 0.75rem; color: #888; display: block; margin-bottom: 4px; }
        
        input, select, textarea { background: #000; border: 1px solid #333; color: var(--matrix-green); padding: 10px; width: 100%; outline: none; font-family: inherit; }
        input:focus, select:focus { border-color: var(--matrix-green); }
        
        /* æŒ‰é’®ç»„ */
        button { padding: 12px; background: transparent; border: 1px solid var(--matrix-green); color: var(--matrix-green); cursor: pointer; text-transform: uppercase; font-weight: bold; transition: 0.2s; width: 100%; }
        button:hover { background: var(--matrix-green); color: #000; }
        button.alive { border-color: var(--warn-yellow); color: var(--warn-yellow); font-size: 1.1rem; margin-bottom: 20px; }
        button.alive:hover { background: var(--warn-yellow); color: #000; }
        
        /* è§†è§‰æ—¶é—´è½´ */
        .visualizer { margin-top: 20px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 4px; border-left: 3px solid #555; font-size: 0.8rem; }
        .v-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .bar-container { height: 6px; background: #333; margin: 8px 0 15px; position: relative; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; background: linear-gradient(90deg, var(--matrix-green) 0%, var(--warn-yellow) 80%, var(--danger-red) 100%); width: 0%; transition: width 0.5s; }
        .marker { position: absolute; top: 0; bottom: 0; width: 2px; background: #fff; opacity: 0.5; }
        
        /* å€’è®¡æ—¶å¤§å­— */
        .live-timer { text-align: center; font-size: 1.5rem; color: #fff; margin: 10px 0; font-weight: bold; text-shadow: 0 0 10px rgba(255,255,255,0.3); }

        .hidden { display: none !important; }
        .status-badge { display: inline-block; padding: 3px 8px; border: 1px solid var(--matrix-green); font-size: 0.7rem; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 style="text-align:center; margin:0 0 20px; border-bottom:1px solid var(--matrix-green); padding-bottom:15px;">å‡¤å‡°åè®® V7.0</h2>

        <div id="login-section">
            <input type="email" id="email" placeholder="Email" style="margin-bottom:10px;">
            <input type="password" id="password" placeholder="Password" style="margin-bottom:10px;">
            <div class="row">
                <button onclick="login()">ç™»å½•ä¸­æ§å°</button>
                <button onclick="signup()" style="border-color:#666; color:#888;">æ³¨å†Œ</button>
            </div>
            <p style="text-align:center; font-size:12px; color:#666; cursor:pointer; text-decoration:underline;" onclick="toggleView('manual')">æˆ‘æ˜¯å—ç›Šäºº (æ‰‹åŠ¨æå–)</p>
        </div>

        <div id="manual-section" class="hidden">
            <div class="status-badge">[ ç‰©ç†æå–é€šé“ ]</div>
            <input type="text" id="manual-id" placeholder="Vault ID" style="margin-bottom:10px;">
            <input type="text" id="manual-key" placeholder="AES Key" style="margin-bottom:10px;">
            <button onclick="handleManualDecrypt()">éªŒè¯å¹¶è§£å¯†</button>
            <p style="text-align:center; margin-top:10px; font-size:12px; cursor:pointer;" onclick="toggleView('login')">&lt; è¿”å›</p>
        </div>

        <div id="dash" class="hidden">
            <button class="alive" onclick="sendHeartbeat()">â¤ï¸ ç‚¹å‡»ç­¾åˆ° (é‡ç½®æ—¶é—´)</button>
            
            <div class="live-timer" id="live-countdown">--:--:--</div>
            <div style="text-align:center; font-size:10px; color:#666; margin-bottom:20px;">è·ç¦»åè®®è§¦å‘å‰©ä½™æ—¶é—´</div>

            <div class="section-title">â±ï¸ è§¦å‘è®¾å®š (å¤šä¹…ä¸ç­¾åˆ°è§†ä¸ºæ­»äº¡)</div>
            <div class="row">
                <input type="number" id="timeout-val" value="1" min="1" oninput="renderVisual()">
                <select id="timeout-unit" onchange="renderVisual()" style="width:30%;">
                    <option value="60">åˆ†</option>
                    <option value="3600">æ—¶</option>
                    <option value="86400">å¤©</option>
                    <option value="2592000">æœˆ</option>
                    <option value="31536000" selected>å¹´</option>
                </select>
            </div>

            <div class="section-title">ğŸ”” å”¤é†’é¢„è­¦ (è§¦å‘å‰å¤šä¹…å¼€å§‹æé†’)</div>
            <div class="row">
                <div class="col">
                    <label>æå‰é‡</label>
                    <div class="row" style="margin:0;">
                        <input type="number" id="warn-start-val" value="7" min="1" oninput="renderVisual()">
                        <select id="warn-start-unit" onchange="renderVisual()" style="width:50%;">
                            <option value="60">åˆ†</option>
                            <option value="3600">æ—¶</option>
                            <option value="86400" selected>å¤©</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <label>æé†’é¢‘ç‡</label>
                    <div class="row" style="margin:0;">
                        <input type="number" id="warn-int-val" value="1" min="1" oninput="renderVisual()">
                        <select id="warn-int-unit" onchange="renderVisual()" style="width:50%;">
                            <option value="60">åˆ†</option>
                            <option value="3600">æ—¶</option>
                            <option value="86400" selected>å¤©</option>
                        </select>
                    </div>
                </div>
                <div class="col" style="flex:0.5;">
                    <label>æ¬¡æ•°</label>
                    <input type="number" id="warn-max" value="3" min="1" oninput="renderVisual()">
                </div>
            </div>

            <div class="section-title">ğŸ” ç»å¯†ä¿¡å°</div>
            <textarea id="secret" rows="2" placeholder="é—è¨€å†…å®¹ (é€‰å¡«ï¼Œä¸å¡«åˆ™ä»…æ›´æ–°æ—¶é—´)"></textarea>
            <input type="email" id="ben" placeholder="å—ç›Šäººé‚®ç®± (é€‰å¡«)" style="margin-top:5px;">

            <div class="visualizer" id="visual-panel"></div>

            <button onclick="deploy()" style="margin-top:15px;">ğŸš€ åŒæ­¥é…ç½®åˆ°äº‘ç«¯</button>
        </div>
        
        <div id="decrypt-view" class="hidden">
            <div class="status-badge" style="color:red; border-color:red;">DATA PURGED IN 24H</div>
            <div id="decrypt-result" style="border:1px dashed #0f0; padding:10px; word-break:break-all;"></div>
        </div>
    </div>

<script>
    // ================= é…ç½®åŒº =================
    const DB_URL = 'https://uudlauufdnrdcztlesvr.supabase.co'; 
    const DB_KEY = 'sb_publishable_KtfqCfLqUd_AtLj0Nb2WKQ_aPbsHjus'; 
    const WATCHDOG_PUBLIC_KEY = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAviA23JxW181JM9cbwClQ
x7+KP+rmhFJ2RF30z1OAjvWngczIYYRT4EGjx74OLqP3leYXME+4ZKZIqt6v8jf1
trELXELa5khEOwWHj2EbOnhPdbk7aJ3Du/RmkZAu/gSVKHiWAeVPdmZuEDRP8wV1
gIYQsnXW+gNTt0SPKdheSkWTiksSImiJlzV3HC9AS/ucx/GfAhxnLLQ67ZhRE+Ub
ytBiBV+RfQX9P0oWbsESOD+FtiJfvKO74jA9naWsmG7hMmhotH1O1oC3YWFYvpNi
RYytkgByTOHBmtFqUVa1jIAJGdAZ8g1jMhZOOte5NfjJ4fJQhmqzdHBlH2xU/14A
pQIDAQAB
-----END PUBLIC KEY-----`;

    const client = window.supabase.createClient(DB_URL, DB_KEY);
    let currentUserData = null; // ç¼“å­˜ç”¨æˆ·æ•°æ®
    let timerInterval = null;

    // --- æ ¸å¿ƒé€»è¾‘ ---

    // 1. æ¸²æŸ“è§†è§‰æ¨æ¼” & è®¡ç®—ç§’æ•°
    function renderVisual() {
        const now = moment();
        
        // è·å–æ‰€æœ‰è¾“å…¥å¹¶è½¬ä¸ºç§’
        const timeoutSec = (parseInt(document.getElementById('timeout-val').value)||0) * parseInt(document.getElementById('timeout-unit').value);
        const warnStartSec = (parseInt(document.getElementById('warn-start-val').value)||0) * parseInt(document.getElementById('warn-start-unit').value);
        const warnIntSec = (parseInt(document.getElementById('warn-int-val').value)||0) * parseInt(document.getElementById('warn-int-unit').value);
        const warnMax = parseInt(document.getElementById('warn-max').value)||1;

        // è®¡ç®—å…³é”®æ—¶é—´ç‚¹
        const deathTime = moment().add(timeoutSec, 'seconds');
        const firstWarnTime = moment(deathTime).subtract(warnStartSec, 'seconds');
        
        // æ¸²æŸ“HTML
        let html = `<div class="v-row"><span style="color:#0f0">ç°åœ¨</span><span>${now.format('MM-DD HH:mm')}</span></div>`;
        
        // è¿›åº¦æ¡èƒŒæ™¯
        html += `<div class="bar-container">`;
        
        // å¦‚æœé¢„è­¦æ—¶é—´æœ‰æ•ˆï¼ˆåœ¨ç°åœ¨ä¹‹åï¼Œåœ¨æ­»æœŸä¹‹å‰ï¼‰
        if (firstWarnTime.isAfter(now) && firstWarnTime.isBefore(deathTime)) {
            // è®¡ç®—ç™¾åˆ†æ¯”ä½ç½®
            const percent = ((timeoutSec - warnStartSec) / timeoutSec) * 100;
            html += `<div class="marker" style="left:${percent}%; background:#ffcc00;"></div>`; // é¢„è­¦ç‚¹
        }
        
        html += `<div class="bar-fill" style="width:100%"></div></div>`; // ç®€å•å…¨å¡«å……ï¼Œé æ ‡è®°ç‚¹å®šä½

        // é¢„è­¦ä¿¡æ¯
        if (warnStartSec > 0 && warnStartSec < timeoutSec) {
            html += `
            <div class="v-row" style="color:#ffcc00">
                <span>ğŸ”” é¦–æ¬¡å”¤é†’</span>
                <span>${firstWarnTime.format('MM-DD HH:mm')}</span>
            </div>
            <div style="font-size:10px; color:#666; margin-bottom:5px;">
                (æ­»æœŸå‰ ${formatDuration(warnStartSec)} å¼€å§‹, æ¯ ${formatDuration(warnIntSec)} æé†’ä¸€æ¬¡, å…± ${warnMax} æ¬¡)
            </div>`;
        } else {
            html += `<div style="color:red; font-size:10px;">âš ï¸ é¢„è­¦è®¾ç½®æ— æ•ˆ (æ—¶é—´é‡å )</div>`;
        }

        html += `
            <div class="v-row" style="color:#ff3333; font-weight:bold; margin-top:5px;">
                <span>ğŸš€ åè®®è§¦å‘</span>
                <span>${deathTime.format('YYYY-MM-DD HH:mm')}</span>
            </div>`;

        document.getElementById('visual-panel').innerHTML = html;
        
        // æ›´æ–°å¤§å­—å€’è®¡æ—¶ (åŸºäºå½“å‰è¾“å…¥é¢„è§ˆï¼Œè€Œä¸æ˜¯æ•°æ®åº“)
        // å®é™…ä¸Šå¤§å­—åº”è¯¥æ˜¾ç¤ºâ€œæ•°æ®åº“é‡Œçš„çœŸå®å€’è®¡æ—¶â€ï¼Œè¿™é‡Œä»…åšè®¾å®šæ—¶çš„å‚è€ƒ
    }

    // è¾…åŠ©ï¼šç§’è½¬æ˜“è¯»æ–‡å­—
    function formatDuration(seconds) {
        if(seconds >= 86400) return (seconds/86400).toFixed(1) + "å¤©";
        if(seconds >= 3600) return (seconds/3600).toFixed(1) + "å°æ—¶";
        return (seconds/60).toFixed(0) + "åˆ†";
    }

    // 2. çœŸå®å€’è®¡æ—¶ (åŸºäºæ•°æ®åº“æ•°æ®)
    function startLiveTimer(lastCheckinStr, timeoutSec) {
        if(timerInterval) clearInterval(timerInterval);
        
        const lastCheckin = moment(lastCheckinStr);
        const deathTime = lastCheckin.add(timeoutSec, 'seconds');

        timerInterval = setInterval(() => {
            const now = moment();
            const diff = deathTime.diff(now); // æ¯«ç§’

            if (diff <= 0) {
                document.getElementById('live-countdown').innerText = "00:00:00";
                document.getElementById('live-countdown').style.color = "red";
                return;
            }

            const duration = moment.duration(diff);
            const days = Math.floor(duration.asDays());
            const hours = duration.hours().toString().padStart(2,'0');
            const mins = duration.minutes().toString().padStart(2,'0');
            const secs = duration.seconds().toString().padStart(2,'0');

            let str = `${hours}:${mins}:${secs}`;
            if(days > 0) str = `${days}å¤© ` + str;
            
            document.getElementById('live-countdown').innerText = str;
        }, 1000);
    }

    // 3. éƒ¨ç½²/ç­¾åˆ°é€»è¾‘
    async function deploy() {
        const user = (await client.auth.getUser()).data.user;
        if(!user) return Swal.fire({text:'è¯·å…ˆç™»å½•', background:'#000', color:'red'});

        // è·å–ç§’æ•°
        const timeoutSec = (parseInt(document.getElementById('timeout-val').value)||0) * parseInt(document.getElementById('timeout-unit').value);
        const warnStartSec = (parseInt(document.getElementById('warn-start-val').value)||0) * parseInt(document.getElementById('warn-start-unit').value);
        const warnIntSec = (parseInt(document.getElementById('warn-int-val').value)||0) * parseInt(document.getElementById('warn-int-unit').value);
        const warnMax = parseInt(document.getElementById('warn-max').value)||1;

        const updates = {
            id: user.id,
            owner_email: user.email,
            status: 'active',
            last_checkin_at: new Date().toISOString(),
            timeout_seconds: timeoutSec,
            warn_start_seconds: warnStartSec,
            warn_interval_seconds: warnIntSec,
            warn_max_count: warnMax,
            warn_sent_count: 0 // é‡ç½®é¢„è­¦æ¬¡æ•°
        };

        // å¤„ç†é—è¨€åŠ å¯† (å¦‚æœæœ‰)
        const secret = document.getElementById("secret").value;
        const ben = document.getElementById("ben").value;
        if(secret && ben) {
            const aesKey = Array.from(crypto.getRandomValues(new Uint8Array(32)), b=>b.toString(16).padStart(2,'0')).join('');
            const encryptedData = CryptoJS.AES.encrypt(secret, aesKey).toString();
            const payload = JSON.stringify({ k: aesKey, t: ben });
            const encryptor = new JSEncrypt();
            encryptor.setPublicKey(WATCHDOG_PUBLIC_KEY);
            updates.encrypted_data = encryptedData;
            updates.key_storage = encryptor.encrypt(payload);
        }

        const {error} = await client.from("vaults").upsert(updates);
        if(error) Swal.fire({text: error.message, background:'#000', color:'red'});
        else {
            Swal.fire({icon:'success', title:'é…ç½®å·²åŒæ­¥', text:'å¿ƒè·³å·²é‡ç½®ï¼Œå€’è®¡æ—¶å¼€å§‹', background:'#000', color:'#0f0'});
            startLiveTimer(updates.last_checkin_at, timeoutSec);
        }
    }

    async function sendHeartbeat() {
        // ç®€å•ç­¾åˆ°ï¼Œåªæ›´æ–°æ—¶é—´
        const user = (await client.auth.getUser()).data.user;
        if(!user) return;
        
        const nowIso = new Date().toISOString();
        const {error} = await client.from("vaults").update({
            last_checkin_at: nowIso,
            warn_sent_count: 0, // é‡ç½®å·²å‘é¢„è­¦æ•°
            status: 'active'
        }).eq("id", user.id);

        if(!error) {
            Swal.fire({icon:'success', title:'ç­¾åˆ°æˆåŠŸ', toast:true, position:'top', timer:1500, showConfirmButton:false, background:'#000', color:'#0f0'});
            // é‡æ–°è·å–æ•°æ®ä»¥åˆ·æ–°å€’è®¡æ—¶ï¼ˆæˆ–è€…ç›´æ¥ç”¨ç¼“å­˜çš„ timeout_secondsï¼‰
            if(currentUserData) startLiveTimer(nowIso, currentUserData.timeout_seconds);
        }
    }

    // è§†å›¾åˆ‡æ¢ä¸ç™»å½•
    function toggleView(view) {
        ['login-section','manual-section','dash','decrypt-view'].forEach(id=>document.getElementById(id).classList.add('hidden'));
        if(view==='login') document.getElementById('login-section').classList.remove('hidden');
        if(view==='manual') document.getElementById('manual-section').classList.remove('hidden');
        if(view==='dash') {
            document.getElementById('dash').classList.remove('hidden');
            renderVisual(); // åˆå§‹åŒ–è§†è§‰å›¾
        }
    }

    async function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const {data, error} = await client.auth.signInWithPassword({email, password});
        if(error) return Swal.fire({text:'ç™»å½•å¤±è´¥', background:'#000', color:'red'});
        
        // ç™»å½•æˆåŠŸï¼Œæ‹‰å–ç”¨æˆ·é…ç½®
        const {data: vault} = await client.from("vaults").select("*").eq("id", data.user.id).single();
        if(vault) {
            currentUserData = vault;
            startLiveTimer(vault.last_checkin_at, vault.timeout_seconds);
            // è¿™é‡Œå¯ä»¥æŠŠæ•°æ®åº“çš„å€¼å›å¡«åˆ°è¾“å…¥æ¡†ï¼Œç•¥
        }
        toggleView('dash');
    }

    // æ‰‹åŠ¨è§£å¯†é€»è¾‘ (V5.7ç‰ˆ)
    async function handleManualDecrypt() {
        const id = document.getElementById('manual-id').value.trim();
        const key = document.getElementById('manual-key').value.trim();
        if(!id || !key) return Swal.fire({text:'ä¿¡æ¯ä¸å…¨', background:'#000', color:'red'});
        
        Swal.showLoading();
        try {
            const {data} = await client.from("vaults").select("encrypted_data").eq("id", id).single();
            if(!data) throw new Error("æ•°æ®ä¸å­˜åœ¨");
            const bytes = CryptoJS.AES.decrypt(data.encrypted_data, key);
            const text = bytes.toString(CryptoJS.enc.Utf8);
            if(!text) throw new Error("å¯†é’¥é”™è¯¯");
            
            Swal.fire({
                title: 'èº«ä»½éªŒè¯é€šè¿‡',
                html: '<span style="color:red">âš ï¸ æ•°æ®å°†åœ¨24å°æ—¶åé”€æ¯</span>',
                icon: 'warning', background: '#000', color: '#fff',
                showCancelButton: true, confirmButtonText: 'æŸ¥çœ‹', confirmButtonColor: '#d33'
            }).then((res)=>{
                if(res.isConfirmed) {
                    toggleView('decrypt-view');
                    document.getElementById('decrypt-result').innerText = text;
                }
            });
        } catch(e) {
            Swal.fire({text: e.message, background:'#000', color:'red'});
        }
    }
</script>
</body>
</html>
