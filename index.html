<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡¤å‡°åè®® V19.0 | ç”Ÿç‰©é€šè¡Œè¯</title>
    
    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --c-bio: #ff0055; --c-bg: #000; --c-panel: #111; }
        * { box-sizing: border-box; }
        body { background: var(--c-bg); color: #fff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; user-select: none; }
        
        .fingerprint-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.1; pointer-events: none;
            background: repeating-radial-gradient(#333 0, #333 1px, transparent 2px, transparent 100%);
            background-size: 20px 20px;
        }

        .card {
            width: 360px; background: var(--c-panel); border: 1px solid #333; border-radius: 20px; padding: 40px 30px; text-align: center; position: relative; box-shadow: 0 20px 50px rgba(255, 0, 85, 0.1);
            transition: all 0.3s;
        }
        
        .icon-bio {
            font-size: 60px; margin-bottom: 20px; display: inline-block;
            filter: drop-shadow(0 0 10px var(--c-bio));
            animation: breathe 3s infinite ease-in-out;
        }
        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }

        h2 { margin: 0 0 10px; letter-spacing: 2px; font-weight: 300; }
        p { color: #666; font-size: 0.8rem; margin-bottom: 40px; }

        .btn {
            background: transparent; border: 1px solid var(--c-bio); color: var(--c-bio); padding: 15px 0; width: 100%; border-radius: 50px; font-size: 1rem; cursor: pointer; transition: 0.2s; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn:hover { background: var(--c-bio); color: #fff; box-shadow: 0 0 20px var(--c-bio); }
        .btn.secondary { border-color: #444; color: #888; }
        .btn.secondary:hover { border-color: #fff; color: #fff; background: transparent; box-shadow: none; }

        .status { position: fixed; bottom: 30px; font-size: 0.7rem; color: #444; }
        .hidden { display: none; }

        /* æ¨¡æ‹ŸæŒ‡çº¹æ‰«æåŠ¨ç”» */
        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: var(--c-bio);
            box-shadow: 0 0 10px var(--c-bio);
            animation: scan 2s infinite linear;
            display: none;
        }
        .scanning .scan-line { display: block; }
        @keyframes scan { 0% { top: 0; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
    </style>
</head>
<body>
    <div class="fingerprint-bg"></div>

    <div id="view-register" class="card">
        <div class="scan-line"></div>
        <div class="icon-bio">ğŸ§¬</div>
        <h2>PHOENIX ID</h2>
        <p>ç»‘å®šè®¾å¤‡ç”Ÿç‰©ç‰¹å¾ (FaceID / TouchID)</p>
        
        <button class="btn" onclick="registerPasskey()">
            <span>ğŸ–</span> åˆ›å»ºç”Ÿç‰©é€šè¡Œè¯
        </button>
        <button class="btn secondary" onclick="switchView('login')">å·²æœ‰èº«ä»½ï¼Ÿç›´æ¥éªŒè¯</button>
    </div>

    <div id="view-login" class="card hidden">
        <div class="scan-line"></div>
        <div class="icon-bio">â¤ï¸</div>
        <h2>èº«ä»½ç¡®è®¤</h2>
        <p>éªŒè¯ç”Ÿç‰©ç‰¹å¾ä»¥å‘é€å¿ƒè·³</p>
        
        <button class="btn" onclick="verifyPasskey()">
            <span>âš¡</span> éªŒè¯å¹¶ç­¾åˆ°
        </button>
        <button class="btn secondary" onclick="switchView('register')">æ³¨å†Œæ–°è®¾å¤‡</button>
    </div>

    <div class="status" id="status-text">ç³»ç»Ÿå°±ç»ª | ç­‰å¾…ç”Ÿç‰©ä¿¡å·</div>

<script>
    // æ¨¡æ‹Ÿåç«¯å­˜å‚¨ (å®é™…å¼€å‘ä¸­è¿™éƒ¨åˆ†é€»è¾‘åœ¨æœåŠ¡å™¨)
    // æˆ‘ä»¬æŠŠ "å…¬é’¥" å­˜åœ¨æœ¬åœ° localStorage æ¨¡æ‹ŸæœåŠ¡å™¨æ•°æ®åº“
    const DB_KEY_CREDENTIAL = 'phoenix_credential_id';

    function log(msg) { document.getElementById('status-text').innerText = msg; }
    function switchView(view) {
        document.querySelectorAll('.card').forEach(el => el.classList.add('hidden'));
        document.getElementById('view-' + view).classList.remove('hidden');
    }

    // --- 1. æ³¨å†Œ (åˆ›å»º Passkey) ---
    async function registerPasskey() {
        document.getElementById('view-register').classList.add('scanning');
        log("æ­£åœ¨è¯·æ±‚è®¾å¤‡å®‰å…¨èŠ¯ç‰‡...");

        try {
            // æŒ‘æˆ˜ç  (Challenge)ï¼šç”±æœåŠ¡å™¨ç”Ÿæˆçš„éšæœºä¹±ç ï¼Œé˜²é‡æ”¾æ”»å‡»
            // è¿™é‡Œæˆ‘ä»¬ç”¨éšæœºæ•°æ¨¡æ‹Ÿ
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);

            // WebAuthn åˆ›å»ºå‚æ•°
            const publicKey = {
                challenge: challenge,
                rp: { name: "Phoenix Protocol", id: location.hostname }, // ä¾èµ–åŸŸå
                user: {
                    id: Uint8Array.from("USER_ID_123", c => c.charCodeAt(0)),
                    name: "owner@phoenix.net",
                    displayName: "Phoenix Commander"
                },
                pubKeyCredParams: [{ alg: -7, type: "public-key" }], // ES256
                authenticatorSelection: {
                    authenticatorAttachment: "platform", // å¼ºåˆ¶ä½¿ç”¨æœ¬æœºèŠ¯ç‰‡(FaceID/æŒ‡çº¹)
                    userVerification: "required"
                },
                timeout: 60000
            };

            // å”¤èµ·æµè§ˆå™¨åŸç”Ÿå¼¹çª—
            const credential = await navigator.credentials.create({ publicKey });
            
            console.log("æ³¨å†Œå‡­è¯:", credential);
            
            // æ¨¡æ‹Ÿï¼šå°† Credential ID å­˜å…¥æ•°æ®åº“ (è¿™é‡Œå­˜æœ¬åœ°)
            // å®é™…ï¼šä½ åº”è¯¥æŠŠ credential.rawId å‘ç»™ Supabase
            // æ³¨æ„ï¼šArrayBuffer éœ€è¦è½¬ Base64 å­˜å‚¨
            const credId = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)));
            localStorage.setItem(DB_KEY_CREDENTIAL, credId);

            Swal.fire({
                title: 'ç”Ÿç‰©ç»‘å®šæˆåŠŸ',
                text: 'æ‚¨çš„æŒ‡çº¹/é¢å®¹å·²æˆä¸ºå”¯ä¸€å¯†é’¥ã€‚',
                icon: 'success',
                background: '#111', color: '#fff', confirmButtonColor: '#ff0055'
            }).then(() => switchView('login'));

        } catch (e) {
            console.error(e);
            Swal.fire({ title: 'ç»‘å®šå¤±è´¥', text: e.message, icon: 'error', background: '#111', color: '#fff' });
        } finally {
            document.getElementById('view-register').classList.remove('scanning');
            log("æ“ä½œç»“æŸ");
        }
    }

    // --- 2. éªŒè¯ (ä½¿ç”¨ Passkey) ---
    async function verifyPasskey() {
        const savedCredId = localStorage.getItem(DB_KEY_CREDENTIAL);
        if (!savedCredId) return Swal.fire({ title: 'æœªæ‰¾åˆ°é€šè¡Œè¯', text: 'è¯·å…ˆæ³¨å†Œ', icon: 'warning', background: '#111', color: '#fff' });

        document.getElementById('view-login').classList.add('scanning');
        log("æ­£åœ¨éªŒè¯ç”Ÿç‰©ç‰¹å¾...");

        try {
            // è¿˜åŸ Credential ID
            const allowCredentials = [{
                type: "public-key",
                id: Uint8Array.from(atob(savedCredId), c => c.charCodeAt(0))
            }];

            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);

            const publicKey = {
                challenge: challenge,
                allowCredentials: allowCredentials,
                userVerification: "required"
            };

            // å”¤èµ·éªŒè¯
            const assertion = await navigator.credentials.get({ publicKey });
            
            console.log("éªŒè¯å‡­è¯:", assertion);

            // æˆåŠŸï¼
            // åœ¨çœŸå®åœºæ™¯ä¸­ï¼Œè¿™é‡Œä¼šæŠŠ assertion å‘ç»™åç«¯ main.py éªŒè¯ç­¾å
            // éªŒè¯é€šè¿‡åï¼Œåç«¯æ›´æ–°æ•°æ®åº“çš„ last_checkin_at
            
            Swal.fire({
                title: 'èº«ä»½ç¡®è®¤',
                text: 'å¿ƒè·³å·²å‘é€ã€‚æ­»æ‰‹å¼€å…³é‡ç½®ã€‚',
                icon: 'success',
                background: '#111', color: '#fff', confirmButtonColor: '#ff0055'
            });

        } catch (e) {
            console.error(e);
            Swal.fire({ title: 'éªŒè¯å¤±è´¥', text: 'æ— æ³•ç¡®è®¤èº«ä»½', icon: 'error', background: '#111', color: '#fff' });
        } finally {
            document.getElementById('view-login').classList.remove('scanning');
            log("ç­‰å¾…ä¸‹ä¸€æ¬¡æŒ‡ä»¤...");
        }
    }
    
    // åˆå§‹åŒ–åˆ¤æ–­
    if(localStorage.getItem(DB_KEY_CREDENTIAL)) {
        switchView('login');
    }
</script>
</body>
</html>
