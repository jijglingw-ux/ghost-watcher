<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡¤å‡°åè®® V10.0 | é›¶ä¿¡ä»»ä¸­æ¢</title>
    
    <script src="https://lib.baomitu.com/sweetalert2/11.7.3/sweetalert2.all.min.js"></script>
    <script src="https://lib.baomitu.com/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://lib.baomitu.com/jsencrypt/3.3.1/jsencrypt.min.js"></script>
    <script src="https://lib.baomitu.com/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        :root { 
            --c-green: #00ff41; --c-red: #ff3333; --c-yellow: #ffcc00; 
            --c-bg: #050505; --c-panel: #111; --c-border: #333;
        }
        * { box-sizing: border-box; }
        body { background: var(--c-bg); color: var(--c-green); font-family: 'Courier New', monospace; margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; user-select: none; }
        
        .container { width: 100%; max-width: 900px; border: 1px solid var(--c-border); background: var(--c-panel); border-radius: 4px; overflow: hidden; position: relative; min-height: 600px; display:flex; flex-direction:column; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .nav-header { display: flex; border-bottom: 1px solid var(--c-border); background: #000; }
        .nav-item { flex: 1; text-align: center; padding: 15px; cursor: pointer; color: #666; transition: 0.3s; border-bottom: 2px solid transparent; }
        .nav-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .nav-item.active { color: var(--c-green); border-bottom-color: var(--c-green); font-weight: bold; background: rgba(0,255,65,0.05); }
        
        /* å†…å®¹åŒº */
        .view-section { padding: 30px; display: none; flex: 1; flex-direction: column; }
        .view-section.active { display: flex; }
        
        /* é€šç”¨ç»„ä»¶ */
        .input-group { margin-bottom: 15px; border: 1px solid var(--c-border); border-radius: 4px; background: #000; padding: 5px 10px; }
        .input-label { font-size: 0.75rem; color: #666; margin-bottom: 2px; }
        input, select { width: 100%; background: transparent; border: none; color: #fff; outline: none; font-family: inherit; font-size: 1rem; }
        button { width: 100%; padding: 15px; background: var(--c-green); color: #000; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; border-radius: 2px; }
        button:hover { filter: brightness(1.1); }
        button.outline { background: transparent; border: 1px solid var(--c-border); color: #888; }
        button.outline:hover { border-color: #fff; color: #fff; }

        /* ç™»å½•é¡µ */
        #auth-view { text-align: center; max-width: 350px; margin: auto; padding-top: 100px; }
        
        /* å†å²åˆ—è¡¨ */
        .history-item { border: 1px solid var(--c-border); padding: 15px; margin-bottom: 10px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; border: 1px solid #555; }
        .badge.active { border-color: var(--c-green); color: var(--c-green); }
        .badge.dispatched { border-color: var(--c-red); color: var(--c-red); }

        /* è§£å¯†ç»“æœåŒº */
        #decrypt-box { margin-top:20px; padding:20px; border:1px dashed var(--c-green); color:#fff; word-break:break-all; white-space:pre-wrap; display:none; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container" id="app">
        <div id="auth-view" class="">
            <h2 style="margin-bottom:40px; letter-spacing:4px;">PHOENIX V10.0</h2>
            <div class="input-group">
                <div class="input-label">IDENTITY</div>
                <input type="email" id="email" placeholder="name@example.com">
            </div>
            <div class="input-group">
                <div class="input-label">PASSPHRASE</div>
                <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button onclick="handleAuth('login')">è¿›å…¥ç³»ç»Ÿ</button>
            <button class="outline" onclick="handleAuth('signup')">æ³¨å†Œæ–°èº«ä»½</button>
        </div>

        <div id="dashboard-view" class="hidden">
            <div class="nav-header">
                <div class="nav-item active" onclick="switchTab('send')">ğŸ‘» å¯„å­˜åŒ…è£¹</div>
                <div class="nav-item" onclick="switchTab('receive')">ğŸ“¦ æå–åŒ…è£¹</div>
                <div class="nav-item" onclick="switchTab('manage')">ğŸ“œ æ¡£æ¡ˆç®¡ç†</div>
                <div class="nav-item" style="flex:0; min-width:60px; color:#444;" onclick="logout()">é€€å‡º</div>
            </div>

            <div id="tab-send" class="view-section active">
                <div class="input-group">
                    <div class="input-label">ç»å¯†å†…å®¹ (åŠ å¯†å­˜å…¥æ•°æ®åº“ï¼Œæ— äººå¯è§)</div>
                    <input type="text" id="secret" placeholder="è¾“å…¥é“¶è¡Œå¯†ç  / åŠ©è®°è¯ / é—è¨€...">
                </div>
                <div class="input-group">
                    <div class="input-label">å—ç›Šäººé‚®ç®±</div>
                    <input type="email" id="ben" placeholder="receiver@example.com">
                </div>
                
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <div class="input-group" style="flex:1">
                        <div class="input-label">é™é»˜å‘¨æœŸ</div>
                        <input type="number" id="timeout-val" value="30">
                    </div>
                    <div class="input-group" style="flex:1">
                        <div class="input-label">å•ä½</div>
                        <select id="timeout-unit">
                            <option value="86400">å¤©</option>
                            <option value="3600">å°æ—¶</option>
                            <option value="60" selected>åˆ†é’Ÿ</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top:auto; text-align:center;">
                    <h1 id="live-countdown" style="font-size:3rem; margin:20px 0;">--:--:--</h1>
                    <button class="outline" style="border-color:var(--c-yellow); color:var(--c-yellow); margin-bottom:10px;" onclick="sendHeartbeat()">â¤ï¸ ç­¾åˆ°ä¿æ´»</button>
                    <button onclick="deploy()">ğŸš€ åŒæ­¥/æ›´æ–°æ­»æ‰‹é…ç½®</button>
                </div>
            </div>

            <div id="tab-receive" class="view-section">
                <div style="text-align:center; margin-bottom:30px; color:#666; font-size:0.8rem;">
                    è¯·è¾“å…¥é‚®ä»¶ä¸­æ”¶åˆ°çš„å‡­è¯ã€‚<br>è§£å¯†è¿‡ç¨‹åœ¨æœ¬åœ°å®Œæˆï¼ŒæœåŠ¡å™¨ä»…è®°å½•â€œå–ä»¶â€è¡Œä¸ºã€‚
                </div>
                <div class="input-group">
                    <div class="input-label">VAULT ID</div>
                    <input type="text" id="recv-id" placeholder="é‚®ä»¶ä¸­çš„ ID">
                </div>
                <div class="input-group">
                    <div class="input-label">AES KEY</div>
                    <input type="text" id="recv-key" placeholder="é‚®ä»¶ä¸­çš„ Key">
                </div>
                <button onclick="handleRetrieve()">éªŒè¯å¹¶è§£å¯†</button>
                
                <div id="decrypt-box"></div>
            </div>

            <div id="tab-manage" class="view-section">
                <h4 style="border-bottom:1px solid #333; padding-bottom:10px; margin-top:0;">æˆ‘çš„å¯„å‡º (Sent)</h4>
                <div id="list-sent" style="margin-bottom:30px; min-height:100px; color:#666; font-size:0.8rem;">åŠ è½½ä¸­...</div>

                <h4 style="border-bottom:1px solid #333; padding-bottom:10px;">æˆ‘çš„å–ä»¶ (Received)</h4>
                <div id="list-received" style="min-height:100px; color:#666; font-size:0.8rem;">åŠ è½½ä¸­...</div>
                
                <p style="font-size:0.7rem; color:#444; margin-top:auto; text-align:center;">
                    * å®‰å…¨æç¤ºï¼šå–ä»¶è®°å½•ä»…åŒ…å«å…ƒæ•°æ®ã€‚ç»å¯†å†…å®¹ä»æœªæ˜æ–‡ä¿å­˜ã€‚
                </p>
            </div>
        </div>
    </div>

<script>
    const DB_URL = 'https://uudlauufdnrdcztlesvr.supabase.co'; 
    const DB_KEY = 'sb_publishable_KtfqCfLqUd_AtLj0Nb2WKQ_aPbsHjus'; 
    const WATCHDOG_PUBLIC_KEY = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAviA23JxW181JM9cbwClQ
x7+KP+rmhFJ2RF30z1OAjvWngczIYYRT4EGjx74OLqP3leYXME+4ZKZIqt6v8jf1
trELXELa5khEOwWHj2EbOnhPdbk7aJ3Du/RmkZAu/gSVKHiWAeVPdmZuEDRP8wV1
gIYQsnXW+gNTt0SPKdheSkWTiksSImiJlzV3HC9AS/ucx/GfAhxnLLQ67ZhRE+Ub
ytBiBV+RfQX9P0oWbsESOD+FtiJfvKO74jA9naWsmG7hMmhotH1O1oC3YWFYvpNi
RYytkgByTOHBmtFqUVa1jIAJGdAZ8g1jMhZOOte5NfjJ4fJQhmqzdHBlH2xU/14A
pQIDAQAB
-----END PUBLIC KEY-----`;

    const client = supabase.createClient(DB_URL, DB_KEY);
    let currentUser = null;
    let timerInterval = null;

    // --- è®¤è¯é€»è¾‘ ---
    async function handleAuth(type) {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if(password.length < 6) return alert("å¯†ç è¿‡çŸ­");
        
        const { data, error } = type === 'login' 
            ? await client.auth.signInWithPassword({ email, password })
            : await client.auth.signUp({ email, password });

        if(error) alert(error.message);
        else if(data.user) {
            currentUser = data.user;
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            loadMyVault(); // åŠ è½½æˆ‘çš„æ­»æ‰‹é…ç½®
            loadHistory(); // åŠ è½½å†å²è®°å½•
        } else {
            alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·æŸ¥æ”¶é‚®ä»¶ç¡®è®¤æˆ–ç›´æ¥ç™»å½•");
        }
    }

    async function logout() {
        await client.auth.signOut();
        location.reload();
    }

    // --- ç•Œé¢åˆ‡æ¢ ---
    function switchTab(tabName) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+tabName).classList.add('active');
    }

    // --- åŠŸèƒ½1: å¯„å­˜ (Send / Deploy) ---
    async function deploy() {
        if(!currentUser) return;
        const btn = event.target; btn.innerText = "åŠ å¯†ä¸Šä¼ ä¸­...";
        
        const secret = document.getElementById('secret').value;
        const ben = document.getElementById('ben').value;
        const timeout = parseInt(document.getElementById('timeout-val').value) * parseInt(document.getElementById('timeout-unit').value);

        const updates = {
            id: currentUser.id,
            owner_email: currentUser.email,
            timeout_seconds: timeout,
            last_checkin_at: new Date().toISOString(),
            status: 'active'
        };

        if(secret && ben) {
            // åªæœ‰è¾“å…¥äº†æ–°ç§˜å¯†æ‰æ›´æ–°åŠ å¯†æ•°æ®
            const aesKey = Array.from(crypto.getRandomValues(new Uint8Array(32)), b=>b.toString(16).padStart(2,'0')).join('');
            const encryptedData = CryptoJS.AES.encrypt(secret, aesKey).toString();
            const payload = JSON.stringify({ k: aesKey, t: ben });
            const encryptor = new JSEncrypt(); 
            encryptor.setPublicKey(WATCHDOG_PUBLIC_KEY);
            
            updates.encrypted_data = encryptedData;
            updates.key_storage = encryptor.encrypt(payload);
        }

        const { error } = await client.from('vaults').upsert(updates);
        btn.innerText = "ğŸš€ åŒæ­¥/æ›´æ–°æ­»æ‰‹é…ç½®";
        if(error) alert("åŒæ­¥å¤±è´¥: " + error.message);
        else {
            alert("é…ç½®å·²åŒæ­¥ï¼å€’è®¡æ—¶é‡ç½®ã€‚");
            loadMyVault();
        }
    }

    async function sendHeartbeat() {
        if(!currentUser) return;
        await client.from('vaults').update({ 
            last_checkin_at: new Date().toISOString(),
            status: 'active',
            warn_sent_count: 0
        }).eq('id', currentUser.id);
        alert("ç­¾åˆ°æˆåŠŸ");
        loadMyVault();
    }

    async function loadMyVault() {
        const { data } = await client.from('vaults').select('*').eq('id', currentUser.id).single();
        if(data) {
            startTimer(data.last_checkin_at, data.timeout_seconds);
        }
    }

    function startTimer(lastCheckin, duration) {
        if(timerInterval) clearInterval(timerInterval);
        const end = moment(lastCheckin).add(duration, 'seconds');
        timerInterval = setInterval(() => {
            const diff = end.diff(moment());
            if(diff <= 0) {
                document.getElementById('live-countdown').innerText = "00:00:00";
                document.getElementById('live-countdown').style.color = "red";
            } else {
                const d = moment.duration(diff);
                document.getElementById('live-countdown').innerText = 
                    `${Math.floor(d.asHours()).toString().padStart(2,'0')}:${d.minutes().toString().padStart(2,'0')}:${d.seconds().toString().padStart(2,'0')}`;
                document.getElementById('live-countdown').style.color = "#fff";
            }
        }, 1000);
    }

    // --- åŠŸèƒ½2: æå– (Receive / Retrieve) ---
    async function handleRetrieve() {
        const id = document.getElementById('recv-id').value.trim();
        const key = document.getElementById('recv-key').value.trim();
        if(!id || !key) return alert("è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯");

        // 1. è·å–å¯†æ–‡
        const { data, error } = await client.from('vaults').select('encrypted_data').eq('id', id).single();
        
        if(error || !data || data.encrypted_data === 'BURNED_METADATA') {
            return alert("æå–å¤±è´¥ï¼šæ•°æ®ä¸å­˜åœ¨æˆ–å·²è¢«ç‰©ç†é”€æ¯");
        }

        try {
            // 2. æœ¬åœ°è§£å¯†
            const bytes = CryptoJS.AES.decrypt(data.encrypted_data, key);
            const originalText = bytes.toString(CryptoJS.enc.Utf8);
            if(!originalText) throw new Error("Key é”™è¯¯");

            // 3. æ˜¾ç¤ºç»“æœ
            const box = document.getElementById('decrypt-box');
            box.style.display = 'block';
            box.innerText = "ã€è§£å¯†æˆåŠŸã€‘\n----------------------\n" + originalText;

            // 4. å†™å…¥å†å²è®°å½• (å®¡è®¡æ—¥å¿—)
            await client.from('retrievals').insert({
                user_id: currentUser.id,
                vault_id: id
            });
            loadHistory(); // åˆ·æ–°åˆ—è¡¨

        } catch(e) {
            alert("è§£å¯†å¤±è´¥: å¯†é’¥æ— æ•ˆ");
        }
    }

    // --- åŠŸèƒ½3: æ¡£æ¡ˆ (Manage / History) ---
    async function loadHistory() {
        if(!currentUser) return;

        // A. æˆ‘å‘å‡ºçš„
        const { data: myVault } = await client.from('vaults').select('*').eq('id', currentUser.id).single();
        const sentDiv = document.getElementById('list-sent');
        if(myVault) {
            let statusColor = myVault.status === 'active' ? 'active' : 'dispatched';
            sentDiv.innerHTML = `
                <div class="history-item">
                    <div>
                        <div style="font-weight:bold;">å½“å‰æ­»æ‰‹å¼€å…³</div>
                        <div style="font-size:0.75rem; color:#666;">ä¸Šæ¬¡ç­¾åˆ°: ${new Date(myVault.last_checkin_at).toLocaleString()}</div>
                    </div>
                    <div class="badge ${statusColor}">${myVault.status.toUpperCase()}</div>
                </div>
            `;
        } else {
            sentDiv.innerHTML = "æ— é…ç½®";
        }

        // B. æˆ‘æ”¶åˆ°çš„ (æŸ¥è¯¢ retrievals è¡¨)
        const { data: records } = await client.from('retrievals').select('*, vaults(id, status)').eq('user_id', currentUser.id).order('retrieved_at', {ascending: false});
        const recvDiv = document.getElementById('list-received');
        
        if(records && records.length > 0) {
            recvDiv.innerHTML = records.map(r => `
                <div class="history-item">
                    <div>
                        <div style="color:#aaa;">Vault: ...${r.vault_id.slice(-8)}</div>
                        <div style="font-size:0.75rem; color:#444;">æå–æ—¶é—´: ${new Date(r.retrieved_at).toLocaleString()}</div>
                    </div>
                    <div class="badge active">OPENED</div>
                </div>
            `).join('');
        } else {
            recvDiv.innerHTML = "æš‚æ— å–ä»¶è®°å½•";
        }
    }

    // è‡ªåŠ¨ç™»å½•æ£€æŸ¥
    client.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            currentUser = session.user;
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            loadMyVault();
            loadHistory();
        }
    });

</script>
</body>
</html>
