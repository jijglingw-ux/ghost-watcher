<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PHOENIX | æ°¸æ’å›å“åè®®</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --bg: #050505; --text: #e0e0e0; --accent: #0A84FF; --gold: #D4AF37; --panel: #121214; --dim: #666; }
        body { background-color: var(--bg); color: var(--text); font-family: "PingFang SC", "Hiragino Sans GB", sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; text-align: center; }
        
        .header { margin-top: 50px; margin-bottom: 40px; }
        h1 { font-weight: 200; letter-spacing: 8px; margin: 0; font-size: 28px; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .motto { color: var(--dim); font-size: 11px; margin-top: 12px; letter-spacing: 2px; text-transform: uppercase; }

        .page-container { width: 100%; max-width: 340px; display: none; flex-direction: column; animation: fadeIn 0.8s ease; }
        #page-home { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å…¥å£å¡ç‰‡ */
        .portal-card { width: 100%; padding: 40px 20px; background: linear-gradient(145deg, #1a1a1c 0%, #0a0a0a 100%); border: 1px solid rgba(255,255,255,0.05); border-radius: 24px; margin-bottom: 25px; cursor: pointer; transition: 0.3s; box-sizing: border-box; }
        .portal-card:active { transform: scale(0.97); border-color: rgba(255,255,255,0.2); }
        .portal-card .role-title { font-size: 20px; font-weight: 300; letter-spacing: 3px; margin-bottom: 10px; }
        .portal-card .role-desc { font-size: 12px; color: var(--dim); line-height: 1.6; }

        /* äº¤äº’ç»„ä»¶ */
        .btn-ritual { padding: 16px; border-radius: 35px; font-size: 15px; cursor: pointer; width: 100%; border: none; font-weight: 400; letter-spacing: 2px; transition: 0.4s; }
        .btn-gold { background: var(--gold); color: #000; box-shadow: 0 10px 30px rgba(212, 175, 55, 0.2); }
        .btn-dim { background: transparent; border: 1px solid #333; color: var(--dim); margin-top: 15px; }
        
        .status-box { background: var(--panel); padding: 35px 25px; border-radius: 28px; border: 1px solid rgba(255,255,255,0.03); width: 100%; box-sizing: border-box; }

        /* è§†è§‰ï¼šæ—¶ç©ºä¿¡å° */
        .relic-wrapper { margin: 30px auto; position: relative; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; }
        .relic-icon { font-size: 70px; transition: 0.5s; }
        .relic-glow { position: absolute; width: 100%; height: 100%; background: radial-gradient(circle, rgba(214,175,55,0.15) 0%, transparent 70%); animation: breathe 3s infinite; }
        @keyframes breathe { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } }

        /* èº«ä»½é”šç‚¹å±•ç¤º */
        .anchor-section { margin-top: 35px; padding-top: 25px; border-top: 1px solid #1a1a1c; }
        .anchor-label { font-size: 10px; color: var(--dim); letter-spacing: 2px; margin-bottom: 12px; }
        .anchor-string { background: #000; padding: 15px; border-radius: 12px; border: 1px solid #222; word-break: break-all; font-family: "Courier New", monospace; font-size: 10px; color: var(--gold); line-height: 1.5; opacity: 0.7; }
        .anchor-copy { background: transparent; border: none; color: var(--gold); font-size: 11px; margin-top: 10px; cursor: pointer; opacity: 0.6; text-decoration: underline; }

        /* ä¹¦å†™åŒºåŸŸ */
        textarea { width: 100%; height: 160px; background: #0a0a0a; border: 1px solid #222; color: #fff; padding: 20px; border-radius: 18px; font-size: 16px; box-sizing: border-box; resize: none; margin: 20px 0; line-height: 1.6; outline: none; }
        textarea:focus { border-color: var(--accent); }

        /* åŠ è½½è’™å±‚ */
        #ritual-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; flex-direction: column; justify-content: center; align-items: center; }
        .ritual-spinner { width: 30px; height: 30px; border: 2px solid #222; border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="ritual-overlay"><div class="ritual-spinner"></div><p id="ritual-text" style="margin-top:20px; font-size:12px; color:var(--dim); letter-spacing:1px;"></p></div>

    <div class="header"><h1>PHOENIX</h1><div class="motto">Memento Mori Â· Digital Vestige</div></div>

    <div id="page-home" class="page-container">
        <div class="portal-card" onclick="showOwnerPage()">
            <div class="role-title" style="color:var(--accent)">é“­åˆ»è€…</div>
            <div class="role-desc">è¾“å…¥å¯¹æ–¹çš„èº«ä»½é”šç‚¹<br>ä¸ºå…¶å°å­˜ä¸€ä»½è·¨è¶Šæ—¶ç©ºçš„å›å“</div>
        </div>
        <div class="portal-card" onclick="checkHeirStatus()">
            <div class="role-title" style="color:var(--gold)">å¯»è¸ªè€…</div>
            <div class="role-desc">é€šè¿‡ç”Ÿç‰©ç‰¹å¾å”¤é†’å¯†é’¥<br>å¼€å¯å±äºæ‚¨çš„å¯†é—­ä¿¡ç®±</div>
        </div>
    </div>

    <div id="page-owner" class="page-container">
        <div id="pairing-stage" class="status-box">
            <h3 style="font-weight:300; letter-spacing:2px;">é”šç‚¹é…å¯¹</h3>
            <p style="color:var(--dim); font-size:12px; margin-bottom:30px;">è¯·ç²˜è´´æ¥æ”¶æ–¹æä¾›çš„å”¯ä¸€å‡­è¯å­—ç¬¦ä¸²</p>
            <input type="text" id="id-input" placeholder="èº«ä»½é”šç‚¹ (Identity Anchor)" style="width:100%; background:#000; border:1px solid #333; border-radius:14px; color:#fff; padding:18px; font-size:13px; box-sizing:border-box; outline:none; text-align:center; font-family:monospace;">
            <button class="btn-ritual btn-gold" style="margin-top:25px;" onclick="performPairing()">å»ºç«‹è”ç³»</button>
        </div>

        <div id="etching-stage" style="display:none; text-align:left;">
            <div class="anchor-label">å·²è¿æ¥çš„å¯»è¸ªè€…ï¼š</div>
            <div class="anchor-string" id="target-id-label"></div>
            <textarea id="echo-input" placeholder="åœ¨è¿™é‡Œå†™ä¸‹æ‚¨çš„å›å“..."></textarea>
            <button class="btn-ritual btn-gold" onclick="sealRitual()">å®Œæˆé“­åˆ» Â· å°å­˜</button>
        </div>
        <div class="back-btn" onclick="location.reload()">æ”¾å¼ƒå¹¶è¿”å›</div>
    </div>

    <div id="page-heir" class="page-container">
        <div class="status-box">
            <div class="relic-wrapper" id="relic-visual">
                </div>
            <div id="vault-status-text" style="font-size:15px; letter-spacing:1px;"></div>

            <div class="anchor-section">
                <div class="anchor-label">æ‚¨çš„å”¯ä¸€èº«ä»½é”šç‚¹</div>
                <div class="anchor-string" id="my-anchor-id"></div>
                <button class="anchor-copy" onclick="copyAnchor()">ç‚¹å‡»å¤åˆ¶é”šç‚¹</button>
            </div>
        </div>

        <div id="legacy-gate" style="display: none; margin-top: 25px;">
            <button class="btn-ritual btn-gold" id="gate-btn" onclick="revealVestige()">ğŸ”‘ å¼€å¯å¯†é—­å›å“</button>
            <div id="echo-reveal-panel" style="display:none; background:rgba(212,175,55,0.03); border:1px solid rgba(212,175,55,0.2); border-radius:24px; padding:30px; margin-top:25px; text-align:left; animation: fadeIn 1s;">
                <div style="color:var(--gold); font-size:11px; letter-spacing:3px; margin-bottom:15px; opacity:0.6;">â€”â€” æ°¸æ’å°è®° â€”â€”</div>
                <div style="font-size:18px; line-height:1.8; white-space:pre-wrap;" id="echo-text"></div>
                <div style="margin-top:40px; border-top:1px solid #222; padding-top:15px; font-size:9px; color:#444; letter-spacing:2px;">PHOENIX PROTOCOL END</div>
            </div>
        </div>

        <div class="back-btn" onclick="location.reload()">æ–­å¼€ç‰©ç†è¿æ¥</div>
    </div>

<script>
    const SUPABASE_URL = 'https://uudlauufdnrdcztlesvr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1ZGxhdXVmZG5yZGN6dGxlc3ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMzIxMTAsImV4cCI6MjA4NDcwODExMH0.LgCJydI31uesR18qsvNpIYc4a-5YqlMX_khg3It4Ch4';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let _selfId, _cachedEcho, _targetId;

    // ============================================
    // ğŸ§  å¯»è¸ªè€…é€»è¾‘ï¼ˆæ¥æ”¶ç«¯ï¼‰
    // ============================================
    async function checkHeirStatus() {
        showRitual("æ ¸éªŒç”Ÿç‰©å¯†é’¥...");
        try {
            const auth = await navigator.credentials.get({
                publicKey: { challenge: new Uint8Array(32), rpId: location.hostname, userVerification: "required" }
            });
            _selfId = b64(auth.rawId);
            
            showRitual("åŒæ­¥æ—¶ç©ºæ•°æ®...");
            const { data } = await db.from('user_vault').select('*').eq('credential_id', _selfId).maybeSingle();
            
            if (!data) await initializeVessel(_selfId);
            else renderVault(data, _selfId);
        } catch (e) {
            if (e.name !== "NotAllowedError") await initializeVessel();
            else hideRitual();
        }
    }

    async function initializeVessel(existingId = null) {
        showRitual("å¼€è¾Ÿæ•°å­—è™šç©º...");
        try {
            let id = existingId;
            if (!id) {
                const cred = await navigator.credentials.create({
                    publicKey: {
                        challenge: new Uint8Array(32), rp: { name: "Phoenix" },
                        user: { id: new Uint8Array(16), name: "User", displayName: "User" },
                        pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                        authenticatorSelection: { userVerification: "required" }
                    }
                });
                id = b64(cred.rawId);
            }
            await db.from('user_vault').insert({ credential_id: id, status: 'empty' });
            const { data } = await db.from('user_vault').select('*').eq('credential_id', id).single();
            renderVault(data, id);
        } catch (e) { hideRitual(); }
    }

    function renderVault(data, id) {
        document.getElementById('page-home').style.display = 'none';
        document.getElementById('page-heir').style.display = 'flex';
        document.getElementById('my-anchor-id').innerText = id;
        
        const relic = document.getElementById('relic-visual');
        const status = document.getElementById('vault-status-text');
        const gate = document.getElementById('legacy-gate');

        if (data && data.status === 'sealed') {
            relic.innerHTML = `<div class="relic-glow"></div><div class="relic-icon">âœ‰ï¸</div>`;
            status.innerHTML = `<span style="color:var(--gold)">å‘ç°å°å­˜å›å“</span>`;
            _cachedEcho = data.encrypted_data;
            gate.style.display = 'block';
        } else {
            relic.innerHTML = `<div class="relic-icon" style="opacity:0.15">âŒ›</div>`;
            status.innerHTML = `<span style="color:var(--dim)">ä¿¡ç®±é™é»˜ä¸­</span>`;
            gate.style.display = 'none';
        }
        hideRitual();
    }

    function copyAnchor() {
        const text = document.getElementById('my-anchor-id').innerText;
        navigator.clipboard.writeText(text).then(() => {
            const btn = document.querySelector('.anchor-copy');
            btn.innerText = "å·²è®°å½•è‡³å‰ªè´´æ¿";
            setTimeout(() => btn.innerText = "ç‚¹å‡»å¤åˆ¶é”šç‚¹", 2000);
        });
    }

    function revealVestige() {
        const panel = document.getElementById('echo-reveal-panel');
        const btn = document.getElementById('gate-btn');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            document.getElementById('echo-text').innerText = _cachedEcho;
            btn.innerText = "âœ– éšè—å›å“";
            btn.classList.add('btn-dim');
            btn.classList.remove('btn-gold');
        } else {
            panel.style.display = 'none';
            btn.innerText = "ğŸ”‘ å¼€å¯å¯†é—­å›å“";
            btn.classList.add('btn-gold');
            btn.classList.remove('btn-dim');
        }
    }

    // ============================================
    // ğŸ–‹ï¸ é“­åˆ»è€…é€»è¾‘ï¼ˆå‘é€ç«¯ï¼‰
    // ============================================
    function showOwnerPage() {
        document.getElementById('page-home').style.display = 'none';
        document.getElementById('page-owner').style.display = 'flex';
    }

    function performPairing() {
        const input = document.getElementById('id-input').value.trim();
        if (input.length < 10) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„èº«ä»½é”šç‚¹");
        _targetId = input;
        document.getElementById('pairing-stage').style.display = 'none';
        document.getElementById('etching-stage').style.display = 'block';
        document.getElementById('target-id-label').innerText = _targetId;
    }

    async function sealRitual() {
        const msg = document.getElementById('echo-input').value;
        if (!msg) return alert("å›å“å†…å®¹ä¸èƒ½ä¸ºç©º");
        showRitual("æ­£åœ¨æ‰§è¡Œé“­åˆ»ä»ªå¼...");
        const { error } = await db.from('user_vault').update({ encrypted_data: msg, status: 'sealed' }).eq('credential_id', _targetId);
        hideRitual();
        if (!error) {
            alert("âœ… é“­åˆ»å®Œæˆã€‚å›å“å·²å°å­˜äºæ•°å­—è™šç©ºã€‚");
            location.reload();
        } else {
            alert("ä»ªå¼ä¸­æ–­ï¼šè¯·æ£€æŸ¥é”šç‚¹æ˜¯å¦æ­£ç¡®");
        }
    }

    // ============================================
    // ğŸ› ï¸ åè®®å·¥å…·
    // ============================================
    function b64(buffer) { return btoa(String.fromCharCode(...new Uint8Array(buffer))).replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, ""); }
    function showRitual(txt) { document.getElementById('ritual-overlay').style.display = 'flex'; document.getElementById('ritual-text').innerText = txt; }
    function hideRitual() { document.getElementById('ritual-overlay').style.display = 'none'; }
</script>
</body>
</html>
