<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PHOENIX | èº«ä»½é—¨æˆ·</title>
    <style>
        :root { --bg: #000000; --text: #e0e0e0; --accent: #ff3b30; --panel: #1c1c1e; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        
        .container { background: var(--panel); width: 100%; max-width: 360px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; border: 1px solid #333; }
        
        h1 { margin-bottom: 5px; font-weight: 700; letter-spacing: 1px; }
        .subtitle { font-size: 12px; color: #666; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        label { font-size: 12px; color: #888; margin-left: 10px; }
        input { width: 100%; background: #2c2c2e; border: none; padding: 15px; color: #fff; border-radius: 12px; margin-top: 5px; font-size: 16px; outline: none; box-sizing: border-box; transition: 0.2s; }
        input:focus { background: #3a3a3c; box-shadow: 0 0 0 2px var(--accent); }
        
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-secondary { background: #3a3a3c; color: var(--accent); margin-top: 15px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .btn:active { transform: scale(0.98); }

        .apple-warning { display: none; background: rgba(255, 59, 48, 0.1); border: 1px solid var(--accent); color: var(--accent); padding: 15px; border-radius: 12px; font-size: 13px; margin-bottom: 20px; line-height: 1.5; text-align: left; }
        
        .icon-faceid { width: 20px; height: 20px; fill: currentColor; }
    </style>
</head>
<body>

<div class="container">
    <div id="apple-check-msg" class="apple-warning">
        âš ï¸ <b>éå—ä¿¡ä»»ç¯å¢ƒ</b><br>å‡¤å‡°åè®®ä»…æ”¯æŒæ­è½½ Secure Enclave èŠ¯ç‰‡çš„ Apple è®¾å¤‡ã€‚<br>è¯·ä½¿ç”¨ iPhone (Safari) è®¿é—®ã€‚
    </div>

    <h1>PHOENIX</h1>
    <div class="subtitle">Protocol V1.0</div>

    <div class="input-group">
        <label>è´¦æˆ· ID</label>
        <input type="text" id="username" placeholder="è¯·è¾“å…¥æ‚¨çš„ä»£å·" autocomplete="username">
    </div>

    <div class="input-group">
        <label>å®‰å…¨å¯†ç </label>
        <input type="password" id="password" placeholder="è®¾ç½®é™æ€å¯†ç " autocomplete="current-password">
    </div>

    <button class="btn btn-primary" id="btn-register" onclick="handleRegister()">
        <svg class="icon-faceid" viewBox="0 0 24 24"><path d="M9 11.75c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zm6 0c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8 0-.29.02-.58.05-.86 2.36-1.05 4.23-2.98 5.21-5.37C11.07 8.33 14.05 10 17.42 10c.78 0 1.53-.09 2.25-.26.21 1.35.33 2.74.33 4.26 0 4.41-3.59 8-8 8z"/></svg>
        æ³¨å†Œå¹¶ç»‘å®š FaceID
    </button>

    <button class="btn btn-secondary" id="btn-login" onclick="handleLogin()">
        å·²æœ‰è´¦å·ï¼Ÿåˆ·è„¸ç™»å½•
    </button>
</div>

<script>
    // --- 1. ç¯å¢ƒæ£€æµ‹é€»è¾‘ ---
    const isAppleDevice = /Mac|iPod|iPhone|iPad/.test(navigator.platform) || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
    const isWebAuthnSupported = !!(window.PublicKeyCredential);

    // å¼ºåˆ¶æ£€æŸ¥ï¼šå¿…é¡»æ˜¯è‹¹æœè®¾å¤‡ ä¸” æ”¯æŒ WebAuthn
    if (!isAppleDevice || !isWebAuthnSupported) {
        document.getElementById('apple-check-msg').style.display = 'block';
        // ç¦ç”¨æ‰€æœ‰æ“ä½œ
        document.querySelectorAll('input, button').forEach(el => el.disabled = true);
    }

    // --- 2. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ---

    // [æ¨¡æ‹Ÿ] æ³¨å†Œæµç¨‹
    async function handleRegister() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;

        if (!user || !pass) return alert("è¯·è¾“å…¥å®Œæ•´çš„è´¦æˆ·å’Œå¯†ç ");

        // æ­¥éª¤ A: å‡†å¤‡åˆ›å»º Passkey (FaceID)
        // è¿™é‡Œç”Ÿæˆä¸€ä¸ªéšæœº Challenge (çœŸå®ç¯å¢ƒåº”ç”±æœåŠ¡å™¨ç”Ÿæˆ)
        const challenge = new Uint8Array(32);
        window.crypto.getRandomValues(challenge);

        const userId = new Uint8Array(16);
        window.crypto.getRandomValues(userId);

        const publicKeyCredentialCreationOptions = {
            challenge: challenge,
            rp: { name: "Phoenix Protocol", id: location.hostname }, // ä¾èµ–å½“å‰åŸŸå
            user: {
                id: userId,
                name: user,
                displayName: user
            },
            pubKeyCredParams: [{ alg: -7, type: "public-key" }], // ES256 (Apple FaceID æ ‡å‡†)
            authenticatorSelection: {
                authenticatorAttachment: "platform", // å¼ºåˆ¶ä½¿ç”¨æœ¬æœºèŠ¯ç‰‡ (FaceID/TouchID)
                userVerification: "required"         // å¼ºåˆ¶ç”Ÿç‰©è¯†åˆ«ï¼Œä¸èƒ½åªè¾“å¯†ç 
            },
            timeout: 60000,
            attestation: "direct"
        };

        try {
            // æ­¥éª¤ B: å”¤èµ· FaceID
            // è¿™ä¸€æ­¥ä¼šå¼¹å‡ºç³»ç»Ÿçº§å¼¹çª—ï¼šâ€œæ˜¯å¦å…è®¸ä½¿ç”¨ FaceIDï¼Ÿâ€
            const credential = await navigator.credentials.create({
                publicKey: publicKeyCredentialCreationOptions
            });

            console.log("FaceID å‡­è¯ç”ŸæˆæˆåŠŸ:", credential);
            
            // æ­¥éª¤ C: æ¨¡æ‹Ÿä¿å­˜ (çœŸå®ç¯å¢ƒè¦æŠŠ credential å‘ç»™æœåŠ¡å™¨å­˜èµ·æ¥)
            localStorage.setItem('phoenix_user', user);
            localStorage.setItem('phoenix_pass', pass); // ä»…æ¼”ç¤ºï¼Œå®é™…ä¸è¦å­˜æ˜æ–‡å¯†ç 
            localStorage.setItem('phoenix_credential_id', btoa(String.fromCharCode(...new Uint8Array(credential.rawId))));

            alert(`âœ… æ³¨å†ŒæˆåŠŸï¼\n\nè´¦æˆ·: ${user}\nFaceID: å·²ç»‘å®š\nè®¾å¤‡: Apple Secure Enclave`);
            
        } catch (err) {
            console.error(err);
            alert("âŒ æ³¨å†Œå¤±è´¥: ç”¨æˆ·å–æ¶ˆæˆ– FaceID éªŒè¯æœªé€šè¿‡ã€‚");
        }
    }

    // [æ¨¡æ‹Ÿ] ç™»å½•æµç¨‹
    async function handleLogin() {
        const user = document.getElementById('username').value;
        if (!user) return alert("è¯·è¾“å…¥è´¦æˆ· ID");

        // æ­¥éª¤ A: å‡†å¤‡éªŒè¯ FaceID
        const challenge = new Uint8Array(32);
        window.crypto.getRandomValues(challenge);

        // æŸ¥æ‰¾æœ¬åœ°æ˜¯å¦æœ‰è¿™ä¸ª Credential ID (çœŸå®ç¯å¢ƒä»æœåŠ¡å™¨æŸ¥)
        const storedCredId = localStorage.getItem('phoenix_credential_id');
        if(!storedCredId) return alert("è¯¥è®¾å¤‡æœªæ‰¾åˆ°æ­¤è´¦æˆ·çš„ FaceID è®°å½•");

        const allowCredentials = [{
            type: "public-key",
            id: Uint8Array.from(atob(storedCredId), c => c.charCodeAt(0)),
            transports: ["internal"]
        }];

        const publicKeyCredentialRequestOptions = {
            challenge: challenge,
            allowCredentials: allowCredentials,
            userVerification: "required" // å¼ºåˆ¶åˆ·è„¸
        };

        try {
            // æ­¥éª¤ B: å”¤èµ· FaceID éªŒè¯
            const assertion = await navigator.credentials.get({
                publicKey: publicKeyCredentialRequestOptions
            });

            console.log("FaceID éªŒè¯é€šè¿‡:", assertion);
            alert(`ğŸ”“ ç™»å½•æˆåŠŸ\n\næ¬¢è¿å›æ¥, ${user}`);
            
            // TODO: è·³è½¬åˆ°ä¸‹ä¸€æ­¥
            
        } catch (err) {
            console.error(err);
            alert("âŒ éªŒè¯å¤±è´¥: è¯·ç¡®ä¿æ˜¯æœ¬äººæ“ä½œã€‚");
        }
    }
</script>

</body>
</html>
