<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Relic Phoenix V4.5</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <style>body{background:#000;color:#0f0;font-family:monospace;padding:20px}input,textarea,button{width:100%;background:#111;border:1px solid #333;color:#fff;padding:10px;margin:5px 0}</style>
</head>
<body>
    <h2>RELIC PHOENIX SYSTEM</h2>
    <div id="app">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login / Signup</button>
        <div id="dash" style="display:none;margin-top:20px;">
            <textarea id="secret" rows="4" placeholder="SECRET DATA"></textarea>
            <input type="email" id="ben" placeholder="Beneficiary Email">
            <input type="number" id="time" placeholder="Minutes to timeout" value="1">
            <button onclick="deploy()">ENCRYPT & DEPLOY</button>
        </div>
        <div id="decrypt" style="display:none;border:1px solid red;padding:10px;margin-top:20px;"></div>
    </div>

<script>
    const DB_URL = 'https://uudlauufdnrdcztlesvr.supabase.co'; 
    const DB_KEY = 'sb_publishable_KtfqCfLqUd_AtLj0Nb2WKQ_aPbsHjus'; 
    
    // ðŸ‘‡ðŸ‘‡ðŸ‘‡ å¿…é¡»æ¢æˆæ‚¨åˆšæ‰ç”Ÿæˆçš„å…¬é’¥ ðŸ‘‡ðŸ‘‡ðŸ‘‡
    const WATCHDOG_PUBLIC_KEY = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAviA23JxW181JM9cbwClQ
x7+KP+rmhFJ2RF30z1OAjvWngczIYYRT4EGjx74OLqP3leYXME+4ZKZIqt6v8jf1
trELXELa5khEOwWHj2EbOnhPdbk7aJ3Du/RmkZAu/gSVKHiWAeVPdmZuEDRP8wV1
gIYQsnXW+gNTt0SPKdheSkWTiksSImiJlzV3HC9AS/ucx/GfAhxnLLQ67ZhRE+Ub
ytBiBV+RfQX9P0oWbsESOD+FtiJfvKO74jA9naWsmG7hMmhotH1O1oC3YWFYvpNi
RYytkgByTOHBmtFqUVa1jIAJGdAZ8g1jMhZOOte5NfjJ4fJQhmqzdHBlH2xU/14A
pQIDAQAB
-----END PUBLIC KEY-----`;

    const client = window.supabase.createClient(DB_URL, DB_KEY);
    
    window.onload = async () => {
        if(location.hash.includes("key=")){
            // è§£å¯†æ¨¡å¼
            const key = location.hash.split("key=")[1].split("&")[0];
            const id = location.hash.split("id=")[1].split("&")[0];
            const {data} = await client.from("vaults").select("*").eq("id", id).single();
            try {
                const text = CryptoJS.AES.decrypt(data.encrypted_data, key).toString(CryptoJS.enc.Utf8);
                document.getElementById("decrypt").style.display="block";
                document.getElementById("decrypt").innerText = "DECRYPTED: " + text;
                client.from("vaults").update({status:'reading'}).eq('id',id);
            } catch(e){ alert("Key Error"); }
        }
    };

    async function login() {
        const {data, error} = await client.auth.signInWithPassword({email:email.value, password:password.value});
        if(error) await client.auth.signUp({email:email.value, password:password.value});
        document.getElementById("dash").style.display="block";
    }

    async function deploy() {
        const aesKey = Array.from(crypto.getRandomValues(new Uint8Array(32)), b=>b.toString(16).padStart(2,'0')).join('');
        const encryptedData = CryptoJS.AES.encrypt(secret.value, aesKey).toString();
        
        const encryptor = new JSEncrypt();
        encryptor.setPublicKey(WATCHDOG_PUBLIC_KEY);
        const wrappedKey = encryptor.encrypt(aesKey);

        if(!wrappedKey) return alert("Public Key Error!");

        const user = (await client.auth.getUser()).data.user;
        await client.from("vaults").upsert({
            id: user.id,
            encrypted_data: encryptedData,
            key_storage: wrappedKey,
            beneficiary_email: ben.value,
            timeout_minutes: time.value,
            status: 'active',
            last_checkin_at: new Date()
        });
        alert("System Armed.");
    }
</script></body></html>

