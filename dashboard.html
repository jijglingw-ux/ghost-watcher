<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—ç‰© | å®ˆæœ›è€…</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="é—ç‰©å®ˆæœ›">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192x192/0c0c0c/d4c5a9?text=R">

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* --- GHOST WATCHER GENESIS (æ–‡æœ¬æœ€ç»ˆç‰ˆ) --- */
        :root { --bg: #0c0c0c; --card: #141414; --text: #8a8a8a; --accent: #d4c5a9; --border: #333; --danger: #6e2e2e; --safe: #162b20; --warn: #5c402b; }
        body { background: var(--bg); color: var(--text); font-family: "Songti SC", serif; display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; min-height: 100vh; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* é€‚é… iPhone é¡¶éƒ¨åˆ˜æµ· */
        @supports (-webkit-touch-callout: none) { body { padding-top: max(15px, env(safe-area-inset-top)); } }

        .box { width: 100%; max-width: 500px; background: var(--card); padding: 25px 20px; border: 1px solid var(--border); box-shadow: 0 0 20px rgba(0,0,0,0.9); margin-bottom: 20px; box-sizing: border-box; }
        h3 { margin: 0 0 15px 0; border-bottom: 1px solid var(--border); padding-bottom: 15px; font-size: 20px; color: var(--accent); letter-spacing: 6px; text-align: center; }
        
        input, textarea, select { 
            width: 100%; margin-bottom: 15px; padding: 14px; 
            background: #0c0c0c; border: 1px solid var(--border); 
            color: var(--accent); box-sizing: border-box; border-radius: 0; 
            font-family: "FangSong", monospace; font-size: 16px; outline: none; 
            -webkit-appearance: none; appearance: none;
        }
        input:focus, textarea:focus, select:focus { border-color: #5c5c5c; }
        
        /* é”å®šçŠ¶æ€æ ·å¼ */
        input:disabled, select:disabled, textarea:disabled { 
            opacity: 0.7; background: #080808; color: #555; 
            cursor: not-allowed; border-color: #222; border-style: dashed;
        }
        
        label { display: block; margin-bottom: 8px; color: #555; font-size: 14px; font-weight: bold; }
        button { width: 100%; padding: 16px; cursor: pointer; border: 1px solid var(--border); background: transparent; color: #888; margin-top: 10px; font-size: 16px; letter-spacing: 2px; }
        .btn-primary { background: #1f1f1f; color: var(--accent); border-color: #444; }
        .btn-heartbeat { background: #1c261e; color: #4a7a52; border: 1px solid #28382b; margin-top: 25px; font-weight: bold; }
        .hidden { display: none; }
        
        .row { display: flex; gap: 10px; align-items: flex-start; } 
        .row > div { flex: 1; min-width: 0; } 
        .row label { font-size: 12px; text-align: center; white-space: nowrap; }
        
        .input-group { display: flex; border: 1px solid var(--border); background: #0c0c0c; }
        .input-group input { border: none; margin-bottom: 0; flex: 1; text-align: center; border-right: 1px solid var(--border); min-width: 0; }
        .input-group select { border: none; margin-bottom: 0; width: 50px; text-align: center; padding: 0 5px; background: #1a1a1a; cursor: pointer; color: #888; }
        .input-group.error { border-color: var(--danger); }
        .input-group.disabled { background: #080808; border-color: #222; border-style: dashed; }
        .input-group.disabled input, .input-group.disabled select { background: transparent; color: #555; }

        .checkbox-wrapper { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; font-size: 14px; color: #888; cursor: pointer; padding: 8px 0; user-select: none; }
        .checkbox-wrapper input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .checkmark { height: 16px; width: 16px; background-color: transparent; border: 1px solid #666; display: inline-block; position: relative; }
        .checkbox-wrapper input:checked ~ .checkmark { border-color: var(--accent); background-color: rgba(212, 197, 169, 0.1); }
        .checkbox-wrapper input:checked ~ .checkmark:after { content: ""; position: absolute; left: 5px; top: 1px; width: 4px; height: 9px; border: solid var(--accent); border-width: 0 2px 2px 0; transform: rotate(45deg); }
        
        /* Timeline */
        .timeline-container { position: relative; height: 80px; background: #0c0c0c; border: 1px solid #222; margin-top: 15px; display: none; align-items: center; justify-content: center; overflow:hidden;}
        .logic-error-overlay { position: absolute; inset: 0; background: rgba(10, 5, 5, 0.95); color: #8a3b3b; display: none; flex-direction: column; align-items: center; justify-content: center; font-size: 13px; z-index: 20; text-align: center; padding: 10px; border: 1px solid #8a3b3b; }
        .life-fill { height: 100%; background: rgba(100, 100, 100, 0.1); width: 0%; position: absolute; left: 0; top: 0; border-right: 2px solid #555; transition: width 1s linear; z-index: 1; }
        .life-fill.preview { background: rgba(212, 197, 169, 0.05); border-right: 2px solid var(--accent); width: 100% !important; transition: none; } 
        .trigger-line { position: absolute; top: 0; bottom: 0; width: 1px; background: rgba(255,255,255,0.1); z-index: 2; pointer-events: none; }
        .trigger-info { position: absolute; top: 5px; font-size: 10px; color: #444; transform: translateX(3px); z-index: 3; border-left: 1px solid #333; padding-left: 4px; pointer-events: none; font-family: "FangSong"; }
        .death-marker { position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: #5c2b2b; z-index: 4; display: none; } 
        .death-label { position: absolute; left: 6px; bottom: 6px; color: #5c2b2b; font-size: 11px; font-weight: bold; z-index: 4; display: none; }
        #real-left-time { font-family: "FangSong", monospace; font-size: 20px; font-weight: bold; color: #666; }
        #real-left-time.danger { color: #8a6d3b; } #real-left-time.dead { color: #6e2e2e; }
        
        .swal2-popup { background: #141414 !important; border: 1px solid #333; color: #999 !important; border-radius: 0 !important; width: 90% !important; }
        .swal2-title { color: var(--accent) !important; font-family: "Songti SC"; }
        .swal2-confirm { background: #333 !important; color: #ccc !important; border: 1px solid #444 !important; }
        
        .locked-tip { font-size: 12px; color: #555; text-align: center; margin-bottom: 10px; font-style: italic; display: none; }
        .lock-icon { margin-right: 5px; }
    </style>
</head>
<body>

<div class="box" id="auth-box">
    <h3>èº«ä»½é‰´æƒ</h3>
    <input type="email" id="u_email" placeholder="é‚®ç®±ï¼ˆæ¡£æ¡ˆIDï¼‰">
    <input type="password" id="u_pw" placeholder="å¯†ç ï¼ˆé€šè¡Œå¯†é’¥ï¼‰">
    <button id="loginBtn" class="btn-primary">ç™»å½•ï¼ˆè°ƒå–æ¡£æ¡ˆï¼‰</button>
    <button id="regBtn" class="btn-secondary">æ³¨å†Œï¼ˆæ–°å»ºæ¡£æ¡ˆï¼‰</button>
</div>

<div class="box hidden" id="main-box">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">
        <span style="font-size:12px; color:#555; font-family:'FangSong';" id="header-user-email">--</span>
        <span style="font-size:12px; color:#d4c5a9; cursor:pointer;" onclick="doLogout()">[ é€€å‡º ]</span>
    </div>

    <h3>é— ç‰©</h3>
    <div class="locked-tip" id="locked-status">
        <span class="lock-icon">ğŸ”’</span> å¥‘çº¦å·²ç”Ÿæ•ˆ | è§„åˆ™å·²å›ºåŒ– | ä»…å…è®¸è¿½åŠ é“­æ–‡
    </div>
    
    <label>é“­æ–‡ / å˜±æ‰˜ï¼š</label>
    <textarea id="u_secret" rows="5" placeholder="åœ¨è¿™é‡Œåˆ»å½•ä¸‹æ–°çš„å˜±æ‰˜...&#10;ï¼ˆæ³¨ï¼šæ¯ä¸€æ¬¡åˆ»å½•éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚æ—§çš„é“­æ–‡å·²æ°¸ä¹…å°å­˜ï¼Œæ–°çš„å†…å®¹å°†è¿½åŠ åœ¨åé¢ã€‚ï¼‰"></textarea>
    
    <div style="height:1px; background:#222; margin: 20px 0;"></div>
    <label>äº¤ä»˜å¯¹è±¡ï¼š</label>
    <label class="checkbox-wrapper">
        <input type="checkbox" id="sameAsMe" onchange="toggleSelfEmail()">
        <span class="checkmark"></span><span>å‘è‡ªå·±å‘é€å”¤é†’</span>
    </label>
    <input type="email" id="u_warn_email" placeholder="å”¤é†’æ¥æ”¶é‚®ç®±">
    <input type="email" id="u_ben" placeholder="é—ç‰©æ¥æ”¶é‚®ç®± (å”¯ä¸€è§£å¯†é’¥åŒ™)">

    <div style="height:1px; background:#222; margin: 20px 0;"></div>
    
    <label>é—è¨€å‘å‡ºå€’è®¡æ—¶ï¼š</label>
    <div class="row">
        <div>
            <label>å­˜åœ¨æ—¶é—´</label>
            <div class="input-group" id="grp_timeout">
                <input type="number" id="u_timeout_val" placeholder="0">
                <select id="u_timeout_unit">
                    <option value="1">åˆ†</option>
                    <option value="60">æ—¶</option>
                    <option value="1440">å¤©</option>
                    <option value="43200">æœˆ</option>
                    <option value="525600">å¹´</option>
                </select>
            </div>
        </div>
        
        <div>
            <label>å”¤é†’æ¬¡æ•°</label>
            <div class="input-group" id="grp_warns">
                <input type="number" id="u_max_warns" placeholder="0" style="border-right:none;">
            </div>
        </div>
        
        <div>
            <label>å”¤é†’é—´éš”</label>
            <div class="input-group" id="grp_interval">
                <input type="number" id="u_interval_val" placeholder="0">
                <select id="u_interval_unit">
                    <option value="1">åˆ†</option>
                    <option value="60">æ—¶</option>
                    <option value="1440">å¤©</option>
                    <option value="43200">æœˆ</option>
                    <option value="525600">å¹´</option>
                </select>
            </div>
        </div>
    </div>

    <div class="timeline-container" id="timeline-box">
        <div class="death-marker" id="d-mark"></div>
        <div class="death-label" id="d-lbl">é—ç‰©</div>
        <div class="life-fill" id="life-fill"></div>
        <div class="empty-tip" id="empty-tip">ç­‰å¾…æ•°æ®åˆ»å½•...</div>
        <div class="logic-error-overlay" id="logic-error"><div id="logic-error-msg"></div></div>
    </div>
    <div style="text-align:right; font-size:12px; color:#444; margin-top:15px;">å‰©ä½™: <span id="real-left-time">--:--</span></div>

    <button id="saveBtn">å°å­˜é—ç‰©ï¼ˆå¼€å¯å®ˆæœ›ï¼‰</button>
    <button id="heartBtn" class="btn-heartbeat">æˆ‘ä»æ˜¯ç”Ÿè€…</button>

    <div style="height:1px; background:#222; margin: 40px 0 20px 0;"></div>
    <h3>å‘æ˜ / è§£å¯†</h3>
    <p style="font-size:12px; color:#555; margin-bottom:10px; border:1px dashed #333; padding:10px; text-align:left; line-height: 1.6;">
        <strong style="color:#d4c5a9;">è‡´ å—ç›Šäººï¼š</strong><br>
        å¦‚æœæ‚¨æ”¶åˆ°äº†æå–ç ï¼Œè¯·åœ¨æ­¤å¤„æ“ä½œã€‚<br>
        1. ç¡®ä¿æ‚¨å½“å‰ç™»å½•çš„é‚®ç®±ï¼Œæ˜¯é‚®ä»¶ä¸­æŒ‡å®šçš„<span style="color:#d4c5a9;">æ¥æ”¶é‚®ç®±</span>ã€‚<br>
        2. å°†é‚®ä»¶ä¸­çš„ <span style="color:#d4c5a9;">æå–ç </span> å®Œæ•´ç²˜è´´åˆ°ä¸‹æ–¹ã€‚<br>
        3. ç‚¹å‡»æå–ã€‚è§£å¯†åå°†å¯åŠ¨ <span style="color:#6e2e2e;">30åˆ†é’Ÿè‡ªæ¯å€’è®¡æ—¶</span>ï¼Œè¯·æŠ“ç´§é˜…è¯»æˆ–ä¿å­˜ã€‚
    </p>
    <div style="margin-bottom:10px; font-size:12px; color:#555; text-align:center;">
        å½“å‰éªŒè¯èº«ä»½ï¼š<span id="current-user-email" style="color:#d4c5a9; font-weight:bold;">--</span>
    </div>
    <textarea id="de_input" rows="2" placeholder="åœ¨æ­¤ç²˜è´´æå–ç  (RELIC::...)"></textarea>
    <button onclick="handleDecrypt()" class="btn-secondary" style="margin-top:0;">å¼€å§‹è§£å¯†</button>
    <div id="de_output" class="hidden" style="margin-top:20px; color:#d4c5a9; word-break:break-all; padding:20px; background:#0c0c0c; border:1px solid #333; font-size:15px; font-family: 'FangSong';"></div>
</div>

<script>
    const DB_URL = 'https://uudlauufdnrdcztlesvr.supabase.co';
    const DB_KEY = 'sb_publishable_KtfqCfLqUd_AtLj0Nb2WKQ_aPbsHjus'; 
    const client = window.supabase.createClient(DB_URL, DB_KEY);
    let sessionUser = null;
    let globalLastCheckin = new Date();
    let isEditing = false;
    let timerInterval = null;
    let statusWatcher = null; 
    let isSealed = false; 
    let existingEncryptedData = ""; 

    function startStatusWatcher() {
        if (statusWatcher) clearInterval(statusWatcher);
        statusWatcher = setInterval(async () => {
            if (!sessionUser) return;
            const { data, error } = await client.from('vaults').select('status').eq('id', sessionUser.id).maybeSingle();
            
            if (data && data.status !== 'active') {
                clearInterval(statusWatcher);
                clearInterval(timerInterval);
                isEditing = false;
                await client.auth.signOut(); 
                Swal.fire({
                    icon: 'warning',
                    title: 'ä¿¡å·ä¸­æ–­',
                    html: '<span style="color:#888">ç³»ç»Ÿç›‘æµ‹åˆ°æ‚¨çš„é—è¨€é‚®ä»¶å·²å‘å‡ºã€‚<br>æ ¹æ®åè®®ï¼Œæ‚¨çš„ç”Ÿè€…æƒé™å·²ç»ˆæ­¢ã€‚</span>',
                    background: '#141414',
                    color: '#d4c5a9',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    confirmButtonText: 'é€€å‡º'
                }).then(() => { location.reload(); });
            }
        }, 5000); 
    }

    function getMinutes(valId, unitId) {
        const val = parseFloat(document.getElementById(valId).value) || 0;
        const unit = parseInt(document.getElementById(unitId).value) || 1;
        return val * unit;
    }

    function setSmartUnit(valId, unitId, totalMinutes) {
        const units = [525600, 43200, 1440, 60, 1];
        let selectedUnit = 1;
        for (let u of units) {
            if (totalMinutes >= u && totalMinutes % u === 0) {
                selectedUnit = u;
                break;
            }
        }
        document.getElementById(unitId).value = selectedUnit;
        document.getElementById(valId).value = totalMinutes / selectedUnit;
    }

    document.getElementById('loginBtn').onclick = async () => {
        const { data, error } = await client.auth.signInWithPassword({ email: u_email.value, password: u_pw.value });
        if (error) return Swal.fire({icon:'error', title:'é”™è¯¯', text: 'è´¦å·æˆ–å¯†ç é”™è¯¯', background:'#141414', color:'#ccc'});
        
        const user = data.user;
        const { data: v } = await client.from('vaults').select('status').eq('id', user.id).single();
        if (v && v.status !== 'active') {
            await client.auth.signOut();
            return Swal.fire({icon: 'error', title: 'èº«ä»½å·²é”€æ¯', html: '<span style="color:#888">ç³»ç»Ÿè®°å½•æ˜¾ç¤ºè¯¥æ¡£æ¡ˆæŒæœ‰è€…å·²ç¡®è®¤å¤±è”ã€‚<br>é—ç‰©ç§»äº¤ç¨‹åºå·²å¯åŠ¨ï¼ŒåŸè´¦å·è®¿é—®æƒé™å·²æ°¸ä¹…ç§»é™¤ã€‚</span>', background: '#141414', color: '#6e2e2e', confirmButtonText: 'ç¦»å¼€'});
        }
        sessionUser = user;
        document.getElementById('auth-box').classList.add('hidden');
        document.getElementById('main-box').classList.remove('hidden');
        refreshData();
    };

    function encryptData(text, targetEmail) {
        if (!text || !targetEmail) return null;
        const autoKey = "IDENTITY_LOCK::" + targetEmail.trim().toLowerCase(); 
        return "AES::" + CryptoJS.AES.encrypt(text, autoKey).toString();
    }

    function decryptData(ciphertext, currentUserEmail) {
        if (!ciphertext.startsWith("AES::")) return null;
        const autoKey = "IDENTITY_LOCK::" + currentUserEmail.trim().toLowerCase();
        try {
            const bytes = CryptoJS.AES.decrypt(ciphertext.replace("AES::", ""), autoKey);
            const originalText = bytes.toString(CryptoJS.enc.Utf8);
            return originalText || null;
        } catch (e) { return null; }
    }

    function translateError(msg) {
        if (!msg) return "æœªçŸ¥é”™è¯¯";
        if (msg.includes("User already registered")) return "è¯¥èº«ä»½æ¡£æ¡ˆå·²å­˜åœ¨ï¼Œè¯·ç›´æ¥â€œç™»å½•ï¼ˆè°ƒå–æ¡£æ¡ˆï¼‰â€ã€‚";
        if (msg.includes("Signup requires a valid password")) return "å»ºæ¡£å¤±è´¥ï¼šè¯·è®¾ç½®æœ‰æ•ˆçš„å¯†ç ï¼ˆé€šè¡Œå¯†é’¥ï¼‰ã€‚";
        return "ç³»ç»Ÿå¼‚å¸¸ï¼š" + msg;
    }

    async function handleDecrypt() {
        if (!sessionUser) return;
        let raw = document.getElementById('de_input').value.trim();
        if (!raw) return Swal.fire({icon:'warning', title:'æ— å†…å®¹', text:'è¯·ç²˜è´´æå–ç ', background:'#141414', color:'#ccc'});
        
        if (raw.startsWith("RELIC::")) {
            const targetId = raw.replace("RELIC::", "").trim();
            const { data, error } = await client.from('vaults').select('encrypted_data, beneficiary_email, status, last_checkin_at').eq('id', targetId).maybeSingle();
            
            if (!data) return Swal.fire({icon:'error', title:'ä¸å­˜åœ¨', text:'è¯¥é—ç‰©å·²è¶…è¿‡æ—¶é™è¢«æ°¸ä¹…é”€æ¯ï¼Œæˆ–æå–ç é”™è¯¯ã€‚', background:'#141414', color:'#6e2e2e'});
            
            if (data.status === 'pending') {
                await client.from('vaults').update({ status: 'reading', last_checkin_at: new Date().toISOString() }).eq('id', targetId);
                Swal.fire({icon:'warning', title:'è‡ªæ¯ç¨‹åºå¯åŠ¨', text:'é—è¨€å·²è§£å°ã€‚æ•°æ®å°†åœ¨ 30åˆ†é’Ÿ åç‰©ç†é”€æ¯ã€‚', background:'#141414', color:'#d4c5a9', confirmButtonText:'æŸ¥çœ‹çœŸç›¸'});
            } else if (data.status === 'reading') {
                const passed = (new Date() - new Date(data.last_checkin_at)) / 60000;
                if (passed > 30) return Swal.fire({icon:'error', title:'å·²é”€æ¯', text:'æ—¶é—´å·²åˆ°ï¼Œé—ç‰©å·²éšé£è€Œé€ã€‚', background:'#141414', color:'#6e2e2e'});
                Swal.fire({icon:'info', title:'å€’è®¡æ—¶ä¸­', text: `å‰©ä½™çº¦ ${Math.ceil(30 - passed)} åˆ†é’Ÿã€‚`, background:'#141414', color:'#ccc', timer: 2000, showConfirmButton:false});
            }
            raw = data.encrypted_data;
        }

        // --- æ”¯æŒå¤šæ®µé—è¨€çš„è§£å¯†é€»è¾‘ ---
        if (raw.includes("|AES::")) {
            const parts = raw.split("|");
            let fullText = "";
            let idx = 1;
            for (let part of parts) {
                const dec = decryptData(part, sessionUser.email);
                if (dec) {
                    if (fullText) fullText += "\n\n------------------------\n\n";
                    fullText += `ã€è®°å½• ${idx}ã€‘\n` + dec;
                    idx++;
                } else {
                    fullText = null; break; // åªè¦æœ‰ä¸€æ®µè§£ä¸å¼€ï¼Œå°±è§†ä¸ºå¤±è´¥
                }
            }
            if (fullText) {
                document.getElementById('de_output').innerText = fullText;
                document.getElementById('de_output').classList.remove('hidden');
                return;
            }
        } else {
            const result = decryptData(raw, sessionUser.email);
            if (result) {
                document.getElementById('de_output').innerText = result;
                document.getElementById('de_output').classList.remove('hidden');
                return;
            }
        }
        
        Swal.fire({icon:'error', title:'æ‹’ç»è®¿é—®', text:'æ‚¨çš„ç™»å½•é‚®ç®±['+sessionUser.email+']ä¸æ­¤é—ç‰©çš„æŒ‡å®šç»§æ‰¿äººä¸ç¬¦ã€‚', background:'#141414', color:'#6e2e2e'});
    }

    function toggleSelfEmail() {
        const cb = document.getElementById('sameAsMe');
        const input = document.getElementById('u_warn_email');
        if (cb.checked && sessionUser) { input.value = sessionUser.email; input.readOnly = true; } 
        else { input.readOnly = false; }
    }

    ['u_timeout_val', 'u_timeout_unit', 'u_max_warns', 'u_interval_val', 'u_interval_unit'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => { if(!isSealed){ isEditing = true; validateAndRender(); }});
    });

    function validateAndRender() {
        const total = getMinutes('u_timeout_val', 'u_timeout_unit');
        const interval = getMinutes('u_interval_val', 'u_interval_unit');
        const count = parseInt(document.getElementById('u_max_warns').value) || 0;
        
        const saveBtn = document.getElementById('saveBtn');
        const box = document.getElementById('timeline-box');
        const fill = document.getElementById('life-fill');
        const errorOverlay = document.getElementById('logic-error');
        const grpTimeout = document.getElementById('grp_timeout');
        const grpWarns = document.getElementById('grp_warns');
        const grpInterval = document.getElementById('grp_interval');
        
        [grpTimeout, grpWarns, grpInterval].forEach(el => el.classList.remove('error'));
        // è¿½åŠ æ¨¡å¼ä¸‹ï¼Œä¸å› ä¸ºè¾“å…¥å˜åŒ–è€Œç¦ç”¨æŒ‰é’®ï¼Œä½†ä¼šå› ä¸ºå°å­˜é€»è¾‘æ”¹å˜æŒ‰é’®åŠŸèƒ½
        if (!isSealed) {
            saveBtn.disabled = false; saveBtn.innerText = "å°å­˜é—ç‰©ï¼ˆå¼€å¯å®ˆæœ›ï¼‰"; 
        }
        errorOverlay.style.display = 'none';
        
        if (!total || !count || !interval) {
            if (total || count || interval) { box.style.display = 'flex'; document.getElementById('empty-tip').style.display = 'block'; fill.style.display = 'none'; }
            else { box.style.display = 'none'; }
            return;
        }

        const span = count * interval;
        if (span >= total) {
            if (!isSealed) {
                saveBtn.disabled = true;
                saveBtn.innerText = "æ— æ³•å°å­˜";
            }
            [grpTimeout, grpWarns, grpInterval].forEach(el => el.classList.add('error'));
            box.style.display = 'flex'; document.getElementById('empty-tip').style.display = 'none';
            errorOverlay.style.display = 'flex';
            document.getElementById('logic-error-msg').innerText = `å”¤é†’è·¨åº¦ (${span}åˆ†) > å­˜åœ¨æ—¶é—´ (${total}åˆ†)`;
            return;
        }

        box.style.display = 'flex';
        document.getElementById('empty-tip').style.display = 'none';
        document.getElementById('d-mark').style.display = 'block'; document.getElementById('d-lbl').style.display = 'block';
        fill.style.display = 'block';
        box.querySelectorAll('.trigger-line, .trigger-info').forEach(el => el.remove());
        
        if (isEditing && !isSealed) { fill.className = 'life-fill preview'; fill.style.width = '100%'; document.getElementById('real-left-time').innerText = "é¢„è§ˆæ¨¡å¼"; }

        for (let i = 1; i <= count; i++) {
            const minsLeft = i * interval;
            const posPercent = (minsLeft / total) * 100;
            const line = document.createElement('div'); line.className = 'trigger-line'; line.style.left = posPercent + '%';
            box.appendChild(line);
            const info = document.createElement('div'); info.className = 'trigger-info'; info.style.left = posPercent + '%';
            let label = `${minsLeft}m`;
            if(minsLeft>=1440) label = `${(minsLeft/1440).toFixed(1)}d`;
            info.innerHTML = `å”¤-${count-i+1}<br>${label}`; box.appendChild(info);
        }
    }

    document.getElementById('saveBtn').onclick = async () => {
        const secret = document.getElementById('u_secret').value;
        const benEmail = document.getElementById('u_ben').value;
        
        if (!secret) return Swal.fire({icon:'warning', title:'ç©ºæ•°æ®', text:'è¯·å¡«å†™å†…å®¹', background:'#141414', color:'#ccc'});

        // 1. è¿½åŠ æ¨¡å¼
        if (isSealed) {
            const newEncrypted = encryptData(secret, benEmail);
            const finalData = existingEncryptedData ? (existingEncryptedData + "|" + newEncrypted) : newEncrypted;
            
            const { error } = await client.from('vaults').update({
                encrypted_data: finalData,
                last_checkin_at: new Date() 
            }).eq('id', sessionUser.id);
            
            if (error) Swal.fire({icon:'error', title:'å¤±è´¥', text: translateError(error.message), background:'#141414', color:'#ccc'});
            else {
                existingEncryptedData = finalData; 
                document.getElementById('u_secret').value = ""; 
                Swal.fire({icon:'success', title:'å·²è¿½åŠ ', text:'æ–°çš„å˜±æ‰˜å·²èå…¥é—ç‰©ï¼Œç­‰å¾…å¼€å¯ã€‚', background:'#141414', color:'#d4c5a9'});
            }
            return;
        }

        // 2. åˆæ¬¡å°å­˜æ¨¡å¼
        const total = getMinutes('u_timeout_val', 'u_timeout_unit');
        const interval = getMinutes('u_interval_val', 'u_interval_unit');
        const count = parseInt(document.getElementById('u_max_warns').value);

        if (!benEmail) return Swal.fire({icon:'warning', title:'ç¼ºå¤±', text:'å¿…é¡»æŒ‡å®šé—ç‰©æ¥æ”¶é‚®ç®±', background:'#141414', color:'#ccc'});
        if (count * interval >= total) return Swal.fire({icon:'error', title:'æ‚–è®º', text:'å”¤é†’æ—¶é—´ > æ€»æ—¶é•¿', background:'#141414', color:'#ccc'});
        
        const encrypted = encryptData(secret, benEmail);
        globalLastCheckin = new Date(); 
        const { error } = await client.from('vaults').upsert({
            id: sessionUser.id, encrypted_data: encrypted, beneficiary_email: benEmail,
            warning_email: document.getElementById('u_warn_email').value,
            timeout_minutes: total, max_warnings: count, warning_interval: interval, 
            status: 'active', current_warnings: 0, last_checkin_at: globalLastCheckin
        });
        if (error) Swal.fire({icon:'error', title:'å¤±è´¥', text: translateError(error.message), background:'#141414', color:'#ccc'});
        else { 
            Swal.fire({icon:'success', title:'å·²å°å­˜', text:'é—è¨€å·²é”å®šã€‚ä¸å¯æ’¤é”€ï¼Œä¸å¯ä¿®æ”¹è§„åˆ™ã€‚', background:'#141414', color:'#d4c5a9'}); 
            isEditing = false; 
            refreshData(); 
        }
    };

    document.getElementById('heartBtn').onclick = async () => {
        globalLastCheckin = new Date();
        isEditing = false; validateAndRender(); startTimer();
        client.from('vaults').update({ last_checkin_at: new Date(), current_warnings: 0, status: 'active' }).eq('id', sessionUser.id);
        Swal.fire({icon:'success', title:'å­˜ç»­', text:'æ—¶é—´é‡ç½®', background:'#141414', color:'#d4c5a9', timer:1000, showConfirmButton:false});
    };

    async function refreshData() {
        if (!sessionUser) return;
        document.getElementById('header-user-email').innerText = sessionUser.email;
        document.getElementById('current-user-email').innerText = sessionUser.email;
        const { data: v } = await client.from('vaults').select('*').eq('id', sessionUser.id).single();
        
        if (v && v.status !== 'active') { await client.auth.signOut(); location.reload(); return; }

        if (v) {
            // --- é”å®šé€»è¾‘ ---
            isSealed = true;
            existingEncryptedData = v.encrypted_data; 
            
            const idsToLock = ['u_timeout_val', 'u_timeout_unit', 'u_max_warns', 'u_interval_val', 'u_interval_unit', 'u_warn_email', 'u_ben', 'sameAsMe'];
            idsToLock.forEach(id => document.getElementById(id).disabled = true);
            
            document.querySelectorAll('.input-group').forEach(el => el.classList.add('disabled'));
            document.getElementById('locked-status').style.display = 'block';
            document.getElementById('saveBtn').innerText = "è¿½åŠ ä¸€æ®µé“­æ–‡ (ä¸å¯ä¿®æ”¹æ—§æ–‡)";
            
            globalLastCheckin = new Date(v.last_checkin_at);
            setSmartUnit('u_timeout_val', 'u_timeout_unit', v.timeout_minutes);
            setSmartUnit('u_interval_val', 'u_interval_unit', v.warning_interval);
            document.getElementById('u_max_warns').value = v.max_warnings;
            document.getElementById('u_warn_email').value = v.warning_email||'';
            document.getElementById('u_ben').value = v.beneficiary_email||'';
            if(v.warning_email===sessionUser.email) { document.getElementById('sameAsMe').checked=true; }
            
            document.getElementById('u_secret').value = ""; 
            document.getElementById('u_secret').placeholder = "ï¼ˆæ—§å†…å®¹å·²å°å­˜ã€‚åœ¨æ­¤è¾“å…¥æ–°çš„å˜±æ‰˜ï¼Œå°†è¿½åŠ åˆ°é—ç‰©æœ«å°¾...ï¼‰"; 
            
            isEditing = false; 
            validateAndRender(); 
            startTimer();
            startStatusWatcher();
        } else {
            isSealed = false;
        }
    }
    
    document.getElementById('regBtn').onclick = async () => {
        const { error } = await client.auth.signUp({ email: u_email.value, password: u_pw.value });
        if (error) Swal.fire({icon:'error', title:'å¤±è´¥', text: translateError(error.message), background:'#141414', color:'#ccc'});
        else Swal.fire({icon:'success', title:'æˆåŠŸ', text:'å·²å»ºæ¡£ï¼Œè¯·è°ƒå–ã€‚', background:'#141414', color:'#d4c5a9'});
    };

    window.doLogout = async () => { 
        if (statusWatcher) clearInterval(statusWatcher); 
        await client.auth.signOut(); 
        location.reload(); 
    };

    function startTimer() { 
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => { 
            if (isEditing && !isSealed) return; 
            const totalMins = getMinutes('u_timeout_val', 'u_timeout_unit');
            if(!totalMins) return;
            
            const left = (totalMins*60000)-(new Date()-globalLastCheckin); 
           
            const el = document.getElementById('real-left-time'); 
            const fill = document.getElementById('life-fill'); 
            if (left<=0) { el.innerText="00:00:00 (å·²æˆé—ç‰©)"; el.className="dead"; fill.style.width="0%"; return; } 
            
            const p = (left/(totalMins*60000))*100; 
            fill.style.width=p+"%"; fill.className = "life-fill"; 
            
            const days = Math.floor(left / (1000 * 60 * 60 * 24));
            const hours = Math.floor((left % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((left % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((left % (1000 * 60)) / 1000);
            
            let timeStr = "";
            if(days > 0) timeStr += `${days}å¤© `;
            if(hours > 0 || days > 0) timeStr += `${hours.toString().padStart(2,'0')}:`;
            timeStr += `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            el.innerText = timeStr;
        }, 1000); 
    }
</script>
</body>
</html>
