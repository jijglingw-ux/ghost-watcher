<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>遗物 | 数字墓碑</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* --- V10.1 最终版 UI --- */
        :root { --bg: #0c0c0c; --card: #141414; --text: #8a8a8a; --accent: #d4c5a9; --border: #333; --danger: #6e2e2e; --safe: #162b20; --warn: #5c402b; }
        body { background: var(--bg); color: var(--text); font-family: "Songti SC", serif; display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; min-height: 100vh; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        .box { width: 100%; max-width: 500px; background: var(--card); padding: 25px 20px; border: 1px solid var(--border); box-shadow: 0 0 20px rgba(0,0,0,0.9); margin-bottom: 20px; box-sizing: border-box; }
        h3 { margin: 0 0 15px 0; border-bottom: 1px solid var(--border); padding-bottom: 15px; font-size: 20px; color: var(--accent); letter-spacing: 6px; text-align: center; }
        input, textarea { width: 100%; margin-bottom: 15px; padding: 14px; background: #0c0c0c; border: 1px solid var(--border); color: var(--accent); box-sizing: border-box; border-radius: 0; font-family: "FangSong", monospace; font-size: 16px; outline: none; -webkit-appearance: none; }
        input:focus, textarea:focus { border-color: #5c5c5c; }
        input:read-only { opacity: 0.5; background: #111; color: #666; cursor: not-allowed; border-color: #222; }
        label { display: block; margin-bottom: 8px; color: #555; font-size: 14px; font-weight: bold; }
        button { width: 100%; padding: 16px; cursor: pointer; border: 1px solid var(--border); background: transparent; color: #888; margin-top: 10px; font-size: 16px; letter-spacing: 2px; }
        .btn-primary { background: #1f1f1f; color: var(--accent); border-color: #444; }
        .btn-heartbeat { background: #1c261e; color: #4a7a52; border: 1px solid #28382b; margin-top: 25px; font-weight: bold; }
        .hidden { display: none; }
        .row { display: flex; gap: 10px; } .row div { flex: 1; } .row input { text-align: center; }
        
        /* 复选框 */
        .checkbox-wrapper { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; font-size: 14px; color: #888; cursor: pointer; padding: 8px 0; user-select: none; }
        .checkbox-wrapper input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .checkmark { height: 16px; width: 16px; background-color: transparent; border: 1px solid #666; display: inline-block; position: relative; }
        .checkbox-wrapper input:checked ~ .checkmark { border-color: var(--accent); background-color: rgba(212, 197, 169, 0.1); }
        .checkbox-wrapper input:checked ~ .checkmark:after { content: ""; position: absolute; left: 5px; top: 1px; width: 4px; height: 9px; border: solid var(--accent); border-width: 0 2px 2px 0; transform: rotate(45deg); }

        /* 时间轴 */
        .timeline-container { position: relative; height: 80px; background: #0c0c0c; border: 1px solid #222; margin-top: 15px; display: none; align-items: center; justify-content: center; overflow:hidden;}
        .logic-error-overlay { position: absolute; inset: 0; background: rgba(10, 5, 5, 0.95); color: #8a3b3b; display: none; flex-direction: column; align-items: center; justify-content: center; font-size: 13px; z-index: 20; text-align: center; padding: 10px; border: 1px solid #8a3b3b; }
        .life-fill { height: 100%; background: rgba(100, 100, 100, 0.1); width: 0%; position: absolute; left: 0; top: 0; border-right: 2px solid #555; transition: width 1s linear; z-index: 1; }
        .life-fill.preview { background: rgba(212, 197, 169, 0.05); border-right: 2px solid var(--accent); width: 100% !important; transition: none; } 
        .trigger-line { position: absolute; top: 0; bottom: 0; width: 1px; background: rgba(255,255,255,0.1); z-index: 2; pointer-events: none; }
        .trigger-info { position: absolute; top: 5px; font-size: 10px; color: #444; transform: translateX(3px); z-index: 3; border-left: 1px solid #333; padding-left: 4px; pointer-events: none; font-family: "FangSong"; }
        .death-marker { position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: #5c2b2b; z-index: 4; display: none; } 
        .death-label { position: absolute; left: 6px; bottom: 6px; color: #5c2b2b; font-size: 11px; font-weight: bold; z-index: 4; display: none; }
        #real-left-time { font-family: "FangSong", monospace; font-size: 20px; font-weight: bold; color: #666; }
        #real-left-time.danger { color: #8a6d3b; } #real-left-time.dead { color: #6e2e2e; }
        
        .swal2-popup { background: #141414 !important; border: 1px solid #333; color: #999 !important; border-radius: 0 !important; width: 90% !important; }
        .swal2-title { color: var(--accent) !important; font-family: "Songti SC"; }
        .swal2-confirm { background: #333 !important; color: #ccc !important; border: 1px solid #444 !important; }
    </style>
</head>
<body>

<div class="box" id="auth-box">
    <h3>身份鉴权</h3>
    <input type="email" id="u_email" placeholder="邮箱（档案ID）">
    <input type="password" id="u_pw" placeholder="密码（通行密钥）">
    <button id="loginBtn" class="btn-primary">登录（调取档案）</button>
    <button id="regBtn" class="btn-secondary">注册（新建档案）</button>
</div>

<div class="box hidden" id="main-box">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">
        <span style="font-size:12px; color:#555; font-family:'FangSong';" id="header-user-email">--</span>
        <span style="font-size:12px; color:#d4c5a9; cursor:pointer;" onclick="doLogout()">[ 退出 ]</span>
    </div>

    <h3>遗 物</h3>
    <label>铭文 / 遗言：</label>
    <textarea id="u_secret" rows="5" placeholder="在此刻下尚未成为历史的真相..."></textarea>
    
    <div style="height:1px; background:#222; margin: 20px 0;"></div>
    <label>交付对象：</label>
    <label class="checkbox-wrapper">
        <input type="checkbox" id="sameAsMe" onchange="toggleSelfEmail()">
        <span class="checkmark"></span>
        <span>向自己发送唤醒</span>
    </label>
    <input type="email" id="u_warn_email" placeholder="唤醒接收邮箱">
    <input type="email" id="u_ben" placeholder="遗物接收邮箱 (唯一解密钥匙)">

    <div style="height:1px; background:#222; margin: 20px 0;"></div>
    <label>遗言发出倒计时：</label>
    <div class="row">
        <div><label>存在(分)</label><input type="number" id="u_timeout"></div>
        <div><label>唤醒(次)</label><input type="number" id="u_max_warns"></div>
        <div><label>间隔(分)</label><input type="number" id="u_warn_interval"></div>
    </div>

    <div class="timeline-container" id="timeline-box">
        <div class="death-marker" id="d-mark"></div>
        <div class="death-label" id="d-lbl">遗物</div>
        <div class="life-fill" id="life-fill"></div>
        <div class="empty-tip" id="empty-tip">等待数据刻录...</div>
        <div class="logic-error-overlay" id="logic-error"><div id="logic-error-msg"></div></div>
    </div>
    <div style="text-align:right; font-size:12px; color:#444; margin-top:15px;">剩余: <span id="real-left-time">--:--</span></div>

    <button id="saveBtn">封存遗物</button>
    <button id="heartBtn" class="btn-heartbeat">我仍是生者</button>

    <div style="height:1px; background:#222; margin: 40px 0 20px 0;"></div>
    <h3>发掘</h3>
    <p style="font-size:12px; color:#555; margin-bottom:10px; border:1px dashed #333; padding:10px; text-align:center;">
        当前验证身份：<br><span id="current-user-email" style="color:#d4c5a9; font-weight:bold;">--</span>
    </p>
    <textarea id="de_input" rows="2" placeholder="粘贴提取码 (RELIC::...)"></textarea>
    <button onclick="handleDecrypt()" class="btn-secondary" style="margin-top:0;">提取并解读</button>
    <div id="de_output" class="hidden" style="margin-top:20px; color:#d4c5a9; word-break:break-all; padding:20px; background:#0c0c0c; border:1px solid #333; font-size:15px; font-family: 'FangSong';"></div>
</div>

<script>
    const DB_URL = 'https://uudlauufdnrdcztlesvr.supabase.co';
    const DB_KEY = 'sb_publishable_KtfqCfLqUd_AtLj0Nb2WKQ_aPbsHjus'; 
    const client = window.supabase.createClient(DB_URL, DB_KEY);
    let sessionUser = null;
    let globalLastCheckin = new Date();
    let isEditing = false;
    let timerInterval = null;

    function encryptData(text, targetEmail) {
        if (!text || !targetEmail) return null;
        const autoKey = "IDENTITY_LOCK::" + targetEmail.trim().toLowerCase(); 
        return "AES::" + CryptoJS.AES.encrypt(text, autoKey).toString();
    }

    function decryptData(ciphertext, currentUserEmail) {
        if (!ciphertext.startsWith("AES::")) return null;
        const autoKey = "IDENTITY_LOCK::" + currentUserEmail.trim().toLowerCase();
        try {
            const bytes = CryptoJS.AES.decrypt(ciphertext.replace("AES::", ""), autoKey);
            const originalText = bytes.toString(CryptoJS.enc.Utf8);
            return originalText || null;
        } catch (e) { return null; }
    }

    function translateError(msg) {
        if (!msg) return "未知错误";
        if (msg.includes("User already registered")) return "该身份档案已存在，请直接“登录（调取档案）”。";
        if (msg.includes("Signup requires a valid password")) return "建档失败：请设置有效的密码（通行密钥）。";
        if (msg.includes("Invalid login credentials")) return "鉴权失败：邮箱或密码错误。";
        return "系统异常：" + msg; 
    }

    // --- 核心：阅后即焚逻辑 ---
    async function handleDecrypt() {
        if (!sessionUser) return;
        let raw = document.getElementById('de_input').value.trim();
        if (!raw) return Swal.fire({icon:'warning', title:'无内容', text:'请粘贴提取码', background:'#141414', color:'#ccc'});

        if (raw.startsWith("RELIC::")) {
            const targetId = raw.replace("RELIC::", "").trim();
            // 1. 先查数据
            const { data, error } = await client.from('vaults').select('encrypted_data, beneficiary_email, status, last_checkin_at').eq('id', targetId).maybeSingle();
            
            if (!data) return Swal.fire({icon:'error', title:'无效', text:'该遗物已超过时限被永久销毁，或提取码错误。', background:'#141414', color:'#6e2e2e'});
            
            // 2. 检查状态并触发“开箱”
            if (data.status === 'triggered') {
                // 第一次看！触发30分钟倒计时
                await client.from('vaults').update({ 
                    status: 'unlocked', 
                    last_checkin_at: new Date().toISOString() // 重置时间为现在
                }).eq('id', targetId);
                
                Swal.fire({
                    icon:'warning', title:'自毁程序启动', 
                    text:'遗言已解封。数据将在 30分钟 后物理销毁。', 
                    background:'#141414', color:'#d4c5a9', confirmButtonText:'立即查看'
                });
            } else if (data.status === 'unlocked') {
                // 已经在倒计时中
                const unlockTime = new Date(data.last_checkin_at);
                const passedMins = (new Date() - unlockTime) / 60000;
                if (passedMins > 30) {
                    return Swal.fire({icon:'error', title:'已销毁', text:'遗物已随风而逝。', background:'#141414', color:'#6e2e2e'});
                }
                // 还可以看
            }

            raw = data.encrypted_data;
        }

        // 解密
        const result = decryptData(raw, sessionUser.email);
        
        if (result) {
            document.getElementById('de_output').innerText = result;
            document.getElementById('de_output').classList.remove('hidden');
            // 显示成功但不弹窗打断，因为可能有自毁警告
        } else {
            Swal.fire({icon:'error', title:'拒绝访问', text:'您的登录邮箱['+sessionUser.email+']与此遗物的指定继承人不符。', background:'#141414', color:'#6e2e2e'});
        }
    }

    function toggleSelfEmail() {
        const cb = document.getElementById('sameAsMe');
        const input = document.getElementById('u_warn_email');
        if (cb.checked && sessionUser) { input.value = sessionUser.email; input.readOnly = true; } 
        else { input.readOnly = false; }
    }

    ['u_timeout', 'u_max_warns', 'u_warn_interval'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => { isEditing = true; validateAndRender(); });
    });

    function validateAndRender() {
        const totalInput = document.getElementById('u_timeout');
        const countInput = document.getElementById('u_max_warns');
        const intervalInput = document.getElementById('u_warn_interval');
        const total = parseFloat(totalInput.value);
        const count = parseInt(countInput.value);
        const interval = parseFloat(intervalInput.value);
        const saveBtn = document.getElementById('saveBtn');
        const box = document.getElementById('timeline-box');
        const fill = document.getElementById('life-fill');
        const errorOverlay = document.getElementById('logic-error');
        const errorMsg = document.getElementById('logic-error-msg');
        
        [totalInput, countInput, intervalInput].forEach(el => el.classList.remove('error'));
        saveBtn.disabled = false; saveBtn.innerText = "封存遗物"; errorOverlay.style.display = 'none';

        if (!total || !count || !interval) {
            if (total || count || interval) { box.style.display = 'flex'; document.getElementById('empty-tip').style.display = 'block'; fill.style.display = 'none'; }
            else { box.style.display = 'none'; }
            return;
        }

        const span = count * interval;
        if (span >= total) {
            saveBtn.disabled = true; saveBtn.innerText = "无法封存";
            [totalInput, countInput, intervalInput].forEach(el => el.classList.add('error'));
            box.style.display = 'flex'; document.getElementById('empty-tip').style.display = 'none';
            errorOverlay.style.display = 'flex'; errorMsg.innerHTML = `唤醒跨度 ${span}分 > 存在时间 ${total}分`;
            return;
        }

        box.style.display = 'flex'; document.getElementById('empty-tip').style.display = 'none';
        document.getElementById('d-mark').style.display = 'block'; document.getElementById('d-lbl').style.display = 'block';
        fill.style.display = 'block';
        box.querySelectorAll('.trigger-line, .trigger-info').forEach(el => el.remove());

        if (isEditing) { fill.className = 'life-fill preview'; fill.style.width = '100%'; document.getElementById('real-left-time').innerText = "预览模式"; }

        for (let i = 1; i <= count; i++) {
            const minsLeft = i * interval;
            const posPercent = (minsLeft / total) * 100;
            const line = document.createElement('div'); line.className = 'trigger-line'; line.style.left = posPercent + '%'; box.appendChild(line);
            const info = document.createElement('div'); info.className = 'trigger-info'; info.style.left = posPercent + '%'; info.innerHTML = `唤-${count-i+1}<br>${minsLeft}m`; box.appendChild(info);
        }
    }

    document.getElementById('saveBtn').onclick = async () => {
        const secret = document.getElementById('u_secret').value;
        const benEmail = document.getElementById('u_ben').value;
        const total = parseFloat(document.getElementById('u_timeout').value);
        const count = parseInt(document.getElementById('u_max_warns').value);
        const interval = parseFloat(document.getElementById('u_warn_interval').value);

        if (!secret) return Swal.fire({icon:'warning', title:'空数据', text:'请填写遗言', background:'#141414', color:'#ccc'});
        if (!benEmail) return Swal.fire({icon:'warning', title:'缺失', text:'必须指定遗物接收邮箱', background:'#141414', color:'#ccc'});
        if (count * interval >= total) return Swal.fire({icon:'error', title:'悖论', text:'唤醒时间 > 总时长', background:'#141414', color:'#ccc'});

        const encrypted = encryptData(secret, benEmail);
        globalLastCheckin = new Date(); 
        const { error } = await client.from('vaults').upsert({
            id: sessionUser.id, encrypted_data: encrypted, beneficiary_email: benEmail,
            warning_email: document.getElementById('u_warn_email').value,
            timeout_minutes: total, max_warnings: count, warning_interval: interval,
            status: 'active', current_warnings: 0, last_checkin_at: globalLastCheckin
        });
        if (error) Swal.fire({icon:'error', title:'失败', text: translateError(error.message), background:'#141414', color:'#ccc'});
        else { Swal.fire({icon:'success', title:'已封存', text:'遗言已锁定。只有使用['+benEmail+']登录才能解开。', background:'#141414', color:'#d4c5a9'}); isEditing = false; validateAndRender(); startTimer(); }
    };

    document.getElementById('heartBtn').onclick = async () => {
        globalLastCheckin = new Date(); isEditing = false; validateAndRender(); startTimer();
        client.from('vaults').update({ last_checkin_at: new Date(), current_warnings: 0, status: 'active' }).eq('id', sessionUser.id);
        Swal.fire({icon:'success', title:'存续', text:'时间重置', background:'#141414', color:'#d4c5a9', timer:1000, showConfirmButton:false});
    };

    async function refreshData() {
        if (!sessionUser) return;
        document.getElementById('header-user-email').innerText = sessionUser.email;
        document.getElementById('current-user-email').innerText = sessionUser.email;
        const { data: v } = await client.from('vaults').select('*').eq('id', sessionUser.id).single();
        if (v) {
            globalLastCheckin = new Date(v.last_checkin_at);
            document.getElementById('u_timeout').value = v.timeout_minutes;
            document.getElementById('u_max_warns').value = v.max_warnings;
            document.getElementById('u_warn_interval').value = v.warning_interval;
            document.getElementById('u_warn_email').value = v.warning_email||'';
            document.getElementById('u_ben').value = v.beneficiary_email||'';
            if(v.warning_email===sessionUser.email) { document.getElementById('sameAsMe').checked=true; toggleSelfEmail(); }
            if(v.encrypted_data) { document.getElementById('u_secret').value=""; document.getElementById('u_secret').placeholder="（内容已加密封存）"; }
            isEditing = false; validateAndRender(); startTimer();
        }
    }

    document.getElementById('loginBtn').onclick = async () => {
        const { data, error } = await client.auth.signInWithPassword({ email: u_email.value, password: u_pw.value });
        if (error) return Swal.fire({icon:'error', title:'错误', text: '账号或密码错误', background:'#141414', color:'#ccc'});
        sessionUser = data.user;
        document.getElementById('auth-box').classList.add('hidden');
        document.getElementById('main-box').classList.remove('hidden');
        refreshData();
    };
    document.getElementById('regBtn').onclick = async () => {
        const { error } = await client.auth.signUp({ email: u_email.value, password: u_pw.value });
        if (error) Swal.fire({icon:'error', title:'失败', text: translateError(error.message), background:'#141414', color:'#ccc'});
        else Swal.fire({icon:'success', title:'成功', text:'已建档，请调取。', background:'#141414', color:'#d4c5a9'});
    };
    window.doLogout = async () => { await client.auth.signOut(); location.reload(); };
    function startTimer() { if (timerInterval) clearInterval(timerInterval); setInterval(() => { if (isEditing) return; const left = (parseFloat(document.getElementById('u_timeout').value)*60000)-(new Date()-globalLastCheckin); const el = document.getElementById('real-left-time'); const fill = document.getElementById('life-fill'); if (left<=0) { el.innerText="00:00:00 (已成遗物)"; el.className="dead"; fill.style.width="0%"; return; } const p = (left/(parseFloat(document.getElementById('u_timeout').value)*60000))*100; fill.style.width=p+"%"; fill.className = "life-fill"; el.innerText=Math.floor(left/60000)+":"+Math.floor((left%60000)/1000).toString().padStart(2,'0'); }, 1000); }
</script>
</body>
</html>
