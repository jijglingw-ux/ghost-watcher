<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—ç‰© | è‡ªåŠ¨é—å˜±ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* --- æç®€ç°ä»£é£æ ¼ (æ‰‹æœºä¼˜å…ˆ) --- */
        body { 
            background-color: #000000; 
            color: #eeeeee; 
            /* ä½¿ç”¨æ‰‹æœºç³»ç»Ÿé»˜è®¤å­—ä½“ï¼Œæœ€æ¸…æ™° */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            margin: 0; 
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .container { 
            width: 100%; 
            max-width: 480px; 
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* é¡¶éƒ¨ */
        header {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 20px;
            border-bottom: 1px solid #222;
        }
        h1 {
            margin: 0;
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 2px;
            color: #fff;
        }
        p.subtitle {
            margin: 8px 0 0 0;
            font-size: 13px;
            color: #666;
        }

        /* å¡ç‰‡æ¨¡å— */
        .card {
            background: #111;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #222;
        }

        /* æ ‡ç­¾ */
        label {
            display: block;
            margin-bottom: 8px;
            color: #888;
            font-size: 14px;
            font-weight: 500;
        }
        
        /* è¾“å…¥æ¡†ï¼šå¤§å­—å·ï¼Œé˜²è¯¯è§¦ */
        input, textarea { 
            width: 100%; 
            padding: 14px; 
            background: #1a1a1a; 
            border: 1px solid #333; 
            color: #fff; 
            box-sizing: border-box; 
            border-radius: 8px; 
            font-size: 16px; /* 16pxæ˜¯æ‰‹æœºæœ€ä½³å­—å· */
            outline: none; 
            transition: border 0.3s;
            -webkit-appearance: none;
            margin-bottom: 5px;
        }
        input:focus, textarea:focus { 
            border-color: #fff; 
        }
        textarea { resize: vertical; min-height: 120px; line-height: 1.5; }
        
        /* è§£é‡Šæ€§æ–‡å­— */
        .helper-text {
            font-size: 12px;
            color: #555;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        /* æŒ‰é’®ï¼šå¤§è‰²å— */
        button { 
            width: 100%; 
            padding: 16px; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600;
            cursor: pointer; 
            transition: opacity 0.2s;
            margin-top: 5px;
        }
        button:active { opacity: 0.8; }
        
        .btn-primary { background: #fff; color: #000; }
        .btn-outline { background: transparent; color: #888; border: 1px solid #333; }
        
        /* å¿ƒè·³æŒ‰é’®ï¼šç»¿è‰²é†’ç›® */
        .btn-heartbeat { 
            background: #10b981; 
            color: #fff; 
            font-size: 18px; 
            padding: 22px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .hidden { display: none; }
        
        /* ä¸‰åˆ—å¸ƒå±€ */
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 5px; }
        .grid-3 input { text-align: center; margin-bottom: 0; padding: 10px 5px; }
        .grid-3 div { display: flex; flex-direction: column; }
        .grid-3 label { font-size: 12px; text-align: center; margin-bottom: 5px; }

        /* å¤é€‰æ¡† */
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #888;
            font-size: 14px;
            padding: 5px 0;
        }
        .checkbox-row input { width: auto; margin: 0; }

        /* å€’è®¡æ—¶å±•ç¤ºåŒº */
        .status-box {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
            border: 1px solid #333;
        }
        .status-label { font-size: 13px; color: #666; margin-bottom: 8px; }
        .status-time { font-size: 28px; font-weight: bold; font-family: monospace; color: #fff; }
        .status-time.danger { color: #f59e0b; }
        .status-time.dead { color: #ef4444; }

        /* è¿›åº¦æ¡ */
        .progress-bg {
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #10b981;
            width: 0%;
            transition: width 1s linear;
        }

        /* åº•éƒ¨è§£å¯†åŒº */
        .decrypt-section {
            margin-top: 40px;
            border-top: 1px dashed #333;
            padding-top: 30px;
        }
        .decrypt-result {
            background: #0f1f15;
            padding: 15px;
            border-radius: 8px;
            color: #10b981;
            font-size: 15px;
            word-break: break-all;
            margin-top: 15px;
            border: 1px solid #10b981;
            line-height: 1.6;
        }

        /* å¼¹çª—æ ·å¼å¾®è°ƒ */
        .swal2-popup { background: #1a1a1a !important; color: #fff !important; border-radius: 12px !important; width: 85% !important; }
        .swal2-title { color: #fff !important; font-size: 18px !important; }
        .swal2-content { color: #aaa !important; }
        .swal2-confirm { background: #fff !important; color: #000 !important; border-radius: 8px !important; width: 100% !important; margin: 0 !important; }
        .swal2-actions { padding: 0 20px 20px 20px !important; width: 100% !important; box-sizing: border-box !important;}
    </style>
</head>
<body>

<div class="container">
    
    <header>
        <h1>é—ç‰©</h1>
        <p class="subtitle">æ•°å­—èµ„äº§è‡ªåŠ¨æ‰˜ç®¡ç³»ç»Ÿ</p>
    </header>

    <div id="auth-box">
        <div class="card">
            <label>è´¦å· (é‚®ç®±)</label>
            <input type="email" id="u_email" placeholder="name@example.com">
            
            <label>å¯†ç </label>
            <input type="password" id="u_pw" placeholder="è®¾ç½®ä¸€ä¸ªå¯†ç ">
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button id="loginBtn" class="btn-primary">ç™»å½• / æŸ¥çœ‹</button>
                <button id="regBtn" class="btn-outline">æ³¨å†Œæ–°è´¦å·</button>
            </div>
        </div>
    </div>

    <div id="main-box" class="hidden">
        
        <div class="card">
            <label>ğŸ“œ ä½ çš„é—è¨€ / ç§˜å¯†</label>
            <textarea id="u_secret" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ æƒ³ç•™ç»™æœªæ¥çš„è¯ã€‚å¯ä»¥æ˜¯é“¶è¡Œå¡å¯†ç ã€è™šæ‹Ÿå¸ç§é’¥ï¼Œæˆ–è€…å¯¹æŸäººæƒ³è¯´çš„è¯..."></textarea>
            <p class="helper-text">ğŸ”’ æ”¾å¿ƒå†™ï¼Œè¿™æ®µè¯ä¼šè¢«åŠ å¯†å­˜å‚¨ã€‚åªè¦ä½ æ´»ç€ï¼Œç³»ç»Ÿé‡Œæ²¡äººèƒ½çœ‹æ‡‚ã€‚</p>
        </div>

        <div class="card">
            <label>ğŸ“§ æ¥æ”¶äººè®¾ç½®</label>
            <div class="checkbox-row" onclick="toggleSelfEmail()">
                <input type="checkbox" id="sameAsMe"> <span>å…¨éƒ½å‘ç»™æˆ‘è‡ªå·±çš„é‚®ç®±</span>
            </div>
            
            <label>1. é¢„è­¦é‚®ç®± (æé†’ä½ æ‰“å¡)</label>
            <input type="email" id="u_warn_email" placeholder="ä¾‹: ä½ çš„å¸¸ç”¨é‚®ç®±">
            
            <label>2. å—ç›Šäººé‚®ç®± (æ¥æ”¶é—è¨€)</label>
            <input type="email" id="u_ben" placeholder="ä¾‹: äº²äººæˆ–å¥½å‹çš„é‚®ç®±">
            <p class="helper-text">âš ï¸ æ…é‡å¡«å†™ã€‚å½“ä½ å¤±è”åï¼Œé—è¨€å¯†æ–‡ä¼šå‘åˆ°è¿™ä¸ªé‚®ç®±ã€‚</p>
        </div>

        <div class="card">
            <label>â±ï¸ å¤±è”åˆ¤å®šè§„åˆ™</label>
            <p class="helper-text" style="margin-bottom: 10px;">å¦‚æœæˆ‘è¿ç»­ <strong>[æ€»æ—¶é•¿]</strong> æ²¡æœ‰æ¥è¿™é‡Œæ‰“å¡ï¼Œç³»ç»Ÿå°±è§†ä¸ºæˆ‘å·²å‘ç”Ÿæ„å¤–ã€‚</p>
            
            <div class="grid-3">
                <div>
                    <label>æ€»æ—¶é•¿(åˆ†)</label>
                    <input type="number" id="u_timeout" placeholder="60">
                </div>
                <div>
                    <label>æé†’æ¬¡æ•°</label>
                    <input type="number" id="u_max_warns" placeholder="3">
                </div>
                <div>
                    <label>é—´éš”(åˆ†)</label>
                    <input type="number" id="u_warn_interval" placeholder="5">
                </div>
            </div>
            <p class="helper-text">ä¾‹å¦‚ï¼šè®¾ç½®60åˆ†é’Ÿã€‚æ¯5åˆ†é’Ÿå‘é‚®ä»¶å‚¬æˆ‘ä¸€æ¬¡ï¼Œå‚¬3æ¬¡ã€‚60åˆ†é’Ÿåè‹¥æˆ‘è¿˜æ²¡æ¥ï¼Œè‡ªåŠ¨å‘é€é—è¨€å¹¶é”€æ¯è´¦å·ã€‚</p>
        </div>

        <div class="status-box">
            <div class="status-label">è·ç¦»å‘é€é—è¨€è¿˜å‰©</div>
            <div id="real-left-time" class="status-time">--:--:--</div>
            <div class="progress-bg">
                <div id="life-fill" class="progress-fill"></div>
            </div>
        </div>

        <button id="heartBtn" class="btn-heartbeat">æˆ‘æ˜¯å®‰å…¨çš„ (æ‰“å¡)</button>
        <button id="saveBtn" class="btn-outline" style="margin-top: 15px; border:none; color: #666; font-size: 14px;">æ›´æ–°è®¾ç½®å¹¶é‡ç½®æ—¶é—´</button>
    </div>

    <div class="decrypt-section">
        <h3 style="font-size: 16px; margin: 0 0 10px 0; color: #fff;">ğŸ› ï¸ é—è¨€è§£å¯†å·¥å…·</h3>
        <p class="helper-text">å¦‚æœä½ æ”¶åˆ°äº†â€œé—ç‰©â€é‚®ä»¶ï¼Œè¯·æŠŠé‚®ä»¶é‡Œçš„é‚£ä¸€é•¿ä¸²ã€å¯†æ–‡ã€‘å¤åˆ¶åˆ°ä¸‹é¢ï¼Œç‚¹å‡»è§£å¯†ã€‚</p>
        <textarea id="de_input" rows="3" placeholder="åœ¨è¿™é‡Œç²˜è´´é‚®ä»¶é‡Œçš„å¯†æ–‡..."></textarea>
        <button onclick="decryptInfo()" class="btn-outline" style="color: #10b981; border-color: #10b981;">ç‚¹å‡»è§£å¯†å†…å®¹</button>
        <div id="de_output" class="decrypt-result hidden"></div>
    </div>

</div>

<script>
    const DB_URL = 'https://uudlauufdnrdcztlesvr.supabase.co';
    const DB_KEY = 'sb_publishable_KtfqCfLqUd_AtLj0Nb2WKQ_aPbsHjus'; 
    const client = window.supabase.createClient(DB_URL, DB_KEY);
    let sessionUser = null;
    let globalLastCheckin = new Date();
    let isEditing = false;
    let timerInterval = null;

    // --- ç¿»è¯‘æŠ¥é”™ä¿¡æ¯ ---
    function translateError(msg) {
        if (!msg) return "æœªçŸ¥é”™è¯¯";
        if (msg.includes("User already registered")) return "è¿™ä¸ªé‚®ç®±å·²ç»æ³¨å†Œè¿‡äº†ï¼Œè¯·ç›´æ¥ç‚¹â€œç™»å½•â€ã€‚";
        if (msg.includes("Signup requires a valid password")) return "è¯·è®¾ç½®ä¸€ä¸ªæœ‰æ•ˆçš„å¯†ç ã€‚";
        if (msg.includes("Invalid login credentials")) return "è´¦å·æˆ–å¯†ç ä¸å¯¹ï¼Œè¯·é‡è¯•ã€‚";
        if (msg.includes("Password should be at least")) return "å¯†ç å¤ªçŸ­äº†ï¼Œè‡³å°‘è¦6ä½ã€‚";
        if (msg.includes("Email not confirmed")) return "è¯·å…ˆå»é‚®ç®±ç‚¹ä¸€ä¸‹ç¡®è®¤é“¾æ¥ã€‚";
        return "æç¤ºï¼š" + msg; 
    }

    // --- ç›‘å¬è¾“å…¥ ---
    ['u_timeout', 'u_max_warns', 'u_warn_interval'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
            isEditing = true; 
            updateTimeDisplay(); // å®æ—¶é¢„è§ˆ
        });
    });

    // --- å€’è®¡æ—¶é€»è¾‘ ---
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        updateTimeDisplay();
        timerInterval = setInterval(updateTimeDisplay, 1000);
    }

    function updateTimeDisplay() {
        if (isEditing) return;

        const totalInput = document.getElementById('u_timeout');
        if (!totalInput.value) return;

        const totalMinutes = parseFloat(totalInput.value);
        const now = new Date();
        const elapsedMs = now - globalLastCheckin;
        const totalMs = totalMinutes * 60 * 1000;
        const leftMs = totalMs - elapsedMs;

        const timeSpan = document.getElementById('real-left-time');
        const fill = document.getElementById('life-fill');

        if (leftMs <= 0) {
            timeSpan.innerText = "å·²é”€æ¯";
            timeSpan.className = "status-time dead";
            fill.style.width = "0%";
            return;
        }

        const h = Math.floor(leftMs / 3600000);
        const m = Math.floor((leftMs % 3600000) / 60000);
        const s = Math.floor((leftMs % 60000) / 1000);
        const str = `${h>0 ? h+':' : ''}${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        timeSpan.innerText = str;

        const percent = (leftMs / totalMs) * 100;
        fill.style.width = percent + "%";

        // é¢œè‰²å˜åŒ–
        if (percent < 20) {
            timeSpan.className = "status-time danger";
            fill.style.background = "#f59e0b";
        } else {
            timeSpan.className = "status-time";
            fill.style.background = "#10b981";
        }
    }

    // --- æŒ‰é’®æ“ä½œ ---
    document.getElementById('saveBtn').onclick = async () => {
        const total = parseFloat(document.getElementById('u_timeout').value);
        const count = parseInt(document.getElementById('u_max_warns').value);
        const interval = parseFloat(document.getElementById('u_warn_interval').value);
        
        // ç®€å•é€»è¾‘æ£€æŸ¥
        if (count * interval >= total) {
             Swal.fire({ icon: 'warning', title: 'è®¾ç½®ä¸åˆç†', text: 'â€œæé†’æ—¶é—´â€åŠ èµ·æ¥è¶…è¿‡äº†â€œæ€»æ—¶é•¿â€ï¼Œè¯·è°ƒæ•´ä¸€ä¸‹ã€‚', confirmButtonText: 'å¥½çš„' });
             return;
        }

        globalLastCheckin = new Date(); 
        const secret = document.getElementById('u_secret').value;
        const encrypted = secret ? "AES::" + btoa(encodeURIComponent(secret)) : "";
        
        const { error } = await client.from('vaults').upsert({
            id: sessionUser.id,
            encrypted_data: encrypted,
            beneficiary_email: document.getElementById('u_ben').value,
            warning_email: document.getElementById('u_warn_email').value,
            timeout_minutes: total,
            max_warnings: count,
            warning_interval: interval,
            status: 'active', 
            current_warnings: 0, 
            last_checkin_at: globalLastCheckin
        });

        if (error) {
            Swal.fire({ icon: 'error', title: 'ä¿å­˜å¤±è´¥', text: translateError(error.message), confirmButtonText: 'é‡è¯•' });
        } else {
            Swal.fire({ 
                icon: 'success', 
                title: 'è®¾ç½®å·²ä¿å­˜', 
                text: 'è®¡æ—¶å·²é‡ç½®ã€‚åªè¦ä½ åœ¨å€’è®¡æ—¶ç»“æŸå‰å›æ¥ç‚¹ä¸€ä¸‹â€œæ‰“å¡â€ï¼Œä¸€åˆ‡éƒ½å¾ˆå®‰å…¨ã€‚',
                confirmButtonText: 'æ˜ç™½äº†'
            });
            isEditing = false;
            startTimer(); 
        }
    };

    document.getElementById('heartBtn').onclick = async () => {
        globalLastCheckin = new Date(); 
        isEditing = false;
        startTimer();
        client.from('vaults').update({ last_checkin_at: new Date(), current_warnings: 0, status: 'active' }).eq('id', sessionUser.id);
        
        const Toast = Swal.mixin({
            toast: true, position: 'top', showConfirmButton: false, timer: 1500,
            background: '#fff', color: '#000', iconColor: '#10b981'
        });
        Toast.fire({ icon: 'success', title: 'æ‰“å¡æˆåŠŸï¼æ—¶é—´å·²é‡ç½®' });
    };

    // --- ç™»å½•/æ³¨å†Œ/åˆå§‹åŒ– ---
    async function refreshData() {
        if (!sessionUser) return;
        const { data: v } = await client.from('vaults').select('*').eq('id', sessionUser.id).single();
        if (v) {
            globalLastCheckin = new Date(v.last_checkin_at);
            document.getElementById('u_timeout').value = v.timeout_minutes;
            document.getElementById('u_max_warns').value = v.max_warnings;
            document.getElementById('u_warn_interval').value = v.warning_interval;
            document.getElementById('u_warn_email').value = v.warning_email || '';
            document.getElementById('u_ben').value = v.beneficiary_email || '';
            if (v.warning_email === sessionUser.email) {
                document.getElementById('sameAsMe').checked = true;
                toggleSelfEmail();
            }
            try { if(v.encrypted_data) document.getElementById('u_secret').value = decodeURIComponent(atob(v.encrypted_data.replace('AES::',''))); } catch(e){}
            
            isEditing = false;
            startTimer();
        }
    }

    document.getElementById('loginBtn').onclick = async () => {
        const { data, error } = await client.auth.signInWithPassword({ email: u_email.value, password: u_pw.value });
        if (error) return Swal.fire({ icon: 'error', title: 'ç™»å½•å¤±è´¥', text: translateError(error.message), confirmButtonText: 'ç¡®å®š' });
        
        sessionUser = data.user;
        document.getElementById('auth-box').classList.add('hidden');
        document.getElementById('main-box').classList.remove('hidden');
        refreshData();
    };
    
    document.getElementById('regBtn').onclick = async () => {
        const { error } = await client.auth.signUp({ email: u_email.value, password: u_pw.value });
        if (error) {
             Swal.fire({ icon: 'error', title: 'æ³¨å†Œå¤±è´¥', text: translateError(error.message), confirmButtonText: 'ç¡®å®š' });
        } else {
             Swal.fire({ icon: 'success', title: 'æ³¨å†ŒæˆåŠŸ', text: "è´¦å·å·²åˆ›å»ºï¼Œè¯·ç›´æ¥ç‚¹å‡»â€œç™»å½•â€ã€‚", confirmButtonText: 'å¥½' });
        }
    };

    function toggleSelfEmail() {
        const cb = document.getElementById('sameAsMe');
        const input = document.getElementById('u_warn_email');
        setTimeout(() => {
            if (cb.checked && sessionUser) { input.value = sessionUser.email; input.readOnly = true; input.style.opacity = 0.6; } 
            else { input.readOnly = false; input.style.opacity = 1; }
        }, 10);
    }
    
    window.decryptInfo = function() {
        try {
            const raw = document.getElementById('de_input').value.replace('AES::', '');
            document.getElementById('de_output').innerText = decodeURIComponent(atob(raw));
            document.getElementById('de_output').classList.remove('hidden');
        } catch(e) { 
            Swal.fire({ icon: 'error', title: 'è§£å¯†å¤±è´¥', text: 'è¿™ä¸æ˜¯æœ‰æ•ˆçš„å¯†æ–‡ï¼Œè¯·å¤åˆ¶å®Œæ•´ã€‚', confirmButtonText: 'ç¡®å®š' }); 
        }
    };
</script>
</body>
</html>
