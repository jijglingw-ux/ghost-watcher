<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>GhostProtocol V3.3 - æ•°å­—åŒ–èº«ç›‘è§†å™¨</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { background: #0d1117; color: #c9d1d9; font-family: monospace; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .box { width: 500px; background: #161b22; padding: 25px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px; }
        input, textarea { width: 100%; margin-bottom: 12px; padding: 10px; background: #010409; border: 1px solid #30363d; color: #fff; box-sizing: border-box; border-radius: 4px; }
        label { display: block; margin-bottom: 4px; color: #8b949e; font-size: 12px; }
        button { width: 100%; padding: 12px; background: #238636; color: white; cursor: pointer; font-weight: bold; border: none; border-radius: 6px; margin-top: 5px; }
        .secondary-btn { background: #30363d; margin-top: 10px; }
        .heart-btn { background: #d29922; color: #000; }
        .hidden { display: none; }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container { background: #010409; border-radius: 8px; padding: 15px; border: 1px solid #30363d; margin-bottom: 15px; }
        .progress-bar-bg { background: #30363d; height: 10px; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        #progress-fill { background: #2ea043; width: 0%; height: 100%; transition: width 0.5s; }
        .status-text { display: flex; justify-content: space-between; font-size: 13px; }
    </style>
</head>
<body>

<div class="box">
    <div id="auth-box">
        <h3>ğŸ” ç®¡ç†å‘˜ç™»å½•</h3>
        <input type="email" id="u_email" placeholder="æ‚¨çš„é‚®ç®±">
        <input type="password" id="u_pw" placeholder="æ‚¨çš„å¯†ç ">
        <button id="loginBtn">ç™»å½•ç»ˆç«¯</button>
        <button id="regBtn" class="secondary-btn">æ–°ç”¨æˆ·æ³¨å†Œ</button>
    </div>

    <div id="main-box" class="hidden">
        <div class="progress-container">
            <div class="status-text">
                <span>ğŸ›°ï¸ ç”Ÿå‘½çŠ¶æ€: <b id="status-val">ç›‘æµ‹ä¸­</b></span>
                <span id="warn-count-display">å”¤é†’è¿›åº¦: 0/0</span>
            </div>
            <div class="progress-bar-bg"><div id="progress-fill"></div></div>
            <div class="status-text">
                <span>è·ç¦»åˆ¤å®šæ­»äº¡è¿˜å‰©: <b id="countdown-val">--</b> åˆ†é’Ÿ</span>
            </div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <div style="flex:1;"><label>æ­»äº¡æ€»æ—¶é•¿(åˆ†)</label><input type="number" id="u_timeout" value="10"></div>
            <div style="flex:1;"><label>å”¤é†’æ¬¡æ•°</label><input type="number" id="u_max_warns" value="2"></div>
            <div style="flex:1;"><label>å”¤é†’é—´éš”(åˆ†)</label><input type="number" id="u_warn_interval" value="1"></div>
        </div>

        <label>é¢„è­¦é‚®ç®± & å—ç›Šäººé‚®ç®±:</label>
        <input type="email" id="u_warn_email" placeholder="æ‚¨çš„é¢„è­¦é‚®ç®±">
        <input type="email" id="u_ben" placeholder="å—ç›Šäººé‚®ç®±">

        <label>ğŸ”’ ç»å¯†é—è¨€:</label>
        <textarea id="u_secret" rows="4" placeholder="æ­¤å¤„å†…å®¹å°†è¢«åŠ å¯†å­˜å‚¨..."></textarea>

        <button id="saveBtn">ğŸ’¾ æ›´æ–°é…ç½®å¹¶åŒæ­¥äº‘ç«¯</button>
        <button id="heartBtn" class="heart-btn">ğŸ’“ å‘é€å¿ƒè·³ (é‡ç½®å€’è®¡æ—¶)</button>
    </div>
</div>

<div class="box">
    <h3>ğŸ”“ å…¬å…±è§£å¯†å·¥å…· (å—ç›Šäººä¸“ç”¨)</h3>
    <label>è¾“å…¥æ¥æ”¶åˆ°çš„åŠ å¯†å­—ç¬¦ä¸² (AES::...):</label>
    <textarea id="de_input" rows="3" placeholder="åœ¨æ­¤ç²˜è´´é—è¨€é‚®ä»¶ä¸­çš„åŠ å¯†å†…å®¹..."></textarea>
    <button onclick="decryptInfo()" style="background:#1f6feb">ç‚¹å‡»è§£å¯†ä¿¡æ¯</button>
    <div id="de_output" style="margin-top:10px; color:#fff; word-break:break-all; padding:10px; background:#010409; border-radius:4px;" class="hidden"></div>
</div>

<script>
    const DB_URL = 'https://uudlauufdnrdcztlesvr.supabase.co';
    const DB_KEY = 'sb_publishable_KtfqCfLqUd_AtLj0Nb2WKQ_aPbsHjus'; 
    const client = window.supabase.createClient(DB_URL, DB_KEY);
    let sessionUser = null;

    function decryptInfo() {
        const input = document.getElementById('de_input').value;
        const outputDiv = document.getElementById('de_output');
        try {
            const raw = input.replace('AES::', '');
            const decoded = decodeURIComponent(atob(raw));
            outputDiv.innerText = "è§£å¯†ç»“æœ: " + decoded;
            outputDiv.classList.remove('hidden');
        } catch(e) { alert("è§£å¯†å¤±è´¥ï¼šæ— æ•ˆæ ¼å¼"); }
    }

    document.getElementById('regBtn').onclick = async () => {
        const { error } = await client.auth.signUp({ email: u_email.value, password: u_pw.value });
        alert(error ? error.message : "æ³¨å†ŒæˆåŠŸï¼è¯·ç›´æ¥ç‚¹å‡»ç™»å½•ã€‚");
    };

    document.getElementById('loginBtn').onclick = async () => {
        const { data, error } = await client.auth.signInWithPassword({ email: u_email.value, password: u_pw.value });
        if (error) return alert(error.message);
        sessionUser = data.user;
        showMain();
    };

    async function showMain() {
        document.getElementById('auth-box').classList.add('hidden');
        document.getElementById('main-box').classList.remove('hidden');
        document.getElementById('user-tag').innerText = sessionUser.email;
        await refreshData();
    }

    // å°è£…æ•°æ®è¯»å–åŠŸèƒ½ï¼Œæ–¹ä¾¿å¤šæ¬¡è°ƒç”¨è€Œä¸åˆ·æ–°é¡µé¢
    async function refreshData() {
        const { data: v } = await client.from('vaults').select('*').eq('id', sessionUser.id).single();
        if (v) {
            document.getElementById('u_timeout').value = v.timeout_minutes || 10;
            document.getElementById('u_max_warns').value = v.max_warnings || 2;
            document.getElementById('u_warn_interval').value = v.warning_interval || 1;
            document.getElementById('u_warn_email').value = v.warning_email || '';
            document.getElementById('u_ben').value = v.beneficiary_email || '';
            try { u_secret.value = decodeURIComponent(atob(v.encrypted_data.replace('AES::',''))); } catch(e){}
            updateUI(v);
        }
    }

    function updateUI(v) {
        const last = new Date(v.last_checkin_at);
        const diff = (new Date() - last) / 60000;
        const deadline = v.timeout_minutes;
        const remain = Math.max(0, (deadline - diff).toFixed(1));
        
        document.getElementById('countdown-val').innerText = remain;
        document.getElementById('warn-count-display').innerText = `å”¤é†’è¿›åº¦: ${v.current_warnings}/${v.max_warnings}`;
        
        let percent = (diff / deadline) * 100;
        if (percent > 100) percent = 100;
        const fill = document.getElementById('progress-fill');
        fill.style.width = percent + "%";
        
        if (v.status === 'triggered') {
            document.getElementById('status-val').innerText = "å·²åˆ¤å®šä½æ­»äº¡";
            fill.style.background = "#f85149";
        } else {
            document.getElementById('status-val').innerText = "ç›‘æµ‹ä¸­";
            fill.style.background = percent > 80 ? "#d29922" : "#2ea043";
        }
    }

    document.getElementById('saveBtn').onclick = async () => {
        const encrypted = "AES::" + btoa(encodeURIComponent(u_secret.value));
        const { error } = await client.from('vaults').upsert({
            id: sessionUser.id,
            encrypted_data: encrypted,
            beneficiary_email: u_ben.value,
            warning_email: u_warn_email.value,
            timeout_minutes: parseInt(u_timeout.value),
            max_warnings: parseInt(u_max_warns.value),
            warning_interval: parseInt(u_warn_interval.value),
            status: 'active', current_warnings: 0, last_checkin_at: new Date()
        });
        if (!error) {
            alert("âœ… é…ç½®å·²åŒæ­¥ï¼Œå€’è®¡æ—¶å·²é‡ç½®ï¼");
            await refreshData(); // ä»…åˆ·æ–°æ•°æ®ï¼Œä¸åˆ·æ–°é¡µé¢
        }
    };

    document.getElementById('heartBtn').onclick = async () => {
        const { error } = await client.from('vaults').update({ 
            last_checkin_at: new Date(), current_warnings: 0, status: 'active' 
        }).eq('id', sessionUser.id);
        if (!error) {
            alert("ğŸ’“ å¿ƒè·³å·²è·³åŠ¨ï¼Œç”Ÿå‘½å€¼å·²å›æ»¡ï¼");
            await refreshData(); // ä»…åˆ·æ–°æ•°æ®ï¼Œä¸åˆ·æ–°é¡µé¢
        }
    };
</script>
</body>
</html>